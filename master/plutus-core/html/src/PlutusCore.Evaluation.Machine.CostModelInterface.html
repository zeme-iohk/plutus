<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- editorconfig-checker-disable-file</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass    #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase        #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards   #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">PlutusCore.Evaluation.Machine.CostModelInterface</span><span>
</span><span id="line-8"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelParams"><span class="hs-identifier">CostModelParams</span></a></span><span>
</span><span id="line-9"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#CekMachineCosts"><span class="hs-identifier">CekMachineCosts</span></a></span><span>
</span><span id="line-10"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#extractCostModelParams"><span class="hs-identifier">extractCostModelParams</span></a></span><span>
</span><span id="line-11"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#applyCostModelParams"><span class="hs-identifier">applyCostModelParams</span></a></span><span>
</span><span id="line-12"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelApplyError"><span class="hs-identifier">CostModelApplyError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelApplyWarn"><span class="hs-identifier">CostModelApplyWarn</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">where</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.BuiltinCostModel.html"><span class="hs-identifier">PlutusCore.Evaluation.Machine.BuiltinCostModel</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.MachineParameters.html"><span class="hs-identifier">PlutusCore.Evaluation.Machine.MachineParameters</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Evaluation.Machine.MachineParameters.html#CostModel"><span class="hs-identifier">CostModel</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html"><span class="hs-identifier">UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#CekMachineCosts"><span class="hs-identifier">CekMachineCosts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#cekMachineCostsPrefix"><span class="hs-identifier">cekMachineCostsPrefix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">Control.Exception</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../mtl/html/src"><span class="hs-identifier">Control.Monad.Except</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier">Data.Aeson</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Aeson.Flatten.html"><span class="hs-identifier">Data.Aeson.Flatten</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../unordered-containers/html/src"><span class="hs-identifier">Data.HashMap.Strict</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HM</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier">Data.Map.Merge.Lazy</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier">Data.Text</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Text</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../prettyprinter/html/src"><span class="hs-identifier">Prettyprinter</span></a></span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="hs-comment">{- Note [Cost model parameters]
We want to expose to the ledger some notion of the &quot;cost model
parameters&quot;. Intuitively, these should be all the numbers that appear in the
cost model.

However, there are quite a few quirks to deal with.

1. BuiltinCostModel is stuctured.

That is, it's a complex data structure and the numbers in question are often
nested inside it.  To deal with this quickly, we take the ugly approach of
operating on the JSON representation of the model.  We flatten this down into a
simple key-value mapping (see 'flattenObject' and 'unflattenObject'), and then
look only at the numbers.

2. We use CostingIntegers, Aeson uses Data.Scientific.

The numbers in CostModel objects are CostingIntegers, which are usually the
64-bit SatInt type (but Integer on 32-bit machines).  Numerical values in
Aeson-encoded JSON objects are represented as Data.Scientific (Integer mantissa,
Int exponent). We should be able to convert between these types without loss of
precision, except that Scientific numbers of large magnitude will overflow to
SatInt::MaxBound or underflow to SatInt::MinBound.  This is OK because
CostModelParams objects should never contain such large numbers. Any Plutus Core
programs whose cost reaches MaxBound will fail due to excessive resource usage.

3. BuiltinCostModel includes the *type* of the model, which isn't a parameter

We can just strip the type out, but in particular this means that the parameters are
not enough to *construct* a model.  So we punt and say that you can *update* a
model by giving the parameters. So you can take the default model and then
overwrite the parameters, which seems okay.

This is also implemented in a horrible JSON-y way.

4. The implementation is not nice.

Ugly JSON stuff and failure possibilities where there probably shouldn't be any.

5. The overall cost model now includes two components: a model for the internal
costs of the evaluator and a model for built-in evaluation costs.  We just
re-use the technique mentioned above to extract parameters for the evaluator
costs, merging these with the parameters for the builtin cost model to obtain
parameters for the overall model.  To recover cost model components we assume
that every field in the cost model for the evaluator begins with a prefix (eg
&quot;cek&quot;) which is does not occur as a prefix of any built-in function, and use
that to split the map of parameters into two maps.

-}</span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span class="hs-comment">{- Note [Cost model parameters from the ledger's point of view]

A newly-voted protocol update may have some of the following effects:

a) Introduce a new plutus-language version accompanied by a whole new set of cost model parameters for that new version.
b) Update any values of existing cost model parameters for an existing plutus version.
c) Bring new builtins to an existing plutus version, thus also extending
the set of current cost model parameters of that version with new parameters for the new builtins.

Note that, removing existing builtins is only possible by issuing a brand-new plutus language version
that would exclude them (and their cost model parameters).
An alternative without issuing a new protocol update and affecting a current version,
would be to set via (b) the builtins' cost model parameters prohibitively high,
so as to make those builtins impossible to execute given the current maximum transaction budget,
thus effectively disabling their execution.

The ledger-state stores a *mapping* of each plutus-language version to its current set of cost model parameters.
Each set of parameters is represented as an *array of plain integer values*,
without the  cost model parameter names. Overall this ledger-state can be conceptualized as `Map PlutusVersion [Integer]`.

The implementation of (a) and (b) effects by the node software is straightforward:
for (a) introduce a whole new entry to the Map; for (b) update the affected array in-place with the new values.
As a consequence for implementing (c), we arrive to four restrictions that hold for ALL protocol updates:

1) In case of (b), the values of the existing parameters may change, but their *meaning*,
i.e. which parameter name and thus which builtin parameter they correspond to,  ABSOLUTELY CANNOT change. In other words,
the existing parameters cannot be re-ordered.

2) In case of (c) the new parameters (for the new builtins) must be appended **to the end** of the existing array for the affected version.

3) The node software is responsible to re-create the plutus runtimes when a new protocol is voted in ---
one plutus runtime a.k.a. `plutus-ledger-api.EvaluationContext` per plutus-version.

4) The node software will always pass the array in its entirety to each plutus-runtime,
and not partially just the updated-parameter values (in case of (b)) or just the new-parameter values (in case of (c)).

There is one complication when (c) happens and some running nodes are not updated:
these nodes are only aware of the old set of builtins, thus they expect a specific (fixed in software)
number of cost model parameters.
To guarantee smooth,continuous operation of the entire network (and not cause any splits)
we allow the old nodes to continue operating when receiving more cost model parameters
than they expected, and only issue a warning to them. When the nodes restart and update to the new node software
these warnings will go away. The overall logic for the expected number of cost model paremeters is as follows:

(expected number in node software == received number by ledger) =&gt; NOWARNING &amp; NOERROR
(expected number in node software &lt; received number by ledger)  =&gt; WARNING
(expected number in node software &gt; received number by ledger)  =&gt; ERROR

If the received number is EQ or GT the expected (WARNING), the plutus software
will take the first n from the received cost model parameters (n==expected number),
and create the internal (nameful) representation of cost model parameters, by assigning a parameter name
to its value: see `PlutusLedgerApi.Common.ParamName.tagWithParamNames` and the `ParamName` datatypes in
plutus-ledger-api.

-}</span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span class="hs-comment">{-| A raw representation of the ledger's cost model parameters.

The associated keys/names to the parameter values are arbitrarily set by the plutus team; the ledger does not hold any such names.

See Note [Cost model parameters]
-}</span><span>
</span><span id="line-144"></span><span class="hs-keyword">type</span><span> </span><span id="CostModelParams"><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelParams"><span class="hs-identifier hs-var">CostModelParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../containers/html/src"><span class="hs-identifier hs-type">Map.Map</span></a></span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier hs-type">Text.Text</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-bignum-1.2/src"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="hs-comment">-- See Note [Cost model parameters]</span><span>
</span><span id="line-147"></span><span class="hs-comment">-- | Extract the model parameters from a model.</span><span>
</span><span id="line-148"></span><span id="local-6989586621680895637"><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#extractParams"><span class="hs-identifier hs-type">extractParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">ToJSON</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895637"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680895637"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelParams"><span class="hs-identifier hs-type">CostModelParams</span></a></span></span><span>
</span><span id="line-149"></span><span id="extractParams"><span class="annot"><span class="annottext">extractParams :: forall a. ToJSON a =&gt; a -&gt; Maybe CostModelParams
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#extractParams"><span class="hs-identifier hs-var hs-var">extractParams</span></a></span></span><span> </span><span id="local-6989586621680895493"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680895493"><span class="hs-identifier hs-var">cm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="../../../../aeson/html/src"><span class="hs-identifier hs-var">toJSON</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680895493"><span class="hs-identifier hs-var">cm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-150"></span><span>    </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">Object</span></a></span><span> </span><span id="local-6989586621680895490"><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621680895490"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-151"></span><span>        </span><span class="hs-keyword">let</span><span>
</span><span id="line-152"></span><span>            </span><span id="local-6989586621680895487"><span class="annot"><span class="annottext">flattened :: HashMap Text Value
</span><a href="#local-6989586621680895487"><span class="hs-identifier hs-var hs-var">flattened</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Object -&gt; HashMap Text Value
</span><a href="Data.Aeson.Flatten.html#objToHm"><span class="hs-identifier hs-var">objToHm</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Object -&gt; Object
</span><a href="Data.Aeson.Flatten.html#flattenObject"><span class="hs-identifier hs-var">flattenObject</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;-&quot;</span></span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621680895490"><span class="hs-identifier hs-var">o</span></a></span><span>
</span><span id="line-153"></span><span>            </span><span id="local-6989586621680895480"><span class="annot"><span class="annottext">usingCostingIntegers :: HashMap Text Integer
</span><a href="#local-6989586621680895480"><span class="hs-identifier hs-var hs-var">usingCostingIntegers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall v1 v2 k. (v1 -&gt; Maybe v2) -&gt; HashMap k v1 -&gt; HashMap k v2
</span><a href="../../../../unordered-containers/html/src"><span class="hs-identifier hs-var">HM.mapMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">Number</span></a></span><span> </span><span id="local-6989586621680895477"><span class="annot"><span class="annottext">Scientific
</span><a href="#local-6989586621680895477"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (RealFrac a, Integral b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">ceiling</span></a></span><span> </span><span class="annot"><span class="annottext">Scientific
</span><a href="#local-6989586621680895477"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Value
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashMap Text Value
</span><a href="#local-6989586621680895487"><span class="hs-identifier hs-var">flattened</span></a></span><span>
</span><span id="line-154"></span><span>            </span><span class="hs-comment">-- ^ Only (the contents of) the &quot;Just&quot; values are retained in the output map.</span><span>
</span><span id="line-155"></span><span>            </span><span id="local-6989586621680895473"><span class="annot"><span class="annottext">mapified :: CostModelParams
</span><a href="#local-6989586621680895473"><span class="hs-identifier hs-var hs-var">mapified</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall k v. HashMap k v -&gt; [(k, v)]
</span><a href="../../../../unordered-containers/html/src"><span class="hs-identifier hs-var">HM.toList</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap Text Integer
</span><a href="#local-6989586621680895480"><span class="hs-identifier hs-var">usingCostingIntegers</span></a></span><span>
</span><span id="line-156"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">CostModelParams
</span><a href="#local-6989586621680895473"><span class="hs-identifier hs-var">mapified</span></a></span><span>
</span><span id="line-157"></span><span>    </span><span class="annot"><span class="annottext">Value
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span class="hs-comment">-- | A fatal error when trying to create a cost given some plain costmodel parameters.</span><span>
</span><span id="line-161"></span><span class="hs-keyword">data</span><span> </span><span id="CostModelApplyError"><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelApplyError"><span class="hs-identifier hs-var">CostModelApplyError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-162"></span><span>      </span><span id="CMUnknownParamError"><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CMUnknownParamError"><span class="hs-identifier hs-var">CMUnknownParamError</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier hs-type">Text.Text</span></a></span><span>
</span><span id="line-163"></span><span>      </span><span class="hs-comment">-- ^ a costmodel parameter with the give name does not exist in the costmodel to be applied upon</span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="CMInternalReadError"><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CMInternalReadError"><span class="hs-identifier hs-var">CMInternalReadError</span></a></span></span><span>
</span><span id="line-165"></span><span>      </span><span class="hs-comment">-- ^ internal error when we are transforming the applyParams' input to json (should not happen)</span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="CMInternalWriteError"><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CMInternalWriteError"><span class="hs-identifier hs-var">CMInternalWriteError</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">String</span></a></span><span>
</span><span id="line-167"></span><span>      </span><span class="hs-comment">-- ^ internal error when we are transforming the applied params from json with given jsonstring error (should not happen)</span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="CMTooFewParamsError"><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CMTooFewParamsError"><span class="hs-identifier hs-var">CMTooFewParamsError</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="cmTooFewExpected"><span class="annot"><span class="annottext">CostModelApplyError -&gt; Int
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#cmTooFewExpected"><span class="hs-identifier hs-var hs-var">cmTooFewExpected</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">,</span><span> </span><span id="cmTooFewActual"><span class="annot"><span class="annottext">CostModelApplyError -&gt; Int
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#cmTooFewActual"><span class="hs-identifier hs-var hs-var">cmTooFewActual</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-169"></span><span>      </span><span class="hs-comment">-- ^ See Note [Cost model parameters from the ledger's point of view]</span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span id="local-6989586621680895447"><span id="local-6989586621680895449"><span id="local-6989586621680895463"><span class="annot"><span class="annottext">Int -&gt; CostModelApplyError -&gt; ShowS
[CostModelApplyError] -&gt; ShowS
CostModelApplyError -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [CostModelApplyError] -&gt; ShowS
$cshowList :: [CostModelApplyError] -&gt; ShowS
show :: CostModelApplyError -&gt; String
$cshow :: CostModelApplyError -&gt; String
showsPrec :: Int -&gt; CostModelApplyError -&gt; ShowS
$cshowsPrec :: Int -&gt; CostModelApplyError -&gt; ShowS
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span id="local-6989586621680895435"><span id="local-6989586621680895437"><span id="local-6989586621680895439"><span class="annot"><span class="annottext">Show CostModelApplyError
Typeable CostModelApplyError
SomeException -&gt; Maybe CostModelApplyError
CostModelApplyError -&gt; String
CostModelApplyError -&gt; SomeException
forall e.
Typeable e
-&gt; Show e
-&gt; (e -&gt; SomeException)
-&gt; (SomeException -&gt; Maybe e)
-&gt; (e -&gt; String)
-&gt; Exception e
displayException :: CostModelApplyError -&gt; String
$cdisplayException :: CostModelApplyError -&gt; String
fromException :: SomeException -&gt; Maybe CostModelApplyError
$cfromException :: SomeException -&gt; Maybe CostModelApplyError
toException :: CostModelApplyError -&gt; SomeException
$ctoException :: CostModelApplyError -&gt; SomeException
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Exception</span></a></span></span></span></span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span class="hs-comment">-- | A non-fatal warning when trying to create a cost given some plain costmodel parameters.</span><span>
</span><span id="line-174"></span><span class="hs-keyword">data</span><span> </span><span id="CostModelApplyWarn"><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelApplyWarn"><span class="hs-identifier hs-var">CostModelApplyWarn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-175"></span><span>    </span><span id="CMTooManyParamsWarn"><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CMTooManyParamsWarn"><span class="hs-identifier hs-var">CMTooManyParamsWarn</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="cmTooManyExpected"><span class="annot"><span class="annottext">CostModelApplyWarn -&gt; Int
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#cmTooManyExpected"><span class="hs-identifier hs-var hs-var">cmTooManyExpected</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">,</span><span> </span><span id="cmTooManyActual"><span class="annot"><span class="annottext">CostModelApplyWarn -&gt; Int
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#cmTooManyActual"><span class="hs-identifier hs-var hs-var">cmTooManyActual</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-comment">{- ^ More costmodel parameters given, than expected

    See Note [Cost model parameters from the ledger's point of view]
    -}</span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680895428"><span class="annot"><a href="../../../../prettyprinter/html/src"><span class="hs-identifier hs-type">Pretty</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelApplyError"><span class="hs-identifier hs-type">CostModelApplyError</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-182"></span><span>    </span><span id="local-6989586621680895411"><span class="annot"><span class="annottext">pretty :: forall ann. CostModelApplyError -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">pretty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Doc ann
</span><a href="#local-6989586621680895409"><span class="hs-identifier hs-var">preamble</span></a></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-183"></span><span>        </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CMUnknownParamError"><span class="hs-identifier hs-type">CMUnknownParamError</span></a></span><span> </span><span id="local-6989586621680895406"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680895406"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;Unknown cost model parameter:&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a ann. Pretty a =&gt; a -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680895406"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-184"></span><span>        </span><span class="annot"><span class="annottext">CostModelApplyError
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CMInternalReadError"><span class="hs-identifier hs-var">CMInternalReadError</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;Internal problem occurred upon reading the given cost model parameteres&quot;</span></span><span>
</span><span id="line-185"></span><span>        </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CMInternalWriteError"><span class="hs-identifier hs-type">CMInternalWriteError</span></a></span><span> </span><span id="local-6989586621680895405"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680895405"><span class="hs-identifier hs-var">str</span></a></span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;Internal problem occurred upon generating the applied cost model parameters with JSON error:&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a ann. Pretty a =&gt; a -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680895405"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-186"></span><span>        </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CMTooFewParamsError"><span class="hs-identifier hs-type">CMTooFewParamsError</span></a></span><span class="hs-special">{</span><span id="local-6989586621680895403"><span id="local-6989586621680895404"><span class="annot"><span class="annottext">Int
cmTooFewActual :: Int
cmTooFewExpected :: Int
cmTooFewActual :: CostModelApplyError -&gt; Int
cmTooFewExpected :: CostModelApplyError -&gt; Int
</span><a href="#local-6989586621680895403"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;Too few cost model parameters passed, expected&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a ann. Pretty a =&gt; a -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680895404"><span class="hs-identifier hs-var">cmTooFewExpected</span></a></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;but got&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a ann. Pretty a =&gt; a -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680895403"><span class="hs-identifier hs-var">cmTooFewActual</span></a></span><span>
</span><span id="line-187"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-188"></span><span>          </span><span id="local-6989586621680895409"><span class="annot"><span class="annottext">preamble :: Doc ann
</span><a href="#local-6989586621680895409"><span class="hs-identifier hs-var hs-var">preamble</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;applyParams error:&quot;</span></span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680895399"><span class="annot"><a href="../../../../prettyprinter/html/src"><span class="hs-identifier hs-type">Pretty</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelApplyWarn"><span class="hs-identifier hs-type">CostModelApplyWarn</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-191"></span><span>    </span><span id="local-6989586621680895394"><span class="annot"><span class="annottext">pretty :: forall ann. CostModelApplyWarn -&gt; Doc ann
</span><a href="#local-6989586621680895394"><span class="hs-identifier hs-var hs-var hs-var hs-var">pretty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Doc ann
</span><a href="#local-6989586621680895393"><span class="hs-identifier hs-var">preamble</span></a></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-192"></span><span>        </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CMTooManyParamsWarn"><span class="hs-identifier hs-type">CMTooManyParamsWarn</span></a></span><span class="hs-special">{</span><span id="local-6989586621680895391"><span id="local-6989586621680895392"><span class="annot"><span class="annottext">Int
cmTooManyActual :: Int
cmTooManyExpected :: Int
cmTooManyActual :: CostModelApplyWarn -&gt; Int
cmTooManyExpected :: CostModelApplyWarn -&gt; Int
</span><a href="#local-6989586621680895391"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;Too many cost model parameters passed, expected&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a ann. Pretty a =&gt; a -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680895392"><span class="hs-identifier hs-var">cmTooManyExpected</span></a></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;but got&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a ann. Pretty a =&gt; a -&gt; Doc ann
</span><a href="../../../../prettyprinter/html/src"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680895391"><span class="hs-identifier hs-var">cmTooManyActual</span></a></span><span>
</span><span id="line-193"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-194"></span><span>          </span><span id="local-6989586621680895393"><span class="annot"><span class="annottext">preamble :: Doc ann
</span><a href="#local-6989586621680895393"><span class="hs-identifier hs-var hs-var">preamble</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;applyParams warn:&quot;</span></span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span class="hs-comment">-- See Note [Cost model parameters]</span><span>
</span><span id="line-197"></span><span class="hs-comment">-- | Update a model by overwriting the parameters with the given ones.</span><span>
</span><span id="line-198"></span><span id="local-6989586621680895593"><span id="local-6989586621680895595"><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#applyParams"><span class="hs-identifier hs-type">applyParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">FromJSON</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895595"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">ToJSON</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895595"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../mtl/html/src"><span class="hs-identifier hs-type">MonadError</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelApplyError"><span class="hs-identifier hs-type">CostModelApplyError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895593"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680895595"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-200"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelParams"><span class="hs-identifier hs-type">CostModelParams</span></a></span><span>
</span><span id="line-201"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680895593"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895595"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-202"></span><span id="applyParams"><span class="annot"><span class="annottext">applyParams :: forall a (m :: * -&gt; *).
(FromJSON a, ToJSON a, MonadError CostModelApplyError m) =&gt;
a -&gt; CostModelParams -&gt; m a
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#applyParams"><span class="hs-identifier hs-var hs-var">applyParams</span></a></span></span><span> </span><span id="local-6989586621680895371"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680895371"><span class="hs-identifier hs-var">cm</span></a></span></span><span> </span><span id="local-6989586621680895370"><span class="annot"><span class="annottext">CostModelParams
</span><a href="#local-6989586621680895370"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; Value
</span><a href="../../../../aeson/html/src"><span class="hs-identifier hs-var">toJSON</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680895371"><span class="hs-identifier hs-var">cm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-203"></span><span>    </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">Object</span></a></span><span> </span><span id="local-6989586621680895369"><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621680895369"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-204"></span><span>        </span><span class="hs-keyword">let</span><span>
</span><span id="line-205"></span><span>            </span><span id="local-6989586621680895363"><span class="annot"><span class="annottext">usingScientific :: Map Text Value
</span><a href="#local-6989586621680895363"><span class="hs-identifier hs-var hs-var">usingScientific</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scientific -&gt; Value
</span><a href="../../../../aeson/html/src"><span class="hs-identifier hs-var">Number</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CostModelParams
</span><a href="#local-6989586621680895370"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-206"></span><span>            </span><span id="local-6989586621680895361"><span class="annot"><span class="annottext">flattened :: Map Text Value
</span><a href="#local-6989586621680895361"><span class="hs-identifier hs-var hs-var">flattened</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {a}. HashMap Text a -&gt; Map Text a
</span><a href="#local-6989586621680895360"><span class="hs-identifier hs-var">fromHash</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Object -&gt; HashMap Text Value
</span><a href="Data.Aeson.Flatten.html#objToHm"><span class="hs-identifier hs-var">objToHm</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Object -&gt; Object
</span><a href="Data.Aeson.Flatten.html#flattenObject"><span class="hs-identifier hs-var">flattenObject</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;-&quot;</span></span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621680895369"><span class="hs-identifier hs-var">o</span></a></span><span>
</span><span id="line-207"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-208"></span><span>            </span><span class="hs-comment">-- this is where the overwriting happens</span><span>
</span><span id="line-209"></span><span>            </span><span class="hs-comment">-- fail when key is in params (left) but not in the model (right)</span><span>
</span><span id="line-210"></span><span>            </span><span id="local-6989586621680895359"><span class="annot"><span class="annottext">Map Text Value
</span><a href="#local-6989586621680895359"><span class="hs-identifier hs-var">merged</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) k a c b.
(Applicative f, Ord k) =&gt;
WhenMissing f k a c
-&gt; WhenMissing f k b c
-&gt; WhenMatched f k a b c
-&gt; Map k a
-&gt; Map k b
-&gt; f (Map k c)
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.mergeA</span></a></span><span> </span><span class="annot"><span class="annottext">forall {x} {y}. WhenMissing m Text x y
</span><a href="#local-6989586621680895357"><span class="hs-identifier hs-var">failMissing</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) k x. Applicative f =&gt; WhenMissing f k x x
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.preserveMissing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) k x y z.
Applicative f =&gt;
(k -&gt; x -&gt; y -&gt; z) -&gt; WhenMatched f k x y z
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.zipWithMatched</span></a></span><span> </span><span class="annot"><span class="annottext">forall {p} {p} {p}. p -&gt; p -&gt; p -&gt; p
</span><a href="#local-6989586621680895354"><span class="hs-identifier hs-var">leftBiased</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Text Value
</span><a href="#local-6989586621680895363"><span class="hs-identifier hs-var">usingScientific</span></a></span><span> </span><span class="annot"><span class="annottext">Map Text Value
</span><a href="#local-6989586621680895361"><span class="hs-identifier hs-var">flattened</span></a></span><span>
</span><span id="line-211"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680895352"><span class="annot"><span class="annottext">unflattened :: Object
</span><a href="#local-6989586621680895352"><span class="hs-identifier hs-var hs-var">unflattened</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Object -&gt; Object
</span><a href="Data.Aeson.Flatten.html#unflattenObject"><span class="hs-identifier hs-var">unflattenObject</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;-&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap Text Value -&gt; Object
</span><a href="Data.Aeson.Flatten.html#hmToObj"><span class="hs-identifier hs-var">hmToObj</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall {v}. Map Text v -&gt; HashMap Text v
</span><a href="#local-6989586621680895349"><span class="hs-identifier hs-var">toHash</span></a></span><span> </span><span class="annot"><span class="annottext">Map Text Value
</span><a href="#local-6989586621680895359"><span class="hs-identifier hs-var">merged</span></a></span><span>
</span><span id="line-212"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. FromJSON a =&gt; Value -&gt; Result a
</span><a href="../../../../aeson/html/src"><span class="hs-identifier hs-var">fromJSON</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Object -&gt; Value
</span><a href="../../../../aeson/html/src"><span class="hs-identifier hs-var">Object</span></a></span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621680895352"><span class="hs-identifier hs-var">unflattened</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-213"></span><span>                </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">Success</span></a></span><span> </span><span id="local-6989586621680895346"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680895346"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680895346"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-214"></span><span>                </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">Error</span></a></span><span> </span><span id="local-6989586621680895344"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680895344"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="../../../../mtl/html/src"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; CostModelApplyError
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CMInternalWriteError"><span class="hs-identifier hs-var">CMInternalWriteError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680895344"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-215"></span><span>    </span><span class="annot"><span class="annottext">Value
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="../../../../mtl/html/src"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">CostModelApplyError
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CMInternalReadError"><span class="hs-identifier hs-var">CMInternalReadError</span></a></span><span>
</span><span id="line-216"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-217"></span><span>    </span><span id="local-6989586621680895349"><span class="annot"><span class="annottext">toHash :: Map Text v -&gt; HashMap Text v
</span><a href="#local-6989586621680895349"><span class="hs-identifier hs-var hs-var">toHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><a href="../../../../unordered-containers/html/src"><span class="hs-identifier hs-var">HM.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall k a. Map k a -&gt; [(k, a)]
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.toList</span></a></span><span>
</span><span id="line-218"></span><span>    </span><span id="local-6989586621680895360"><span class="annot"><span class="annottext">fromHash :: HashMap Text a -&gt; Map Text a
</span><a href="#local-6989586621680895360"><span class="hs-identifier hs-var hs-var">fromHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall k v. HashMap k v -&gt; [(k, v)]
</span><a href="../../../../unordered-containers/html/src"><span class="hs-identifier hs-var">HM.toList</span></a></span><span>
</span><span id="line-219"></span><span>    </span><span class="hs-comment">-- fail when field missing</span><span>
</span><span id="line-220"></span><span>    </span><span id="local-6989586621680895357"><span class="annot"><span class="annottext">failMissing :: WhenMissing m Text x y
</span><a href="#local-6989586621680895357"><span class="hs-identifier hs-var hs-var">failMissing</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) k x y.
Applicative f =&gt;
(k -&gt; x -&gt; f y) -&gt; WhenMissing f k x y
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.traverseMissing</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span> </span><span id="local-6989586621680895332"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680895332"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621680895331"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621680895331"><span class="hs-identifier hs-var">_v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="../../../../mtl/html/src"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; CostModelApplyError
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CMUnknownParamError"><span class="hs-identifier hs-var">CMUnknownParamError</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680895332"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-comment">-- left-biased merging when key found in both maps</span><span>
</span><span id="line-222"></span><span>    </span><span id="local-6989586621680895354"><span class="annot"><span class="annottext">leftBiased :: p -&gt; p -&gt; p -&gt; p
</span><a href="#local-6989586621680895354"><span class="hs-identifier hs-var hs-var">leftBiased</span></a></span></span><span> </span><span id="local-6989586621680895330"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621680895330"><span class="hs-identifier hs-var">_k</span></a></span></span><span> </span><span id="local-6989586621680895329"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621680895329"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621680895328"><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621680895328"><span class="hs-identifier hs-var">_r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">p
</span><a href="#local-6989586621680895329"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span class="hs-comment">-- | Parameters for a machine step model and a builtin evaluation model bundled together.</span><span>
</span><span id="line-226"></span><span class="hs-keyword">data</span><span> </span><span id="SplitCostModelParams"><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#SplitCostModelParams"><span class="hs-identifier hs-var">SplitCostModelParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-227"></span><span>    </span><span id="SplitCostModelParams"><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#SplitCostModelParams"><span class="hs-identifier hs-var">SplitCostModelParams</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-228"></span><span>      </span><span id="_machineParams"><span class="annot"><span class="annottext">SplitCostModelParams -&gt; CostModelParams
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#_machineParams"><span class="hs-identifier hs-var hs-var">_machineParams</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelParams"><span class="hs-identifier hs-type">CostModelParams</span></a></span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_builtinParams"><span class="annot"><span class="annottext">SplitCostModelParams -&gt; CostModelParams
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#_builtinParams"><span class="hs-identifier hs-var hs-var">_builtinParams</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelParams"><span class="hs-identifier hs-type">CostModelParams</span></a></span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span class="hs-comment">-- | Split a CostModelParams object into two subobjects according to some prefix:</span><span>
</span><span id="line-233"></span><span class="hs-comment">-- see item 5 of Note [Cost model parameters].</span><span>
</span><span id="line-234"></span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#splitParams"><span class="hs-identifier hs-type">splitParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier hs-type">Text.Text</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelParams"><span class="hs-identifier hs-type">CostModelParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#SplitCostModelParams"><span class="hs-identifier hs-type">SplitCostModelParams</span></a></span><span>
</span><span id="line-235"></span><span id="splitParams"><span class="annot"><span class="annottext">splitParams :: Text -&gt; CostModelParams -&gt; SplitCostModelParams
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#splitParams"><span class="hs-identifier hs-var hs-var">splitParams</span></a></span></span><span> </span><span id="local-6989586621680895323"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680895323"><span class="hs-identifier hs-var">prefix</span></a></span></span><span> </span><span id="local-6989586621680895322"><span class="annot"><span class="annottext">CostModelParams
</span><a href="#local-6989586621680895322"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-236"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680895321"><span class="annot"><span class="annottext">CostModelParams
</span><a href="#local-6989586621680895321"><span class="hs-identifier hs-var">machineparams</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680895320"><span class="annot"><span class="annottext">CostModelParams
</span><a href="#local-6989586621680895320"><span class="hs-identifier hs-var">builtinparams</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; (Map k a, Map k a)
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.partitionWithKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680895318"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680895318"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Bool
</span><a href="../../../../text/html/src"><span class="hs-identifier hs-var">Text.isPrefixOf</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680895323"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680895318"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CostModelParams
</span><a href="#local-6989586621680895322"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">CostModelParams -&gt; CostModelParams -&gt; SplitCostModelParams
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#SplitCostModelParams"><span class="hs-identifier hs-var">SplitCostModelParams</span></a></span><span> </span><span class="annot"><span class="annottext">CostModelParams
</span><a href="#local-6989586621680895321"><span class="hs-identifier hs-var">machineparams</span></a></span><span> </span><span class="annot"><span class="annottext">CostModelParams
</span><a href="#local-6989586621680895320"><span class="hs-identifier hs-var">builtinparams</span></a></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="hs-comment">-- | Given a CostModel, produce a single map containing the parameters from both components</span><span>
</span><span id="line-240"></span><span id="local-6989586621680895540"><span id="local-6989586621680895541"><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#extractCostModelParams"><span class="hs-identifier hs-type">extractCostModelParams</span></a></span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">ToJSON</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895541"><span class="hs-identifier hs-type">machinecosts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">ToJSON</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895540"><span class="hs-identifier hs-type">builtincosts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.MachineParameters.html#CostModel"><span class="hs-identifier hs-type">CostModel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895541"><span class="hs-identifier hs-type">machinecosts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895540"><span class="hs-identifier hs-type">builtincosts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelParams"><span class="hs-identifier hs-type">CostModelParams</span></a></span></span></span><span>
</span><span id="line-243"></span><span id="extractCostModelParams"><span class="annot"><span class="annottext">extractCostModelParams :: forall machinecosts builtincosts.
(ToJSON machinecosts, ToJSON builtincosts) =&gt;
CostModel machinecosts builtincosts -&gt; Maybe CostModelParams
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#extractCostModelParams"><span class="hs-identifier hs-var hs-var">extractCostModelParams</span></a></span></span><span> </span><span id="local-6989586621680895307"><span class="annot"><span class="annottext">CostModel machinecosts builtincosts
</span><a href="#local-6989586621680895307"><span class="hs-identifier hs-var">model</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- this is using the applicative instance of Maybe</span><span>
</span><span id="line-244"></span><span>    </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><a href="../../../../containers/html/src"><span class="hs-identifier hs-var">Map.union</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; Maybe CostModelParams
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#extractParams"><span class="hs-identifier hs-var">extractParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall machinecosts builtincosts.
CostModel machinecosts builtincosts -&gt; machinecosts
</span><a href="PlutusCore.Evaluation.Machine.MachineParameters.html#_machineCostModel"><span class="hs-identifier hs-var">_machineCostModel</span></a></span><span> </span><span class="annot"><span class="annottext">CostModel machinecosts builtincosts
</span><a href="#local-6989586621680895307"><span class="hs-identifier hs-var">model</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. ToJSON a =&gt; a -&gt; Maybe CostModelParams
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#extractParams"><span class="hs-identifier hs-var">extractParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall machinecosts builtincosts.
CostModel machinecosts builtincosts -&gt; builtincosts
</span><a href="PlutusCore.Evaluation.Machine.MachineParameters.html#_builtinCostModel"><span class="hs-identifier hs-var">_builtinCostModel</span></a></span><span> </span><span class="annot"><span class="annottext">CostModel machinecosts builtincosts
</span><a href="#local-6989586621680895307"><span class="hs-identifier hs-var">model</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>
</span><span id="line-246"></span><span class="hs-comment">-- | Given a set of cost model parameters, split it into two parts according to</span><span>
</span><span id="line-247"></span><span class="hs-comment">-- some prefix and use those parts to update the components of a cost model.</span><span>
</span><span id="line-248"></span><span class="hs-comment">{- Strictly we don't need to do the splitting: when we call fromJSON in
   applyParams any superfluous objects in the map being decoded will be
   discarded, so we could update both components of the cost model with the
   entire set of parameters without having to worry about splitting the
   parameters on a prefix of the key.  This relies on what appears to be an
   undocumented implementation choice in Aeson though (other JSON decoders (for
   other languages) seem to vary in how unknown fields are handled), so let's be
   explicit. -}</span><span>
</span><span id="line-256"></span><span id="local-6989586621680895523"><span id="local-6989586621680895524"><span id="local-6989586621680895525"><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#applySplitCostModelParams"><span class="hs-identifier hs-type">applySplitCostModelParams</span></a></span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">FromJSON</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895525"><span class="hs-identifier hs-type">evaluatorcosts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">FromJSON</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895524"><span class="hs-identifier hs-type">builtincosts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">ToJSON</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895525"><span class="hs-identifier hs-type">evaluatorcosts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">ToJSON</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895524"><span class="hs-identifier hs-type">builtincosts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../mtl/html/src"><span class="hs-identifier hs-type">MonadError</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelApplyError"><span class="hs-identifier hs-type">CostModelApplyError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895523"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../text/html/src"><span class="hs-identifier hs-type">Text.Text</span></a></span><span>
</span><span id="line-259"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.MachineParameters.html#CostModel"><span class="hs-identifier hs-type">CostModel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895525"><span class="hs-identifier hs-type">evaluatorcosts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895524"><span class="hs-identifier hs-type">builtincosts</span></a></span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelParams"><span class="hs-identifier hs-type">CostModelParams</span></a></span><span>
</span><span id="line-261"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680895523"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Evaluation.Machine.MachineParameters.html#CostModel"><span class="hs-identifier hs-type">CostModel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895525"><span class="hs-identifier hs-type">evaluatorcosts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895524"><span class="hs-identifier hs-type">builtincosts</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-262"></span><span id="applySplitCostModelParams"><span class="annot"><span class="annottext">applySplitCostModelParams :: forall evaluatorcosts builtincosts (m :: * -&gt; *).
(FromJSON evaluatorcosts, FromJSON builtincosts,
 ToJSON evaluatorcosts, ToJSON builtincosts,
 MonadError CostModelApplyError m) =&gt;
Text
-&gt; CostModel evaluatorcosts builtincosts
-&gt; CostModelParams
-&gt; m (CostModel evaluatorcosts builtincosts)
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#applySplitCostModelParams"><span class="hs-identifier hs-var hs-var">applySplitCostModelParams</span></a></span></span><span> </span><span id="local-6989586621680895284"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680895284"><span class="hs-identifier hs-var">prefix</span></a></span></span><span> </span><span id="local-6989586621680895283"><span class="annot"><span class="annottext">CostModel evaluatorcosts builtincosts
</span><a href="#local-6989586621680895283"><span class="hs-identifier hs-var">model</span></a></span></span><span> </span><span id="local-6989586621680895282"><span class="annot"><span class="annottext">CostModelParams
</span><a href="#local-6989586621680895282"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-263"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#SplitCostModelParams"><span class="hs-identifier hs-type">SplitCostModelParams</span></a></span><span> </span><span id="local-6989586621680895281"><span class="annot"><span class="annottext">CostModelParams
</span><a href="#local-6989586621680895281"><span class="hs-identifier hs-var">machineparams</span></a></span></span><span> </span><span id="local-6989586621680895280"><span class="annot"><span class="annottext">CostModelParams
</span><a href="#local-6989586621680895280"><span class="hs-identifier hs-var">builtinparams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; CostModelParams -&gt; SplitCostModelParams
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#splitParams"><span class="hs-identifier hs-var">splitParams</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680895284"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">CostModelParams
</span><a href="#local-6989586621680895282"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-264"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall machinecosts builtincosts.
machinecosts -&gt; builtincosts -&gt; CostModel machinecosts builtincosts
</span><a href="PlutusCore.Evaluation.Machine.MachineParameters.html#CostModel"><span class="hs-identifier hs-var">CostModel</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *).
(FromJSON a, ToJSON a, MonadError CostModelApplyError m) =&gt;
a -&gt; CostModelParams -&gt; m a
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#applyParams"><span class="hs-identifier hs-var">applyParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall machinecosts builtincosts.
CostModel machinecosts builtincosts -&gt; machinecosts
</span><a href="PlutusCore.Evaluation.Machine.MachineParameters.html#_machineCostModel"><span class="hs-identifier hs-var">_machineCostModel</span></a></span><span> </span><span class="annot"><span class="annottext">CostModel evaluatorcosts builtincosts
</span><a href="#local-6989586621680895283"><span class="hs-identifier hs-var">model</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CostModelParams
</span><a href="#local-6989586621680895281"><span class="hs-identifier hs-var">machineparams</span></a></span><span>
</span><span id="line-265"></span><span>                 </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a (m :: * -&gt; *).
(FromJSON a, ToJSON a, MonadError CostModelApplyError m) =&gt;
a -&gt; CostModelParams -&gt; m a
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#applyParams"><span class="hs-identifier hs-var">applyParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall machinecosts builtincosts.
CostModel machinecosts builtincosts -&gt; builtincosts
</span><a href="PlutusCore.Evaluation.Machine.MachineParameters.html#_builtinCostModel"><span class="hs-identifier hs-var">_builtinCostModel</span></a></span><span> </span><span class="annot"><span class="annottext">CostModel evaluatorcosts builtincosts
</span><a href="#local-6989586621680895283"><span class="hs-identifier hs-var">model</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CostModelParams
</span><a href="#local-6989586621680895280"><span class="hs-identifier hs-var">builtinparams</span></a></span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span class="hs-comment">-- | Update a CostModel for the CEK machine with a given set of parameters.</span><span>
</span><span id="line-268"></span><span class="hs-comment">-- Note that this is costly. See [here](https://github.com/input-output-hk/plutus/issues/4962).</span><span>
</span><span id="line-269"></span><span class="hs-comment">-- Callers are recommended to call this once and cache the results.</span><span>
</span><span id="line-270"></span><span id="local-6989586621680895515"><span id="local-6989586621680895516"><span id="local-6989586621680895517"><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#applyCostModelParams"><span class="hs-identifier hs-type">applyCostModelParams</span></a></span><span>
</span><span id="line-271"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">FromJSON</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895517"><span class="hs-identifier hs-type">evaluatorcosts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">FromJSON</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895516"><span class="hs-identifier hs-type">builtincosts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">ToJSON</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895517"><span class="hs-identifier hs-type">evaluatorcosts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../aeson/html/src"><span class="hs-identifier hs-type">ToJSON</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895516"><span class="hs-identifier hs-type">builtincosts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../mtl/html/src"><span class="hs-identifier hs-type">MonadError</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelApplyError"><span class="hs-identifier hs-type">CostModelApplyError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895515"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.MachineParameters.html#CostModel"><span class="hs-identifier hs-type">CostModel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895517"><span class="hs-identifier hs-type">evaluatorcosts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895516"><span class="hs-identifier hs-type">builtincosts</span></a></span><span>
</span><span id="line-273"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#CostModelParams"><span class="hs-identifier hs-type">CostModelParams</span></a></span><span>
</span><span id="line-274"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680895515"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Evaluation.Machine.MachineParameters.html#CostModel"><span class="hs-identifier hs-type">CostModel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895517"><span class="hs-identifier hs-type">evaluatorcosts</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680895516"><span class="hs-identifier hs-type">builtincosts</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-275"></span><span id="applyCostModelParams"><span class="annot"><span class="annottext">applyCostModelParams :: forall evaluatorcosts builtincosts (m :: * -&gt; *).
(FromJSON evaluatorcosts, FromJSON builtincosts,
 ToJSON evaluatorcosts, ToJSON builtincosts,
 MonadError CostModelApplyError m) =&gt;
CostModel evaluatorcosts builtincosts
-&gt; CostModelParams -&gt; m (CostModel evaluatorcosts builtincosts)
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#applyCostModelParams"><span class="hs-identifier hs-var hs-var">applyCostModelParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall evaluatorcosts builtincosts (m :: * -&gt; *).
(FromJSON evaluatorcosts, FromJSON builtincosts,
 ToJSON evaluatorcosts, ToJSON builtincosts,
 MonadError CostModelApplyError m) =&gt;
Text
-&gt; CostModel evaluatorcosts builtincosts
-&gt; CostModelParams
-&gt; m (CostModel evaluatorcosts builtincosts)
</span><a href="PlutusCore.Evaluation.Machine.CostModelInterface.html#applySplitCostModelParams"><span class="hs-identifier hs-var">applySplitCostModelParams</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="UntypedPlutusCore.Evaluation.Machine.Cek.CekMachineCosts.html#cekMachineCostsPrefix"><span class="hs-identifier hs-var">cekMachineCostsPrefix</span></a></span><span>
</span><span id="line-276"></span></pre></body></html>