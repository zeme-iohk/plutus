<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-comment">{-|
Note [CSE for Stg]
~~~~~~~~~~~~~~~~~~

This module implements a simple common subexpression elimination pass for STG.
This is useful because there are expressions that we want to common up (because
they are operationally equivalent), but that we cannot common up in Core, because
their types differ.
This was originally reported as #9291.

There are two types of common code occurrences that we aim for, see
note [Case 1: CSEing allocated closures] and
note [Case 2: CSEing case binders] below.


Note [Case 1: CSEing allocated closures]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The first kind of CSE opportunity we aim for is generated by this Haskell code:

    bar :: a -&gt; (Either Int a, Either Bool a)
    bar x = (Right x, Right x)

which produces this Core:

    bar :: forall a. a -&gt; (Either Int a, Either Bool a)
    bar @a x = (Right @Int @a x, Right @Bool @a x)

where the two components of the tuple are different terms, and cannot be
commoned up (easily). On the STG level we have

    bar [x] = let c1 = Right [x]
                  c2 = Right [x]
              in (c1,c2)

and now it is obvious that we can write

    bar [x] = let c1 = Right [x]
              in (c1,c1)

instead.


Note [Case 2: CSEing case binders]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The second kind of CSE opportunity we aim for is more interesting, and
came up in #9291 and #5344: The Haskell code

    foo :: Either Int a -&gt; Either Bool a
    foo (Right x) = Right x
    foo _         = Left False

produces this Core

    foo :: forall a. Either Int a -&gt; Either Bool a
    foo @a e = case e of b { Left n -&gt; &#8230;
                           , Right x -&gt; Right @Bool @a x }

where we cannot CSE `Right @Bool @a x` with the case binder `b` as they have
different types. But in STG we have

    foo [e] = case e of b { Left [n] -&gt; &#8230;
                          , Right [x] -&gt; Right [x] }

and nothing stops us from transforming that to

    foo [e] = case e of b { Left [n] -&gt; &#8230;
                          , Right [x] -&gt; b}


Note [StgCse after unarisation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Consider two unboxed sum terms:

    (# 1 | #) :: (# Int | Int# #)
    (# 1 | #) :: (# Int | Int  #)

These two terms are not equal as they unarise to different unboxed
tuples. However if we run StgCse before Unarise, it'll think the two
terms (# 1 | #) are equal, and replace one of these with a binder to
the other. That's bad -- #15300.

Solution: do unarise first.

-}</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.Stg.CSE</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.CSE.html#stgCse"><span class="hs-identifier">stgCse</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html"><span class="hs-identifier">GHC.Core.DataCon</span></a></span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html"><span class="hs-identifier">GHC.Stg.Syntax</span></a></span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Basic.html#isWeakLoopBreaker"><span class="hs-identifier">isWeakLoopBreaker</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html"><span class="hs-identifier">GHC.Types.Var.Env</span></a></span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#AltCon"><span class="hs-identifier">AltCon</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/Data-List.html#"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.4.0/src/Data-Traversable.html#mapAccumL"><span class="hs-identifier">mapAccumL</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/Data-Maybe.html#"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.4.0/src/Data-Maybe.html#fromMaybe"><span class="hs-identifier">fromMaybe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Map.Expr.html"><span class="hs-identifier">GHC.Core.Map.Expr</span></a></span><span>
</span><span id="line-104"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.TrieMap.html"><span class="hs-identifier">GHC.Data.TrieMap</span></a></span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Env.html"><span class="hs-identifier">GHC.Types.Name.Env</span></a></span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/Control-Monad.html#"><span class="hs-identifier">Control.Monad</span></a></span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/Control-Monad.html#%3E%3D%3E"><span class="hs-operator">(&gt;=&gt;)</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="hs-comment">--------------</span><span>
</span><span id="line-109"></span><span class="hs-comment">-- The Trie --</span><span>
</span><span id="line-110"></span><span class="hs-comment">--------------</span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span class="hs-comment">-- A lookup trie for data constructor applications, i.e.</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- keys of type `(DataCon, [StgArg])`, following the patterns in GHC.Data.TrieMap.</span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span class="hs-keyword">data</span><span> </span><span id="StgArgMap"><span class="annot"><a href="GHC.Stg.CSE.html#StgArgMap"><span class="hs-identifier hs-var">StgArgMap</span></a></span></span><span> </span><span id="local-6989586621681170867"><span class="annot"><a href="#local-6989586621681170867"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SAM"><span class="annot"><a href="GHC.Stg.CSE.html#SAM"><span class="hs-identifier hs-var">SAM</span></a></span></span><span>
</span><span id="line-116"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="sam_var"><span class="annot"><span class="annottext">forall a. StgArgMap a -&gt; DVarEnv a
</span><a href="GHC.Stg.CSE.html#sam_var"><span class="hs-identifier hs-var hs-var">sam_var</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#DVarEnv"><span class="hs-identifier hs-type">DVarEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681170867"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="sam_lit"><span class="annot"><span class="annottext">forall a. StgArgMap a -&gt; LiteralMap a
</span><a href="GHC.Stg.CSE.html#sam_lit"><span class="hs-identifier hs-var hs-var">sam_lit</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Data.TrieMap.html#LiteralMap"><span class="hs-identifier hs-type">LiteralMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681170867"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Data.TrieMap.html#TrieMap"><span class="hs-identifier hs-type">TrieMap</span></a></span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#StgArgMap"><span class="hs-identifier hs-type">StgArgMap</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-keyword">type</span><span> </span><span id="Key"><span class="annot"><a href="GHC.Data.TrieMap.html#Key"><span class="hs-identifier hs-var">Key</span></a></span></span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#StgArgMap"><span class="hs-identifier hs-type">StgArgMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a></span><span>
</span><span id="line-122"></span><span>    </span><span id="local-6989586621681170699"><span class="annot"><span class="annottext">emptyTM :: forall a. StgArgMap a
</span><a href="GHC.Data.TrieMap.html#emptyTM"><span class="hs-identifier hs-var hs-var hs-var hs-var">emptyTM</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#SAM"><span class="hs-identifier hs-type">SAM</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sam_var :: DVarEnv a
</span><a href="GHC.Stg.CSE.html#sam_var"><span class="hs-identifier hs-var">sam_var</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. TrieMap m =&gt; m a
</span><a href="GHC.Data.TrieMap.html#emptyTM"><span class="hs-identifier hs-var">emptyTM</span></a></span><span>
</span><span id="line-123"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sam_lit :: LiteralMap a
</span><a href="GHC.Stg.CSE.html#sam_lit"><span class="hs-identifier hs-var">sam_lit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. TrieMap m =&gt; m a
</span><a href="GHC.Data.TrieMap.html#emptyTM"><span class="hs-identifier hs-var">emptyTM</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-124"></span><span>    </span><span id="local-6989586621681170695"><span class="annot"><span class="annottext">lookupTM :: forall b. Key StgArgMap -&gt; StgArgMap b -&gt; Maybe b
</span><a href="GHC.Data.TrieMap.html#lookupTM"><span class="hs-identifier hs-var hs-var hs-var hs-var">lookupTM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgVarArg"><span class="hs-identifier hs-type">StgVarArg</span></a></span><span> </span><span id="local-6989586621681170692"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170692"><span class="hs-identifier hs-var">var</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. StgArgMap a -&gt; DVarEnv a
</span><a href="GHC.Stg.CSE.html#sam_var"><span class="hs-identifier hs-var">sam_var</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b) -&gt; (b -&gt; c) -&gt; a -&gt; c
</span><a href="GHC.Data.TrieMap.html#%3E.%3E"><span class="hs-operator hs-var">&gt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Id -&gt; DVarEnv a -&gt; Maybe a
</span><a href="GHC.Core.Map.Type.html#lkDFreeVar"><span class="hs-identifier hs-var">lkDFreeVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170692"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-125"></span><span>    </span><span class="annot"><a href="GHC.Data.TrieMap.html#lookupTM"><span class="hs-identifier hs-var">lookupTM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgLitArg"><span class="hs-identifier hs-type">StgLitArg</span></a></span><span> </span><span id="local-6989586621681170688"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621681170688"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. StgArgMap a -&gt; LiteralMap a
</span><a href="GHC.Stg.CSE.html#sam_lit"><span class="hs-identifier hs-var">sam_lit</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b) -&gt; (b -&gt; c) -&gt; a -&gt; c
</span><a href="GHC.Data.TrieMap.html#%3E.%3E"><span class="hs-operator hs-var">&gt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b. TrieMap m =&gt; Key m -&gt; m b -&gt; Maybe b
</span><a href="GHC.Data.TrieMap.html#lookupTM"><span class="hs-identifier hs-var">lookupTM</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621681170688"><span class="hs-identifier hs-var">lit</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span id="local-6989586621681170685"><span class="annot"><span class="annottext">alterTM :: forall b. Key StgArgMap -&gt; XT b -&gt; StgArgMap b -&gt; StgArgMap b
</span><a href="GHC.Data.TrieMap.html#alterTM"><span class="hs-identifier hs-var hs-var hs-var hs-var">alterTM</span></a></span></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgVarArg"><span class="hs-identifier hs-type">StgVarArg</span></a></span><span> </span><span id="local-6989586621681170683"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170683"><span class="hs-identifier hs-var">var</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681170682"><span class="annot"><span class="annottext">XT b
</span><a href="#local-6989586621681170682"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621681170681"><span class="annot"><span class="annottext">StgArgMap b
</span><a href="#local-6989586621681170681"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StgArgMap b
</span><a href="#local-6989586621681170681"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sam_var :: DVarEnv b
</span><a href="GHC.Stg.CSE.html#sam_var"><span class="hs-identifier hs-var">sam_var</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. StgArgMap a -&gt; DVarEnv a
</span><a href="GHC.Stg.CSE.html#sam_var"><span class="hs-identifier hs-var">sam_var</span></a></span><span> </span><span class="annot"><span class="annottext">StgArgMap b
</span><a href="#local-6989586621681170681"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="GHC.Data.TrieMap.html#%7C%3E"><span class="hs-operator hs-var">|&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Id -&gt; XT a -&gt; DVarEnv a -&gt; DVarEnv a
</span><a href="GHC.Core.Map.Type.html#xtDFreeVar"><span class="hs-identifier hs-var">xtDFreeVar</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170683"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">XT b
</span><a href="#local-6989586621681170682"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-127"></span><span>    </span><span class="annot"><a href="GHC.Data.TrieMap.html#alterTM"><span class="hs-identifier hs-var">alterTM</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgLitArg"><span class="hs-identifier hs-type">StgLitArg</span></a></span><span> </span><span id="local-6989586621681170678"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621681170678"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681170677"><span class="annot"><span class="annottext">XT b
</span><a href="#local-6989586621681170677"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621681170676"><span class="annot"><span class="annottext">StgArgMap b
</span><a href="#local-6989586621681170676"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StgArgMap b
</span><a href="#local-6989586621681170676"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sam_lit :: LiteralMap b
</span><a href="GHC.Stg.CSE.html#sam_lit"><span class="hs-identifier hs-var">sam_lit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. StgArgMap a -&gt; LiteralMap a
</span><a href="GHC.Stg.CSE.html#sam_lit"><span class="hs-identifier hs-var">sam_lit</span></a></span><span> </span><span class="annot"><span class="annottext">StgArgMap b
</span><a href="#local-6989586621681170676"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="GHC.Data.TrieMap.html#%7C%3E"><span class="hs-operator hs-var">|&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b. TrieMap m =&gt; Key m -&gt; XT b -&gt; m b -&gt; m b
</span><a href="GHC.Data.TrieMap.html#alterTM"><span class="hs-identifier hs-var">alterTM</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621681170678"><span class="hs-identifier hs-var">lit</span></a></span><span> </span><span class="annot"><span class="annottext">XT b
</span><a href="#local-6989586621681170677"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-128"></span><span>    </span><span id="local-6989586621681170671"><span class="annot"><span class="annottext">foldTM :: forall a b. (a -&gt; b -&gt; b) -&gt; StgArgMap a -&gt; b -&gt; b
</span><a href="GHC.Data.TrieMap.html#foldTM"><span class="hs-identifier hs-var hs-var hs-var hs-var">foldTM</span></a></span></span><span> </span><span id="local-6989586621681170669"><span class="annot"><span class="annottext">a -&gt; b -&gt; b
</span><a href="#local-6989586621681170669"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621681170668"><span class="annot"><span class="annottext">StgArgMap a
</span><a href="#local-6989586621681170668"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
TrieMap m =&gt;
(a -&gt; b -&gt; b) -&gt; m a -&gt; b -&gt; b
</span><a href="GHC.Data.TrieMap.html#foldTM"><span class="hs-identifier hs-var">foldTM</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; b -&gt; b
</span><a href="#local-6989586621681170669"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. StgArgMap a -&gt; DVarEnv a
</span><a href="GHC.Stg.CSE.html#sam_var"><span class="hs-identifier hs-var">sam_var</span></a></span><span> </span><span class="annot"><span class="annottext">StgArgMap a
</span><a href="#local-6989586621681170668"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
TrieMap m =&gt;
(a -&gt; b -&gt; b) -&gt; m a -&gt; b -&gt; b
</span><a href="GHC.Data.TrieMap.html#foldTM"><span class="hs-identifier hs-var">foldTM</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; b -&gt; b
</span><a href="#local-6989586621681170669"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. StgArgMap a -&gt; LiteralMap a
</span><a href="GHC.Stg.CSE.html#sam_lit"><span class="hs-identifier hs-var">sam_lit</span></a></span><span> </span><span class="annot"><span class="annottext">StgArgMap a
</span><a href="#local-6989586621681170668"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>    </span><span id="local-6989586621681170662"><span class="annot"><span class="annottext">mapTM :: forall a b. (a -&gt; b) -&gt; StgArgMap a -&gt; StgArgMap b
</span><a href="GHC.Data.TrieMap.html#mapTM"><span class="hs-identifier hs-var hs-var hs-var hs-var">mapTM</span></a></span></span><span> </span><span id="local-6989586621681170660"><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621681170660"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.CSE.html#SAM"><span class="hs-identifier hs-type">SAM</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">sam_var :: forall a. StgArgMap a -&gt; DVarEnv a
</span><a href="GHC.Stg.CSE.html#sam_var"><span class="hs-identifier hs-var">sam_var</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681170659"><span class="annot"><span class="annottext">DVarEnv a
</span><a href="#local-6989586621681170659"><span class="hs-identifier hs-var">varm</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sam_lit :: forall a. StgArgMap a -&gt; LiteralMap a
</span><a href="GHC.Stg.CSE.html#sam_lit"><span class="hs-identifier hs-var">sam_lit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681170658"><span class="annot"><span class="annottext">LiteralMap a
</span><a href="#local-6989586621681170658"><span class="hs-identifier hs-var">litm</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-130"></span><span>        </span><span class="annot"><a href="GHC.Stg.CSE.html#SAM"><span class="hs-identifier hs-type">SAM</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sam_var :: DVarEnv b
</span><a href="GHC.Stg.CSE.html#sam_var"><span class="hs-identifier hs-var">sam_var</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. TrieMap m =&gt; (a -&gt; b) -&gt; m a -&gt; m b
</span><a href="GHC.Data.TrieMap.html#mapTM"><span class="hs-identifier hs-var">mapTM</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621681170660"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">DVarEnv a
</span><a href="#local-6989586621681170659"><span class="hs-identifier hs-var">varm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sam_lit :: LiteralMap b
</span><a href="GHC.Stg.CSE.html#sam_lit"><span class="hs-identifier hs-var">sam_lit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. TrieMap m =&gt; (a -&gt; b) -&gt; m a -&gt; m b
</span><a href="GHC.Data.TrieMap.html#mapTM"><span class="hs-identifier hs-var">mapTM</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621681170660"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">LiteralMap a
</span><a href="#local-6989586621681170658"><span class="hs-identifier hs-var">litm</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-131"></span><span>    </span><span id="local-6989586621681170653"><span class="annot"><span class="annottext">filterTM :: forall a. (a -&gt; Bool) -&gt; StgArgMap a -&gt; StgArgMap a
</span><a href="GHC.Data.TrieMap.html#filterTM"><span class="hs-identifier hs-var hs-var hs-var hs-var">filterTM</span></a></span></span><span> </span><span id="local-6989586621681170651"><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621681170651"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.CSE.html#SAM"><span class="hs-identifier hs-type">SAM</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">sam_var :: forall a. StgArgMap a -&gt; DVarEnv a
</span><a href="GHC.Stg.CSE.html#sam_var"><span class="hs-identifier hs-var">sam_var</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681170650"><span class="annot"><span class="annottext">DVarEnv a
</span><a href="#local-6989586621681170650"><span class="hs-identifier hs-var">varm</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sam_lit :: forall a. StgArgMap a -&gt; LiteralMap a
</span><a href="GHC.Stg.CSE.html#sam_lit"><span class="hs-identifier hs-var">sam_lit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681170649"><span class="annot"><span class="annottext">LiteralMap a
</span><a href="#local-6989586621681170649"><span class="hs-identifier hs-var">litm</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-132"></span><span>        </span><span class="annot"><a href="GHC.Stg.CSE.html#SAM"><span class="hs-identifier hs-type">SAM</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">sam_var :: DVarEnv a
</span><a href="GHC.Stg.CSE.html#sam_var"><span class="hs-identifier hs-var">sam_var</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. TrieMap m =&gt; (a -&gt; Bool) -&gt; m a -&gt; m a
</span><a href="GHC.Data.TrieMap.html#filterTM"><span class="hs-identifier hs-var">filterTM</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621681170651"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">DVarEnv a
</span><a href="#local-6989586621681170650"><span class="hs-identifier hs-var">varm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">sam_lit :: LiteralMap a
</span><a href="GHC.Stg.CSE.html#sam_lit"><span class="hs-identifier hs-var">sam_lit</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. TrieMap m =&gt; (a -&gt; Bool) -&gt; m a -&gt; m a
</span><a href="GHC.Data.TrieMap.html#filterTM"><span class="hs-identifier hs-var">filterTM</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621681170651"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">LiteralMap a
</span><a href="#local-6989586621681170649"><span class="hs-identifier hs-var">litm</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span class="hs-keyword">newtype</span><span> </span><span id="ConAppMap"><span class="annot"><a href="GHC.Stg.CSE.html#ConAppMap"><span class="hs-identifier hs-var">ConAppMap</span></a></span></span><span> </span><span id="local-6989586621681170825"><span class="annot"><a href="#local-6989586621681170825"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CAM"><span class="annot"><a href="GHC.Stg.CSE.html#CAM"><span class="hs-identifier hs-var">CAM</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="un_cam"><span class="annot"><span class="annottext">forall a. ConAppMap a -&gt; DNameEnv (ListMap StgArgMap a)
</span><a href="GHC.Stg.CSE.html#un_cam"><span class="hs-identifier hs-var hs-var">un_cam</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Name.Env.html#DNameEnv"><span class="hs-identifier hs-type">DNameEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Data.TrieMap.html#ListMap"><span class="hs-identifier hs-type">ListMap</span></a></span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#StgArgMap"><span class="hs-identifier hs-type">StgArgMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681170825"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="GHC.Data.TrieMap.html#TrieMap"><span class="hs-identifier hs-type">TrieMap</span></a></span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#ConAppMap"><span class="hs-identifier hs-type">ConAppMap</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-keyword">type</span><span> </span><span id="Key"><span class="annot"><a href="GHC.Data.TrieMap.html#Key"><span class="hs-identifier hs-var">Key</span></a></span></span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#ConAppMap"><span class="hs-identifier hs-type">ConAppMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgArg"><span class="hs-identifier hs-type">StgArg</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-138"></span><span>    </span><span id="local-6989586621681170637"><span class="annot"><span class="annottext">emptyTM :: forall a. ConAppMap a
</span><a href="#local-6989586621681170637"><span class="hs-identifier hs-var hs-var hs-var hs-var">emptyTM</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. DNameEnv (ListMap StgArgMap a) -&gt; ConAppMap a
</span><a href="GHC.Stg.CSE.html#CAM"><span class="hs-identifier hs-var">CAM</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. TrieMap m =&gt; m a
</span><a href="GHC.Data.TrieMap.html#emptyTM"><span class="hs-identifier hs-var">emptyTM</span></a></span><span>
</span><span id="line-139"></span><span>    </span><span id="local-6989586621681170629"><span class="annot"><span class="annottext">lookupTM :: forall b. Key ConAppMap -&gt; ConAppMap b -&gt; Maybe b
</span><a href="#local-6989586621681170629"><span class="hs-identifier hs-var hs-var hs-var hs-var">lookupTM</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681170628"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170628"><span class="hs-identifier hs-var">dataCon</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170627"><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170627"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. ConAppMap a -&gt; DNameEnv (ListMap StgArgMap a)
</span><a href="GHC.Stg.CSE.html#un_cam"><span class="hs-identifier hs-var">un_cam</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b) -&gt; (b -&gt; c) -&gt; a -&gt; c
</span><a href="GHC.Data.TrieMap.html#%3E.%3E"><span class="hs-operator hs-var">&gt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall n a. NamedThing n =&gt; n -&gt; DNameEnv a -&gt; Maybe a
</span><a href="GHC.Core.Map.Type.html#lkDNamed"><span class="hs-identifier hs-var">lkDNamed</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170628"><span class="hs-identifier hs-var">dataCon</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b c.
Monad m =&gt;
(a -&gt; m b) -&gt; (b -&gt; m c) -&gt; a -&gt; m c
</span><a href="../../base-4.16.4.0/src/Control-Monad.html#%3E%3D%3E"><span class="hs-operator hs-var">&gt;=&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b. TrieMap m =&gt; Key m -&gt; m b -&gt; Maybe b
</span><a href="GHC.Data.TrieMap.html#lookupTM"><span class="hs-identifier hs-var">lookupTM</span></a></span><span> </span><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170627"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-140"></span><span>    </span><span id="local-6989586621681170621"><span class="annot"><span class="annottext">alterTM :: forall b. Key ConAppMap -&gt; XT b -&gt; ConAppMap b -&gt; ConAppMap b
</span><a href="#local-6989586621681170621"><span class="hs-identifier hs-var hs-var hs-var hs-var">alterTM</span></a></span></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681170620"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170620"><span class="hs-identifier hs-var">dataCon</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170619"><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170619"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681170618"><span class="annot"><span class="annottext">XT b
</span><a href="#local-6989586621681170618"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621681170617"><span class="annot"><span class="annottext">ConAppMap b
</span><a href="#local-6989586621681170617"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-141"></span><span>        </span><span class="annot"><span class="annottext">ConAppMap b
</span><a href="#local-6989586621681170617"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">un_cam :: DNameEnv (ListMap StgArgMap b)
</span><a href="GHC.Stg.CSE.html#un_cam"><span class="hs-identifier hs-var">un_cam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. ConAppMap a -&gt; DNameEnv (ListMap StgArgMap a)
</span><a href="GHC.Stg.CSE.html#un_cam"><span class="hs-identifier hs-var">un_cam</span></a></span><span> </span><span class="annot"><span class="annottext">ConAppMap b
</span><a href="#local-6989586621681170617"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="GHC.Data.TrieMap.html#%7C%3E"><span class="hs-operator hs-var">|&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall n a. NamedThing n =&gt; n -&gt; XT a -&gt; DNameEnv a -&gt; DNameEnv a
</span><a href="GHC.Core.Map.Type.html#xtDNamed"><span class="hs-identifier hs-var">xtDNamed</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170620"><span class="hs-identifier hs-var">dataCon</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m2 :: * -&gt; *) a (m1 :: * -&gt; *).
TrieMap m2 =&gt;
(XT (m2 a) -&gt; m1 (m2 a) -&gt; m1 (m2 a))
-&gt; (m2 a -&gt; m2 a) -&gt; m1 (m2 a) -&gt; m1 (m2 a)
</span><a href="GHC.Data.TrieMap.html#%7C%3E%3E"><span class="hs-operator hs-var">|&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b. TrieMap m =&gt; Key m -&gt; XT b -&gt; m b -&gt; m b
</span><a href="GHC.Data.TrieMap.html#alterTM"><span class="hs-identifier hs-var">alterTM</span></a></span><span> </span><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170619"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">XT b
</span><a href="#local-6989586621681170618"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-142"></span><span>    </span><span id="local-6989586621681170610"><span class="annot"><span class="annottext">foldTM :: forall a b. (a -&gt; b -&gt; b) -&gt; ConAppMap a -&gt; b -&gt; b
</span><a href="#local-6989586621681170610"><span class="hs-identifier hs-var hs-var hs-var hs-var">foldTM</span></a></span></span><span> </span><span id="local-6989586621681170609"><span class="annot"><span class="annottext">a -&gt; b -&gt; b
</span><a href="#local-6989586621681170609"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. ConAppMap a -&gt; DNameEnv (ListMap StgArgMap a)
</span><a href="GHC.Stg.CSE.html#un_cam"><span class="hs-identifier hs-var">un_cam</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b) -&gt; (b -&gt; c) -&gt; a -&gt; c
</span><a href="GHC.Data.TrieMap.html#%3E.%3E"><span class="hs-operator hs-var">&gt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
TrieMap m =&gt;
(a -&gt; b -&gt; b) -&gt; m a -&gt; b -&gt; b
</span><a href="GHC.Data.TrieMap.html#foldTM"><span class="hs-identifier hs-var">foldTM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
TrieMap m =&gt;
(a -&gt; b -&gt; b) -&gt; m a -&gt; b -&gt; b
</span><a href="GHC.Data.TrieMap.html#foldTM"><span class="hs-identifier hs-var">foldTM</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; b -&gt; b
</span><a href="#local-6989586621681170609"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-143"></span><span>    </span><span id="local-6989586621681170604"><span class="annot"><span class="annottext">mapTM :: forall a b. (a -&gt; b) -&gt; ConAppMap a -&gt; ConAppMap b
</span><a href="#local-6989586621681170604"><span class="hs-identifier hs-var hs-var hs-var hs-var">mapTM</span></a></span></span><span> </span><span id="local-6989586621681170603"><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621681170603"><span class="hs-identifier hs-var">f</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. ConAppMap a -&gt; DNameEnv (ListMap StgArgMap a)
</span><a href="GHC.Stg.CSE.html#un_cam"><span class="hs-identifier hs-var">un_cam</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b) -&gt; (b -&gt; c) -&gt; a -&gt; c
</span><a href="GHC.Data.TrieMap.html#%3E.%3E"><span class="hs-operator hs-var">&gt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. TrieMap m =&gt; (a -&gt; b) -&gt; m a -&gt; m b
</span><a href="GHC.Data.TrieMap.html#mapTM"><span class="hs-identifier hs-var">mapTM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. TrieMap m =&gt; (a -&gt; b) -&gt; m a -&gt; m b
</span><a href="GHC.Data.TrieMap.html#mapTM"><span class="hs-identifier hs-var">mapTM</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621681170603"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b) -&gt; (b -&gt; c) -&gt; a -&gt; c
</span><a href="GHC.Data.TrieMap.html#%3E.%3E"><span class="hs-operator hs-var">&gt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. DNameEnv (ListMap StgArgMap a) -&gt; ConAppMap a
</span><a href="GHC.Stg.CSE.html#CAM"><span class="hs-identifier hs-var">CAM</span></a></span><span>
</span><span id="line-144"></span><span>    </span><span id="local-6989586621681170598"><span class="annot"><span class="annottext">filterTM :: forall a. (a -&gt; Bool) -&gt; ConAppMap a -&gt; ConAppMap a
</span><a href="#local-6989586621681170598"><span class="hs-identifier hs-var hs-var hs-var hs-var">filterTM</span></a></span></span><span> </span><span id="local-6989586621681170597"><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621681170597"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. ConAppMap a -&gt; DNameEnv (ListMap StgArgMap a)
</span><a href="GHC.Stg.CSE.html#un_cam"><span class="hs-identifier hs-var">un_cam</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b) -&gt; (b -&gt; c) -&gt; a -&gt; c
</span><a href="GHC.Data.TrieMap.html#%3E.%3E"><span class="hs-operator hs-var">&gt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. TrieMap m =&gt; (a -&gt; b) -&gt; m a -&gt; m b
</span><a href="GHC.Data.TrieMap.html#mapTM"><span class="hs-identifier hs-var">mapTM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. TrieMap m =&gt; (a -&gt; Bool) -&gt; m a -&gt; m a
</span><a href="GHC.Data.TrieMap.html#filterTM"><span class="hs-identifier hs-var">filterTM</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Bool
</span><a href="#local-6989586621681170597"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b) -&gt; (b -&gt; c) -&gt; a -&gt; c
</span><a href="GHC.Data.TrieMap.html#%3E.%3E"><span class="hs-operator hs-var">&gt;.&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. DNameEnv (ListMap StgArgMap a) -&gt; ConAppMap a
</span><a href="GHC.Stg.CSE.html#CAM"><span class="hs-identifier hs-var">CAM</span></a></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="hs-comment">-----------------</span><span>
</span><span id="line-147"></span><span class="hs-comment">-- The CSE Env --</span><span>
</span><span id="line-148"></span><span class="hs-comment">-----------------</span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span class="hs-comment">-- | The CSE environment. See note [CseEnv Example]</span><span>
</span><span id="line-151"></span><span class="hs-keyword">data</span><span> </span><span id="CseEnv"><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-var">CseEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CseEnv"><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-var">CseEnv</span></a></span></span><span>
</span><span id="line-152"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="ce_conAppMap"><span class="annot"><span class="annottext">CseEnv -&gt; ConAppMap Id
</span><a href="GHC.Stg.CSE.html#ce_conAppMap"><span class="hs-identifier hs-var hs-var">ce_conAppMap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#ConAppMap"><span class="hs-identifier hs-type">ConAppMap</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span>
</span><span id="line-153"></span><span>        </span><span class="hs-comment">-- ^ The main component of the environment is the trie that maps</span><span>
</span><span id="line-154"></span><span>        </span><span class="hs-comment">--   data constructor applications (with their `OutId` arguments)</span><span>
</span><span id="line-155"></span><span>        </span><span class="hs-comment">--   to an in-scope name that can be used instead.</span><span>
</span><span id="line-156"></span><span>        </span><span class="hs-comment">--   This name is always either a let-bound variable or a case binder.</span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="ce_subst"><span class="annot"><span class="annottext">CseEnv -&gt; IdEnv Id
</span><a href="GHC.Stg.CSE.html#ce_subst"><span class="hs-identifier hs-var hs-var">ce_subst</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span>
</span><span id="line-158"></span><span>        </span><span class="hs-comment">-- ^ This substitution is applied to the code as we traverse it.</span><span>
</span><span id="line-159"></span><span>        </span><span class="hs-comment">--   Entries have one of two reasons:</span><span>
</span><span id="line-160"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-161"></span><span>        </span><span class="hs-comment">--   * The input might have shadowing (see Note [Shadowing]), so we have</span><span>
</span><span id="line-162"></span><span>        </span><span class="hs-comment">--     to rename some binders as we traverse the tree.</span><span>
</span><span id="line-163"></span><span>        </span><span class="hs-comment">--   * If we remove `let x = Con z` because  `let y = Con z` is in scope,</span><span>
</span><span id="line-164"></span><span>        </span><span class="hs-comment">--     we note this here as x &#8614; y.</span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="ce_bndrMap"><span class="annot"><span class="annottext">CseEnv -&gt; IdEnv Id
</span><a href="GHC.Stg.CSE.html#ce_bndrMap"><span class="hs-identifier hs-var hs-var">ce_bndrMap</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span>
</span><span id="line-166"></span><span>        </span><span class="hs-comment">-- ^ If we come across a case expression case x as b of &#8230; with a trivial</span><span>
</span><span id="line-167"></span><span>        </span><span class="hs-comment">--   binder, we add b &#8614; x to this.</span><span>
</span><span id="line-168"></span><span>        </span><span class="hs-comment">--   This map is *only* used when looking something up in the ce_conAppMap.</span><span>
</span><span id="line-169"></span><span>        </span><span class="hs-comment">--   See Note [Trivial case scrutinee]</span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="ce_in_scope"><span class="annot"><span class="annottext">CseEnv -&gt; InScopeSet
</span><a href="GHC.Stg.CSE.html#ce_in_scope"><span class="hs-identifier hs-var hs-var">ce_in_scope</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span>
</span><span id="line-171"></span><span>        </span><span class="hs-comment">-- ^ The third component is an in-scope set, to rename away any</span><span>
</span><span id="line-172"></span><span>        </span><span class="hs-comment">--   shadowing binders</span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span class="hs-comment">{-|
Note [CseEnv Example]
~~~~~~~~~~~~~~~~~~~~~
The following tables shows how the CseEnvironment changes as code is traversed,
as well as the changes to that code.

  InExpr                         OutExpr
     conAppMap                   subst          in_scope
  &#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;
  -- empty                       {}             {}
  case &#8230; as a of {Con x y -&gt;     case &#8230; as a of {Con x y -&gt;
  -- Con x y &#8614; a                 {}             {a,x,y}
  let b = Con x y                (removed)
  -- Con x y &#8614; a                 b&#8614;a            {a,x,y,b}
  let c = Bar a                  let c = Bar a
  -- Con x y &#8614; a, Bar a &#8614; c      b&#8614;a            {a,x,y,b,c}
  let c = some expression        let c' = some expression
  -- Con x y &#8614; a, Bar a &#8614; c      b&#8614;a, c&#8614;c',     {a,x,y,b,c,c'}
  let d = Bar b                  (removed)
  -- Con x y &#8614; a, Bar a &#8614; c      b&#8614;a, c&#8614;c', d&#8614;c {a,x,y,b,c,c',d}
  (a, b, c d)                    (a, a, c' c)
-}</span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="annot"><a href="GHC.Stg.CSE.html#initEnv"><span class="hs-identifier hs-type">initEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span>
</span><span id="line-199"></span><span id="initEnv"><span class="annot"><span class="annottext">initEnv :: InScopeSet -&gt; CseEnv
</span><a href="GHC.Stg.CSE.html#initEnv"><span class="hs-identifier hs-var hs-var">initEnv</span></a></span></span><span> </span><span id="local-6989586621681170589"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681170589"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ce_conAppMap :: ConAppMap Id
</span><a href="GHC.Stg.CSE.html#ce_conAppMap"><span class="hs-identifier hs-var">ce_conAppMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. TrieMap m =&gt; m a
</span><a href="GHC.Data.TrieMap.html#emptyTM"><span class="hs-identifier hs-var">emptyTM</span></a></span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ce_subst :: IdEnv Id
</span><a href="GHC.Stg.CSE.html#ce_subst"><span class="hs-identifier hs-var">ce_subst</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span>
</span><span id="line-202"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ce_bndrMap :: IdEnv Id
</span><a href="GHC.Stg.CSE.html#ce_bndrMap"><span class="hs-identifier hs-var">ce_bndrMap</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. VarEnv a
</span><a href="GHC.Types.Var.Env.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a></span><span>
</span><span id="line-203"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ce_in_scope :: InScopeSet
</span><a href="GHC.Stg.CSE.html#ce_in_scope"><span class="hs-identifier hs-var">ce_in_scope</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681170589"><span class="hs-identifier hs-var">in_scope</span></a></span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span class="annot"><a href="GHC.Stg.CSE.html#envLookup"><span class="hs-identifier hs-type">envLookup</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Stg.Syntax.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span>
</span><span id="line-207"></span><span id="envLookup"><span class="annot"><span class="annottext">envLookup :: DataCon -&gt; [StgArg] -&gt; CseEnv -&gt; Maybe Id
</span><a href="GHC.Stg.CSE.html#envLookup"><span class="hs-identifier hs-var hs-var">envLookup</span></a></span></span><span> </span><span id="local-6989586621681170585"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170585"><span class="hs-identifier hs-var">dataCon</span></a></span></span><span> </span><span id="local-6989586621681170584"><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170584"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621681170583"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170583"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b. TrieMap m =&gt; Key m -&gt; m b -&gt; Maybe b
</span><a href="GHC.Data.TrieMap.html#lookupTM"><span class="hs-identifier hs-var">lookupTM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170585"><span class="hs-identifier hs-var">dataCon</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170582"><span class="hs-identifier hs-var">args'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CseEnv -&gt; ConAppMap Id
</span><a href="GHC.Stg.CSE.html#ce_conAppMap"><span class="hs-identifier hs-var">ce_conAppMap</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170583"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681170582"><span class="annot"><span class="annottext">args' :: [StgArg]
</span><a href="#local-6989586621681170582"><span class="hs-identifier hs-var hs-var">args'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">StgArg -&gt; StgArg
</span><a href="#local-6989586621681170581"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170584"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="hs-comment">-- See Note [Trivial case scrutinee]</span><span>
</span><span id="line-209"></span><span>        </span><span id="local-6989586621681170581"><span class="annot"><span class="annottext">go :: StgArg -&gt; StgArg
</span><a href="#local-6989586621681170581"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgVarArg"><span class="hs-identifier hs-type">StgVarArg</span></a></span><span> </span><span id="local-6989586621681170580"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170580"><span class="hs-identifier hs-var">v</span></a></span></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; StgArg
</span><a href="GHC.Stg.Syntax.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a -&gt; a
</span><a href="../../base-4.16.4.0/src/Data-Maybe.html#fromMaybe"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170580"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CseEnv -&gt; IdEnv Id
</span><a href="GHC.Stg.CSE.html#ce_bndrMap"><span class="hs-identifier hs-var">ce_bndrMap</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170583"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170580"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>        </span><span class="annot"><a href="#local-6989586621681170581"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgLitArg"><span class="hs-identifier hs-type">StgLitArg</span></a></span><span> </span><span id="local-6989586621681170578"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621681170578"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Literal -&gt; StgArg
</span><a href="GHC.Stg.Syntax.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621681170578"><span class="hs-identifier hs-var">lit</span></a></span><span>
</span><span id="line-211"></span><span>
</span><span id="line-212"></span><span class="annot"><a href="GHC.Stg.CSE.html#addDataCon"><span class="hs-identifier hs-type">addDataCon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Stg.Syntax.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span>
</span><span id="line-213"></span><span class="hs-comment">-- do not bother with nullary data constructors, they are static anyways</span><span>
</span><span id="line-214"></span><span id="addDataCon"><span class="annot"><span class="annottext">addDataCon :: Id -&gt; DataCon -&gt; [StgArg] -&gt; CseEnv -&gt; CseEnv
</span><a href="GHC.Stg.CSE.html#addDataCon"><span class="hs-identifier hs-var hs-var">addDataCon</span></a></span></span><span> </span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621681170576"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170576"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170576"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-215"></span><span class="annot"><a href="GHC.Stg.CSE.html#addDataCon"><span class="hs-identifier hs-var">addDataCon</span></a></span><span> </span><span id="local-6989586621681170575"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170575"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621681170574"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170574"><span class="hs-identifier hs-var">dataCon</span></a></span></span><span> </span><span id="local-6989586621681170573"><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170573"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621681170572"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170572"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170572"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ce_conAppMap :: ConAppMap Id
</span><a href="GHC.Stg.CSE.html#ce_conAppMap"><span class="hs-identifier hs-var">ce_conAppMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConAppMap Id
</span><a href="#local-6989586621681170571"><span class="hs-identifier hs-var">new_env</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-216"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-217"></span><span>    </span><span id="local-6989586621681170571"><span class="annot"><span class="annottext">new_env :: ConAppMap Id
</span><a href="#local-6989586621681170571"><span class="hs-identifier hs-var hs-var">new_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. TrieMap m =&gt; Key m -&gt; a -&gt; m a -&gt; m a
</span><a href="GHC.Data.TrieMap.html#insertTM"><span class="hs-identifier hs-var">insertTM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170574"><span class="hs-identifier hs-var">dataCon</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170573"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170575"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CseEnv -&gt; ConAppMap Id
</span><a href="GHC.Stg.CSE.html#ce_conAppMap"><span class="hs-identifier hs-var">ce_conAppMap</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170572"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span class="annot"><a href="GHC.Stg.CSE.html#forgetCse"><span class="hs-identifier hs-type">forgetCse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span>
</span><span id="line-220"></span><span id="forgetCse"><span class="annot"><span class="annottext">forgetCse :: CseEnv -&gt; CseEnv
</span><a href="GHC.Stg.CSE.html#forgetCse"><span class="hs-identifier hs-var hs-var">forgetCse</span></a></span></span><span> </span><span id="local-6989586621681170568"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170568"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170568"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ce_conAppMap :: ConAppMap Id
</span><a href="GHC.Stg.CSE.html#ce_conAppMap"><span class="hs-identifier hs-var">ce_conAppMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. TrieMap m =&gt; m a
</span><a href="GHC.Data.TrieMap.html#emptyTM"><span class="hs-identifier hs-var">emptyTM</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-comment">-- See note [Free variables of an StgClosure]</span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span class="annot"><a href="GHC.Stg.CSE.html#addSubst"><span class="hs-identifier hs-type">addSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span>
</span><span id="line-224"></span><span id="addSubst"><span class="annot"><span class="annottext">addSubst :: Id -&gt; Id -&gt; CseEnv -&gt; CseEnv
</span><a href="GHC.Stg.CSE.html#addSubst"><span class="hs-identifier hs-var hs-var">addSubst</span></a></span></span><span> </span><span id="local-6989586621681170566"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170566"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621681170565"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170565"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span id="local-6989586621681170564"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170564"><span class="hs-identifier hs-var">env</span></a></span></span><span>
</span><span id="line-225"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170564"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ce_subst :: IdEnv Id
</span><a href="GHC.Stg.CSE.html#ce_subst"><span class="hs-identifier hs-var">ce_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. VarEnv a -&gt; Id -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CseEnv -&gt; IdEnv Id
</span><a href="GHC.Stg.CSE.html#ce_subst"><span class="hs-identifier hs-var">ce_subst</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170564"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170566"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170565"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span class="annot"><a href="GHC.Stg.CSE.html#addTrivCaseBndr"><span class="hs-identifier hs-type">addTrivCaseBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span>
</span><span id="line-228"></span><span id="addTrivCaseBndr"><span class="annot"><span class="annottext">addTrivCaseBndr :: Id -&gt; Id -&gt; CseEnv -&gt; CseEnv
</span><a href="GHC.Stg.CSE.html#addTrivCaseBndr"><span class="hs-identifier hs-var hs-var">addTrivCaseBndr</span></a></span></span><span> </span><span id="local-6989586621681170561"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170561"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621681170560"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170560"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span id="local-6989586621681170559"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170559"><span class="hs-identifier hs-var">env</span></a></span></span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170559"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ce_bndrMap :: IdEnv Id
</span><a href="GHC.Stg.CSE.html#ce_bndrMap"><span class="hs-identifier hs-var">ce_bndrMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. VarEnv a -&gt; Id -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CseEnv -&gt; IdEnv Id
</span><a href="GHC.Stg.CSE.html#ce_bndrMap"><span class="hs-identifier hs-var">ce_bndrMap</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170559"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170561"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170560"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-230"></span><span>
</span><span id="line-231"></span><span class="annot"><a href="GHC.Stg.CSE.html#substArgs"><span class="hs-identifier hs-type">substArgs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Stg.Syntax.html#InStgArg"><span class="hs-identifier hs-type">InStgArg</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Stg.Syntax.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-232"></span><span id="substArgs"><span class="annot"><span class="annottext">substArgs :: CseEnv -&gt; [StgArg] -&gt; [StgArg]
</span><a href="GHC.Stg.CSE.html#substArgs"><span class="hs-identifier hs-var hs-var">substArgs</span></a></span></span><span> </span><span id="local-6989586621681170556"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170556"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CseEnv -&gt; StgArg -&gt; StgArg
</span><a href="GHC.Stg.CSE.html#substArg"><span class="hs-identifier hs-var">substArg</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170556"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span class="annot"><a href="GHC.Stg.CSE.html#substArg"><span class="hs-identifier hs-type">substArg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#InStgArg"><span class="hs-identifier hs-type">InStgArg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#OutStgArg"><span class="hs-identifier hs-type">OutStgArg</span></a></span><span>
</span><span id="line-235"></span><span id="substArg"><span class="annot"><span class="annottext">substArg :: CseEnv -&gt; StgArg -&gt; StgArg
</span><a href="GHC.Stg.CSE.html#substArg"><span class="hs-identifier hs-var hs-var">substArg</span></a></span></span><span> </span><span id="local-6989586621681170554"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170554"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgVarArg"><span class="hs-identifier hs-type">StgVarArg</span></a></span><span> </span><span id="local-6989586621681170553"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170553"><span class="hs-identifier hs-var">from</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; StgArg
</span><a href="GHC.Stg.Syntax.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CseEnv -&gt; Id -&gt; Id
</span><a href="GHC.Stg.CSE.html#substVar"><span class="hs-identifier hs-var">substVar</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170554"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170553"><span class="hs-identifier hs-var">from</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span class="annot"><a href="GHC.Stg.CSE.html#substArg"><span class="hs-identifier hs-var">substArg</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgLitArg"><span class="hs-identifier hs-type">StgLitArg</span></a></span><span> </span><span id="local-6989586621681170551"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621681170551"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Literal -&gt; StgArg
</span><a href="GHC.Stg.Syntax.html#StgLitArg"><span class="hs-identifier hs-var">StgLitArg</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621681170551"><span class="hs-identifier hs-var">lit</span></a></span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span class="annot"><a href="GHC.Stg.CSE.html#substVar"><span class="hs-identifier hs-type">substVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span>
</span><span id="line-239"></span><span id="substVar"><span class="annot"><span class="annottext">substVar :: CseEnv -&gt; Id -&gt; Id
</span><a href="GHC.Stg.CSE.html#substVar"><span class="hs-identifier hs-var hs-var">substVar</span></a></span></span><span> </span><span id="local-6989586621681170549"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170549"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681170548"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170548"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a -&gt; a
</span><a href="../../base-4.16.4.0/src/Data-Maybe.html#fromMaybe"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170548"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. VarEnv a -&gt; Id -&gt; Maybe a
</span><a href="GHC.Types.Var.Env.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CseEnv -&gt; IdEnv Id
</span><a href="GHC.Stg.CSE.html#ce_subst"><span class="hs-identifier hs-var">ce_subst</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170549"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170548"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span class="hs-comment">-- Functions to enter binders</span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span class="hs-comment">-- This is much simpler than the equivalent code in GHC.Core.Subst:</span><span>
</span><span id="line-244"></span><span class="hs-comment">--  * We do not substitute type variables, and</span><span>
</span><span id="line-245"></span><span class="hs-comment">--  * There is nothing relevant in GHC.Types.Id.Info at this stage</span><span>
</span><span id="line-246"></span><span class="hs-comment">--    that needs substitutions.</span><span>
</span><span id="line-247"></span><span class="hs-comment">-- Therefore, no special treatment for a recursive group is required.</span><span>
</span><span id="line-248"></span><span>
</span><span id="line-249"></span><span class="annot"><a href="GHC.Stg.CSE.html#substBndr"><span class="hs-identifier hs-type">substBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#InId"><span class="hs-identifier hs-type">InId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span id="substBndr"><span class="annot"><span class="annottext">substBndr :: CseEnv -&gt; Id -&gt; (CseEnv, Id)
</span><a href="GHC.Stg.CSE.html#substBndr"><span class="hs-identifier hs-var hs-var">substBndr</span></a></span></span><span> </span><span id="local-6989586621681170546"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170546"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681170545"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170545"><span class="hs-identifier hs-var">old_id</span></a></span></span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170544"><span class="hs-identifier hs-var">new_env</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170543"><span class="hs-identifier hs-var">new_id</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-253"></span><span>    </span><span id="local-6989586621681170543"><span class="annot"><span class="annottext">new_id :: Id
</span><a href="#local-6989586621681170543"><span class="hs-identifier hs-var hs-var">new_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Id -&gt; Id
</span><a href="GHC.Types.Var.Env.html#uniqAway"><span class="hs-identifier hs-var">uniqAway</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CseEnv -&gt; InScopeSet
</span><a href="GHC.Stg.CSE.html#ce_in_scope"><span class="hs-identifier hs-var">ce_in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170546"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170545"><span class="hs-identifier hs-var">old_id</span></a></span><span>
</span><span id="line-254"></span><span>    </span><span id="local-6989586621681170541"><span class="annot"><span class="annottext">no_change :: Bool
</span><a href="#local-6989586621681170541"><span class="hs-identifier hs-var hs-var">no_change</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170543"><span class="hs-identifier hs-var">new_id</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170545"><span class="hs-identifier hs-var">old_id</span></a></span><span>
</span><span id="line-255"></span><span>    </span><span id="local-6989586621681170540"><span class="annot"><span class="annottext">env' :: CseEnv
</span><a href="#local-6989586621681170540"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170546"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ce_in_scope :: InScopeSet
</span><a href="GHC.Stg.CSE.html#ce_in_scope"><span class="hs-identifier hs-var">ce_in_scope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; InScopeSet
</span><a href="GHC.Stg.CSE.html#ce_in_scope"><span class="hs-identifier hs-var">ce_in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170546"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Id -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSet"><span class="hs-operator hs-var">`extendInScopeSet`</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170543"><span class="hs-identifier hs-var">new_id</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-256"></span><span>    </span><span id="local-6989586621681170544"><span class="annot"><span class="annottext">new_env :: CseEnv
</span><a href="#local-6989586621681170544"><span class="hs-identifier hs-var hs-var">new_env</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681170541"><span class="hs-identifier hs-var">no_change</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170540"><span class="hs-identifier hs-var">env'</span></a></span><span>
</span><span id="line-257"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170540"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ce_subst :: IdEnv Id
</span><a href="GHC.Stg.CSE.html#ce_subst"><span class="hs-identifier hs-var">ce_subst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. VarEnv a -&gt; Id -&gt; a -&gt; VarEnv a
</span><a href="GHC.Types.Var.Env.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CseEnv -&gt; IdEnv Id
</span><a href="GHC.Stg.CSE.html#ce_subst"><span class="hs-identifier hs-var">ce_subst</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170546"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170545"><span class="hs-identifier hs-var">old_id</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170543"><span class="hs-identifier hs-var">new_id</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span class="annot"><a href="GHC.Stg.CSE.html#substBndrs"><span class="hs-identifier hs-type">substBndrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span id="substBndrs"><span class="annot"><span class="annottext">substBndrs :: CseEnv -&gt; [Id] -&gt; (CseEnv, [Id])
</span><a href="GHC.Stg.CSE.html#substBndrs"><span class="hs-identifier hs-var hs-var">substBndrs</span></a></span></span><span> </span><span id="local-6989586621681170535"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170535"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681170534"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681170534"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><a href="../../base-4.16.4.0/src/Data-Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; Id -&gt; (CseEnv, Id)
</span><a href="GHC.Stg.CSE.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170535"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681170534"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span id="local-6989586621681170779"><span class="annot"><a href="GHC.Stg.CSE.html#substPairs"><span class="hs-identifier hs-type">substPairs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621681170779"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621681170779"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-263"></span><span id="substPairs"><span class="annot"><span class="annottext">substPairs :: forall a. CseEnv -&gt; [(Id, a)] -&gt; (CseEnv, [(Id, a)])
</span><a href="GHC.Stg.CSE.html#substPairs"><span class="hs-identifier hs-var hs-var">substPairs</span></a></span></span><span> </span><span id="local-6989586621681170531"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170531"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681170530"><span class="annot"><span class="annottext">[(Id, a)]
</span><a href="#local-6989586621681170530"><span class="hs-identifier hs-var">bndrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><a href="../../base-4.16.4.0/src/Data-Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a></span><span> </span><span class="annot"><span class="annottext">forall {b}. CseEnv -&gt; (Id, b) -&gt; (CseEnv, (Id, b))
</span><a href="#local-6989586621681170529"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170531"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, a)]
</span><a href="#local-6989586621681170530"><span class="hs-identifier hs-var">bndrs</span></a></span><span>
</span><span id="line-264"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681170529"><span class="annot"><span class="annottext">go :: CseEnv -&gt; (Id, b) -&gt; (CseEnv, (Id, b))
</span><a href="#local-6989586621681170529"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681170528"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170528"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681170527"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170527"><span class="hs-identifier hs-var">id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170526"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681170526"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681170525"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170525"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170524"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170524"><span class="hs-identifier hs-var">id'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; Id -&gt; (CseEnv, Id)
</span><a href="GHC.Stg.CSE.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170528"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170527"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-265"></span><span>                         </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170525"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170524"><span class="hs-identifier hs-var">id'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681170526"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span class="hs-comment">-- Main entry point</span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCse"><span class="hs-identifier hs-type">stgCse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Stg.Syntax.html#InStgTopBinding"><span class="hs-identifier hs-type">InStgTopBinding</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Stg.Syntax.html#OutStgTopBinding"><span class="hs-identifier hs-type">OutStgTopBinding</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-270"></span><span id="stgCse"><span class="annot"><span class="annottext">stgCse :: [InStgTopBinding] -&gt; [InStgTopBinding]
</span><a href="GHC.Stg.CSE.html#stgCse"><span class="hs-identifier hs-var hs-var">stgCse</span></a></span></span><span> </span><span id="local-6989586621681170522"><span class="annot"><span class="annottext">[InStgTopBinding]
</span><a href="#local-6989586621681170522"><span class="hs-identifier hs-var">binds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; b
</span><a href="../../base-4.16.4.0/src/Data-Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) s a b.
Traversable t =&gt;
(s -&gt; a -&gt; (s, b)) -&gt; s -&gt; t a -&gt; (s, t b)
</span><a href="../../base-4.16.4.0/src/Data-Traversable.html#mapAccumL"><span class="hs-identifier hs-var">mapAccumL</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; InStgTopBinding -&gt; (InScopeSet, InStgTopBinding)
</span><a href="GHC.Stg.CSE.html#stgCseTopLvl"><span class="hs-identifier hs-var">stgCseTopLvl</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="GHC.Types.Var.Env.html#emptyInScopeSet"><span class="hs-identifier hs-var">emptyInScopeSet</span></a></span><span> </span><span class="annot"><span class="annottext">[InStgTopBinding]
</span><a href="#local-6989586621681170522"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-271"></span><span>
</span><span id="line-272"></span><span class="hs-comment">-- Top level bindings.</span><span>
</span><span id="line-273"></span><span class="hs-comment">--</span><span>
</span><span id="line-274"></span><span class="hs-comment">-- We do not CSE these, as top-level closures are allocated statically anyways.</span><span>
</span><span id="line-275"></span><span class="hs-comment">-- Also, they might be exported.</span><span>
</span><span id="line-276"></span><span class="hs-comment">-- But we still have to collect the set of in-scope variables, otherwise</span><span>
</span><span id="line-277"></span><span class="hs-comment">-- uniqAway might shadow a top-level closure.</span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCseTopLvl"><span class="hs-identifier hs-type">stgCseTopLvl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#InStgTopBinding"><span class="hs-identifier hs-type">InStgTopBinding</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#OutStgTopBinding"><span class="hs-identifier hs-type">OutStgTopBinding</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span id="stgCseTopLvl"><span class="annot"><span class="annottext">stgCseTopLvl :: InScopeSet -&gt; InStgTopBinding -&gt; (InScopeSet, InStgTopBinding)
</span><a href="GHC.Stg.CSE.html#stgCseTopLvl"><span class="hs-identifier hs-var hs-var">stgCseTopLvl</span></a></span></span><span> </span><span id="local-6989586621681170519"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681170519"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span id="local-6989586621681170518"><span class="annot"><span class="annottext">t :: InStgTopBinding
</span><a href="#local-6989586621681170518"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgTopStringLit"><span class="hs-identifier hs-type">StgTopStringLit</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681170519"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InStgTopBinding
</span><a href="#local-6989586621681170518"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCseTopLvl"><span class="hs-identifier hs-var">stgCseTopLvl</span></a></span><span> </span><span id="local-6989586621681170516"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681170516"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgTopLifted"><span class="hs-identifier hs-type">StgTopLifted</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgNonRec"><span class="hs-identifier hs-type">StgNonRec</span></a></span><span> </span><span id="local-6989586621681170513"><span class="annot"><span class="annottext">BinderP 'Vanilla
</span><a href="#local-6989586621681170513"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621681170512"><span class="annot"><span class="annottext">GenStgRhs 'Vanilla
</span><a href="#local-6989586621681170512"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681170511"><span class="hs-identifier hs-var">in_scope'</span></a></span><span>
</span><span id="line-283"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall (pass :: StgPass).
GenStgBinding pass -&gt; GenStgTopBinding pass
</span><a href="GHC.Stg.Syntax.html#StgTopLifted"><span class="hs-identifier hs-var">StgTopLifted</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (pass :: StgPass).
BinderP pass -&gt; GenStgRhs pass -&gt; GenStgBinding pass
</span><a href="GHC.Stg.Syntax.html#StgNonRec"><span class="hs-identifier hs-var">StgNonRec</span></a></span><span> </span><span class="annot"><span class="annottext">BinderP 'Vanilla
</span><a href="#local-6989586621681170513"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; GenStgRhs 'Vanilla -&gt; GenStgRhs 'Vanilla
</span><a href="GHC.Stg.CSE.html#stgCseTopLvlRhs"><span class="hs-identifier hs-var">stgCseTopLvlRhs</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681170516"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgRhs 'Vanilla
</span><a href="#local-6989586621681170512"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681170511"><span class="annot"><span class="annottext">in_scope' :: InScopeSet
</span><a href="#local-6989586621681170511"><span class="hs-identifier hs-var hs-var">in_scope'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681170516"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; Id -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSet"><span class="hs-operator hs-var">`extendInScopeSet`</span></a></span><span> </span><span class="annot"><span class="annottext">BinderP 'Vanilla
</span><a href="#local-6989586621681170513"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-285"></span><span>
</span><span id="line-286"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCseTopLvl"><span class="hs-identifier hs-var">stgCseTopLvl</span></a></span><span> </span><span id="local-6989586621681170509"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681170509"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgTopLifted"><span class="hs-identifier hs-type">StgTopLifted</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgRec"><span class="hs-identifier hs-type">StgRec</span></a></span><span> </span><span id="local-6989586621681170507"><span class="annot"><span class="annottext">[(BinderP 'Vanilla, GenStgRhs 'Vanilla)]
</span><a href="#local-6989586621681170507"><span class="hs-identifier hs-var">eqs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681170506"><span class="hs-identifier hs-var">in_scope'</span></a></span><span>
</span><span id="line-288"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall (pass :: StgPass).
GenStgBinding pass -&gt; GenStgTopBinding pass
</span><a href="GHC.Stg.Syntax.html#StgTopLifted"><span class="hs-identifier hs-var">StgTopLifted</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (pass :: StgPass).
[(BinderP pass, GenStgRhs pass)] -&gt; GenStgBinding pass
</span><a href="GHC.Stg.Syntax.html#StgRec"><span class="hs-identifier hs-var">StgRec</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170505"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; GenStgRhs 'Vanilla -&gt; GenStgRhs 'Vanilla
</span><a href="GHC.Stg.CSE.html#stgCseTopLvlRhs"><span class="hs-identifier hs-var">stgCseTopLvlRhs</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681170506"><span class="hs-identifier hs-var">in_scope'</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgRhs 'Vanilla
</span><a href="#local-6989586621681170504"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681170505"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170505"><span class="hs-identifier hs-var">bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170504"><span class="annot"><span class="annottext">GenStgRhs 'Vanilla
</span><a href="#local-6989586621681170504"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(BinderP 'Vanilla, GenStgRhs 'Vanilla)]
</span><a href="#local-6989586621681170507"><span class="hs-identifier hs-var">eqs</span></a></span><span> </span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681170506"><span class="annot"><span class="annottext">in_scope' :: InScopeSet
</span><a href="#local-6989586621681170506"><span class="hs-identifier hs-var hs-var">in_scope'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681170509"><span class="hs-identifier hs-var">in_scope</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet -&gt; [Id] -&gt; InScopeSet
</span><a href="GHC.Types.Var.Env.html#extendInScopeSetList"><span class="hs-operator hs-var">`extendInScopeSetList`</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170502"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681170502"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170502"><span class="hs-identifier hs-var">bndr</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">GenStgRhs 'Vanilla
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(BinderP 'Vanilla, GenStgRhs 'Vanilla)]
</span><a href="#local-6989586621681170507"><span class="hs-identifier hs-var">eqs</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCseTopLvlRhs"><span class="hs-identifier hs-type">stgCseTopLvlRhs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.Env.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#InStgRhs"><span class="hs-identifier hs-type">InStgRhs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#OutStgRhs"><span class="hs-identifier hs-type">OutStgRhs</span></a></span><span>
</span><span id="line-292"></span><span id="stgCseTopLvlRhs"><span class="annot"><span class="annottext">stgCseTopLvlRhs :: InScopeSet -&gt; GenStgRhs 'Vanilla -&gt; GenStgRhs 'Vanilla
</span><a href="GHC.Stg.CSE.html#stgCseTopLvlRhs"><span class="hs-identifier hs-var hs-var">stgCseTopLvlRhs</span></a></span></span><span> </span><span id="local-6989586621681170499"><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681170499"><span class="hs-identifier hs-var">in_scope</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgRhsClosure"><span class="hs-identifier hs-type">StgRhsClosure</span></a></span><span> </span><span id="local-6989586621681170497"><span class="annot"><span class="annottext">XRhsClosure 'Vanilla
</span><a href="#local-6989586621681170497"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span id="local-6989586621681170496"><span class="annot"><span class="annottext">CostCentreStack
</span><a href="#local-6989586621681170496"><span class="hs-identifier hs-var">ccs</span></a></span></span><span> </span><span id="local-6989586621681170495"><span class="annot"><span class="annottext">UpdateFlag
</span><a href="#local-6989586621681170495"><span class="hs-identifier hs-var">upd</span></a></span></span><span> </span><span id="local-6989586621681170494"><span class="annot"><span class="annottext">[BinderP 'Vanilla]
</span><a href="#local-6989586621681170494"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621681170493"><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170493"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681170492"><span class="annot"><span class="annottext">body' :: GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170492"><span class="hs-identifier hs-var hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; GenStgExpr 'Vanilla -&gt; GenStgExpr 'Vanilla
</span><a href="GHC.Stg.CSE.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InScopeSet -&gt; CseEnv
</span><a href="GHC.Stg.CSE.html#initEnv"><span class="hs-identifier hs-var">initEnv</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><a href="#local-6989586621681170499"><span class="hs-identifier hs-var">in_scope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170493"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-294"></span><span>      </span><span class="hs-keyword">in</span><span>  </span><span class="annot"><span class="annottext">forall (pass :: StgPass).
XRhsClosure pass
-&gt; CostCentreStack
-&gt; UpdateFlag
-&gt; [BinderP pass]
-&gt; GenStgExpr pass
-&gt; GenStgRhs pass
</span><a href="GHC.Stg.Syntax.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a></span><span> </span><span class="annot"><span class="annottext">XRhsClosure 'Vanilla
</span><a href="#local-6989586621681170497"><span class="hs-identifier hs-var">ext</span></a></span><span> </span><span class="annot"><span class="annottext">CostCentreStack
</span><a href="#local-6989586621681170496"><span class="hs-identifier hs-var">ccs</span></a></span><span> </span><span class="annot"><span class="annottext">UpdateFlag
</span><a href="#local-6989586621681170495"><span class="hs-identifier hs-var">upd</span></a></span><span> </span><span class="annot"><span class="annottext">[BinderP 'Vanilla]
</span><a href="#local-6989586621681170494"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170492"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-295"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCseTopLvlRhs"><span class="hs-identifier hs-var">stgCseTopLvlRhs</span></a></span><span> </span><span class="annot"><span class="annottext">InScopeSet
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgRhsCon"><span class="hs-identifier hs-type">StgRhsCon</span></a></span><span> </span><span id="local-6989586621681170489"><span class="annot"><span class="annottext">CostCentreStack
</span><a href="#local-6989586621681170489"><span class="hs-identifier hs-var">ccs</span></a></span></span><span> </span><span id="local-6989586621681170488"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170488"><span class="hs-identifier hs-var">dataCon</span></a></span></span><span> </span><span id="local-6989586621681170487"><span class="annot"><span class="annottext">ConstructorNumber
</span><a href="#local-6989586621681170487"><span class="hs-identifier hs-var">mu</span></a></span></span><span> </span><span id="local-6989586621681170486"><span class="annot"><span class="annottext">[StgTickish]
</span><a href="#local-6989586621681170486"><span class="hs-identifier hs-var">ticks</span></a></span></span><span> </span><span id="local-6989586621681170485"><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170485"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (pass :: StgPass).
CostCentreStack
-&gt; DataCon
-&gt; ConstructorNumber
-&gt; [StgTickish]
-&gt; [StgArg]
-&gt; GenStgRhs pass
</span><a href="GHC.Stg.Syntax.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a></span><span> </span><span class="annot"><span class="annottext">CostCentreStack
</span><a href="#local-6989586621681170489"><span class="hs-identifier hs-var">ccs</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170488"><span class="hs-identifier hs-var">dataCon</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorNumber
</span><a href="#local-6989586621681170487"><span class="hs-identifier hs-var">mu</span></a></span><span> </span><span class="annot"><span class="annottext">[StgTickish]
</span><a href="#local-6989586621681170486"><span class="hs-identifier hs-var">ticks</span></a></span><span> </span><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170485"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span class="hs-comment">------------------------------</span><span>
</span><span id="line-299"></span><span class="hs-comment">-- The actual AST traversal --</span><span>
</span><span id="line-300"></span><span class="hs-comment">------------------------------</span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span class="hs-comment">-- Trivial cases</span><span>
</span><span id="line-303"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCseExpr"><span class="hs-identifier hs-type">stgCseExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#InStgExpr"><span class="hs-identifier hs-type">InStgExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#OutStgExpr"><span class="hs-identifier hs-type">OutStgExpr</span></a></span><span>
</span><span id="line-304"></span><span id="stgCseExpr"><span class="annot"><span class="annottext">stgCseExpr :: CseEnv -&gt; GenStgExpr 'Vanilla -&gt; GenStgExpr 'Vanilla
</span><a href="GHC.Stg.CSE.html#stgCseExpr"><span class="hs-identifier hs-var hs-var">stgCseExpr</span></a></span></span><span> </span><span id="local-6989586621681170482"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170482"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgApp"><span class="hs-identifier hs-type">StgApp</span></a></span><span> </span><span id="local-6989586621681170480"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170480"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span id="local-6989586621681170479"><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170479"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (pass :: StgPass). Id -&gt; [StgArg] -&gt; GenStgExpr pass
</span><a href="GHC.Stg.Syntax.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170478"><span class="hs-identifier hs-var">fun'</span></a></span><span> </span><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170477"><span class="hs-identifier hs-var">args'</span></a></span><span>
</span><span id="line-306"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681170478"><span class="annot"><span class="annottext">fun' :: Id
</span><a href="#local-6989586621681170478"><span class="hs-identifier hs-var hs-var">fun'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; Id -&gt; Id
</span><a href="GHC.Stg.CSE.html#substVar"><span class="hs-identifier hs-var">substVar</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170482"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170480"><span class="hs-identifier hs-var">fun</span></a></span><span>
</span><span id="line-307"></span><span>        </span><span id="local-6989586621681170477"><span class="annot"><span class="annottext">args' :: [StgArg]
</span><a href="#local-6989586621681170477"><span class="hs-identifier hs-var hs-var">args'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; [StgArg] -&gt; [StgArg]
</span><a href="GHC.Stg.CSE.html#substArgs"><span class="hs-identifier hs-var">substArgs</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170482"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170479"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-308"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgLit"><span class="hs-identifier hs-type">StgLit</span></a></span><span> </span><span id="local-6989586621681170475"><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621681170475"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (pass :: StgPass). Literal -&gt; GenStgExpr pass
</span><a href="GHC.Stg.Syntax.html#StgLit"><span class="hs-identifier hs-var">StgLit</span></a></span><span> </span><span class="annot"><span class="annottext">Literal
</span><a href="#local-6989586621681170475"><span class="hs-identifier hs-var">lit</span></a></span><span>
</span><span id="line-310"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a></span><span> </span><span id="local-6989586621681170474"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170474"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgOpApp"><span class="hs-identifier hs-type">StgOpApp</span></a></span><span> </span><span id="local-6989586621681170472"><span class="annot"><span class="annottext">StgOp
</span><a href="#local-6989586621681170472"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621681170471"><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170471"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621681170470"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681170470"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-311"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (pass :: StgPass).
StgOp -&gt; [StgArg] -&gt; Type -&gt; GenStgExpr pass
</span><a href="GHC.Stg.Syntax.html#StgOpApp"><span class="hs-identifier hs-var">StgOpApp</span></a></span><span> </span><span class="annot"><span class="annottext">StgOp
</span><a href="#local-6989586621681170472"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170469"><span class="hs-identifier hs-var">args'</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621681170470"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-312"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681170469"><span class="annot"><span class="annottext">args' :: [StgArg]
</span><a href="#local-6989586621681170469"><span class="hs-identifier hs-var hs-var">args'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; [StgArg] -&gt; [StgArg]
</span><a href="GHC.Stg.CSE.html#substArgs"><span class="hs-identifier hs-var">substArgs</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170474"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170471"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-313"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a></span><span> </span><span id="local-6989586621681170468"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170468"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgTick"><span class="hs-identifier hs-type">StgTick</span></a></span><span> </span><span id="local-6989586621681170466"><span class="annot"><span class="annottext">StgTickish
</span><a href="#local-6989586621681170466"><span class="hs-identifier hs-var">tick</span></a></span></span><span> </span><span id="local-6989586621681170465"><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170465"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681170464"><span class="annot"><span class="annottext">body' :: GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170464"><span class="hs-identifier hs-var hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; GenStgExpr 'Vanilla -&gt; GenStgExpr 'Vanilla
</span><a href="GHC.Stg.CSE.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170468"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170465"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-315"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (pass :: StgPass).
StgTickish -&gt; GenStgExpr pass -&gt; GenStgExpr pass
</span><a href="GHC.Stg.Syntax.html#StgTick"><span class="hs-identifier hs-var">StgTick</span></a></span><span> </span><span class="annot"><span class="annottext">StgTickish
</span><a href="#local-6989586621681170466"><span class="hs-identifier hs-var">tick</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170464"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-316"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a></span><span> </span><span id="local-6989586621681170463"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170463"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgCase"><span class="hs-identifier hs-type">StgCase</span></a></span><span> </span><span id="local-6989586621681170461"><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170461"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621681170460"><span class="annot"><span class="annottext">BinderP 'Vanilla
</span><a href="#local-6989586621681170460"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621681170459"><span class="annot"><span class="annottext">AltType
</span><a href="#local-6989586621681170459"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681170458"><span class="annot"><span class="annottext">[GenStgAlt 'Vanilla]
</span><a href="#local-6989586621681170458"><span class="hs-identifier hs-var">alts</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
-&gt; Id -&gt; AltType -&gt; [GenStgAlt 'Vanilla] -&gt; GenStgExpr 'Vanilla
</span><a href="GHC.Stg.CSE.html#mkStgCase"><span class="hs-identifier hs-var">mkStgCase</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170456"><span class="hs-identifier hs-var">scrut'</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170455"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="annot"><span class="annottext">AltType
</span><a href="#local-6989586621681170459"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">[(AltCon, [Id], GenStgExpr 'Vanilla)]
</span><a href="#local-6989586621681170454"><span class="hs-identifier hs-var">alts'</span></a></span><span>
</span><span id="line-318"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-319"></span><span>    </span><span id="local-6989586621681170456"><span class="annot"><span class="annottext">scrut' :: GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170456"><span class="hs-identifier hs-var hs-var">scrut'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; GenStgExpr 'Vanilla -&gt; GenStgExpr 'Vanilla
</span><a href="GHC.Stg.CSE.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170463"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170461"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681170453"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170453"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170455"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170455"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; Id -&gt; (CseEnv, Id)
</span><a href="GHC.Stg.CSE.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170463"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">BinderP 'Vanilla
</span><a href="#local-6989586621681170460"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-321"></span><span>    </span><span id="local-6989586621681170452"><span class="annot"><span class="annottext">env2 :: CseEnv
</span><a href="#local-6989586621681170452"><span class="hs-identifier hs-var hs-var">env2</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#StgApp"><span class="hs-identifier hs-type">StgApp</span></a></span><span> </span><span id="local-6989586621681170451"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170451"><span class="hs-identifier hs-var">trivial_scrut</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170456"><span class="hs-identifier hs-var">scrut'</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id -&gt; CseEnv -&gt; CseEnv
</span><a href="GHC.Stg.CSE.html#addTrivCaseBndr"><span class="hs-identifier hs-var">addTrivCaseBndr</span></a></span><span> </span><span class="annot"><span class="annottext">BinderP 'Vanilla
</span><a href="#local-6989586621681170460"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170451"><span class="hs-identifier hs-var">trivial_scrut</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170453"><span class="hs-identifier hs-var">env1</span></a></span><span>
</span><span id="line-322"></span><span>                 </span><span class="hs-comment">-- See Note [Trivial case scrutinee]</span><span>
</span><span id="line-323"></span><span>         </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170453"><span class="hs-identifier hs-var">env1</span></a></span><span>
</span><span id="line-324"></span><span>    </span><span id="local-6989586621681170454"><span class="annot"><span class="annottext">alts' :: [(AltCon, [Id], GenStgExpr 'Vanilla)]
</span><a href="#local-6989586621681170454"><span class="hs-identifier hs-var hs-var">alts'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CseEnv -&gt; AltType -&gt; Id -&gt; GenStgAlt 'Vanilla -&gt; GenStgAlt 'Vanilla
</span><a href="GHC.Stg.CSE.html#stgCseAlt"><span class="hs-identifier hs-var">stgCseAlt</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170452"><span class="hs-identifier hs-var">env2</span></a></span><span> </span><span class="annot"><span class="annottext">AltType
</span><a href="#local-6989586621681170459"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170455"><span class="hs-identifier hs-var">bndr'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[GenStgAlt 'Vanilla]
</span><a href="#local-6989586621681170458"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-325"></span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span class="hs-comment">-- A constructor application.</span><span>
</span><span id="line-328"></span><span class="hs-comment">-- To be removed by a variable use when found in the CSE environment</span><span>
</span><span id="line-329"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a></span><span> </span><span id="local-6989586621681170449"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170449"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgConApp"><span class="hs-identifier hs-type">StgConApp</span></a></span><span> </span><span id="local-6989586621681170447"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170447"><span class="hs-identifier hs-var">dataCon</span></a></span></span><span> </span><span id="local-6989586621681170446"><span class="annot"><span class="annottext">XConApp 'Vanilla
</span><a href="#local-6989586621681170446"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681170445"><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170445"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621681170444"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681170444"><span class="hs-identifier hs-var">tys</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-330"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681170443"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170443"><span class="hs-identifier hs-var">bndr'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [StgArg] -&gt; CseEnv -&gt; Maybe Id
</span><a href="GHC.Stg.CSE.html#envLookup"><span class="hs-identifier hs-var">envLookup</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170447"><span class="hs-identifier hs-var">dataCon</span></a></span><span> </span><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170442"><span class="hs-identifier hs-var">args'</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170449"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-331"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (pass :: StgPass). Id -&gt; [StgArg] -&gt; GenStgExpr pass
</span><a href="GHC.Stg.Syntax.html#StgApp"><span class="hs-identifier hs-var">StgApp</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170443"><span class="hs-identifier hs-var">bndr'</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-332"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-333"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (pass :: StgPass).
DataCon -&gt; XConApp pass -&gt; [StgArg] -&gt; [Type] -&gt; GenStgExpr pass
</span><a href="GHC.Stg.Syntax.html#StgConApp"><span class="hs-identifier hs-var">StgConApp</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170447"><span class="hs-identifier hs-var">dataCon</span></a></span><span> </span><span class="annot"><span class="annottext">XConApp 'Vanilla
</span><a href="#local-6989586621681170446"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170442"><span class="hs-identifier hs-var">args'</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621681170444"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-334"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681170442"><span class="annot"><span class="annottext">args' :: [StgArg]
</span><a href="#local-6989586621681170442"><span class="hs-identifier hs-var hs-var">args'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; [StgArg] -&gt; [StgArg]
</span><a href="GHC.Stg.CSE.html#substArgs"><span class="hs-identifier hs-var">substArgs</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170449"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170445"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-335"></span><span>
</span><span id="line-336"></span><span class="hs-comment">-- Let bindings</span><span>
</span><span id="line-337"></span><span class="hs-comment">-- The binding might be removed due to CSE (we do not want trivial bindings on</span><span>
</span><span id="line-338"></span><span class="hs-comment">-- the STG level), so use the smart constructor `mkStgLet` to remove the binding</span><span>
</span><span id="line-339"></span><span class="hs-comment">-- if empty.</span><span>
</span><span id="line-340"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a></span><span> </span><span id="local-6989586621681170441"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170441"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgLet"><span class="hs-identifier hs-type">StgLet</span></a></span><span> </span><span id="local-6989586621681170439"><span class="annot"><span class="annottext">XLet 'Vanilla
</span><a href="#local-6989586621681170439"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span id="local-6989586621681170438"><span class="annot"><span class="annottext">GenStgBinding 'Vanilla
</span><a href="#local-6989586621681170438"><span class="hs-identifier hs-var">binds</span></a></span></span><span> </span><span id="local-6989586621681170437"><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170437"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681170436"><span class="annot"><span class="annottext">Maybe (GenStgBinding 'Vanilla)
</span><a href="#local-6989586621681170436"><span class="hs-identifier hs-var">binds'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170435"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170435"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv
-&gt; GenStgBinding 'Vanilla
-&gt; (Maybe (GenStgBinding 'Vanilla), CseEnv)
</span><a href="GHC.Stg.CSE.html#stgCseBind"><span class="hs-identifier hs-var">stgCseBind</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170441"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgBinding 'Vanilla
</span><a href="#local-6989586621681170438"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-342"></span><span>          </span><span id="local-6989586621681170433"><span class="annot"><span class="annottext">body' :: GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170433"><span class="hs-identifier hs-var hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; GenStgExpr 'Vanilla -&gt; GenStgExpr 'Vanilla
</span><a href="GHC.Stg.CSE.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170435"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170437"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-343"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b -&gt; b) -&gt; Maybe a -&gt; b -&gt; b
</span><a href="GHC.Stg.CSE.html#mkStgLet"><span class="hs-identifier hs-var">mkStgLet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (pass :: StgPass).
XLet pass
-&gt; GenStgBinding pass -&gt; GenStgExpr pass -&gt; GenStgExpr pass
</span><a href="GHC.Stg.Syntax.html#StgLet"><span class="hs-identifier hs-var">StgLet</span></a></span><span> </span><span class="annot"><span class="annottext">XLet 'Vanilla
</span><a href="#local-6989586621681170439"><span class="hs-identifier hs-var">ext</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (GenStgBinding 'Vanilla)
</span><a href="#local-6989586621681170436"><span class="hs-identifier hs-var">binds'</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170433"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-344"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a></span><span> </span><span id="local-6989586621681170431"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170431"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgLetNoEscape"><span class="hs-identifier hs-type">StgLetNoEscape</span></a></span><span> </span><span id="local-6989586621681170429"><span class="annot"><span class="annottext">XLetNoEscape 'Vanilla
</span><a href="#local-6989586621681170429"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span id="local-6989586621681170428"><span class="annot"><span class="annottext">GenStgBinding 'Vanilla
</span><a href="#local-6989586621681170428"><span class="hs-identifier hs-var">binds</span></a></span></span><span> </span><span id="local-6989586621681170427"><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170427"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-345"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681170426"><span class="annot"><span class="annottext">Maybe (GenStgBinding 'Vanilla)
</span><a href="#local-6989586621681170426"><span class="hs-identifier hs-var">binds'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170425"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170425"><span class="hs-identifier hs-var">env'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv
-&gt; GenStgBinding 'Vanilla
-&gt; (Maybe (GenStgBinding 'Vanilla), CseEnv)
</span><a href="GHC.Stg.CSE.html#stgCseBind"><span class="hs-identifier hs-var">stgCseBind</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170431"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgBinding 'Vanilla
</span><a href="#local-6989586621681170428"><span class="hs-identifier hs-var">binds</span></a></span><span>
</span><span id="line-346"></span><span>          </span><span id="local-6989586621681170424"><span class="annot"><span class="annottext">body' :: GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170424"><span class="hs-identifier hs-var hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; GenStgExpr 'Vanilla -&gt; GenStgExpr 'Vanilla
</span><a href="GHC.Stg.CSE.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170425"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170427"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-347"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b -&gt; b) -&gt; Maybe a -&gt; b -&gt; b
</span><a href="GHC.Stg.CSE.html#mkStgLet"><span class="hs-identifier hs-var">mkStgLet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (pass :: StgPass).
XLetNoEscape pass
-&gt; GenStgBinding pass -&gt; GenStgExpr pass -&gt; GenStgExpr pass
</span><a href="GHC.Stg.Syntax.html#StgLetNoEscape"><span class="hs-identifier hs-var">StgLetNoEscape</span></a></span><span> </span><span class="annot"><span class="annottext">XLetNoEscape 'Vanilla
</span><a href="#local-6989586621681170429"><span class="hs-identifier hs-var">ext</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (GenStgBinding 'Vanilla)
</span><a href="#local-6989586621681170426"><span class="hs-identifier hs-var">binds'</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170424"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-348"></span><span>
</span><span id="line-349"></span><span class="hs-comment">-- Case alternatives</span><span>
</span><span id="line-350"></span><span class="hs-comment">-- Extend the CSE environment</span><span>
</span><span id="line-351"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCseAlt"><span class="hs-identifier hs-type">stgCseAlt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#AltType"><span class="hs-identifier hs-type">AltType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#InStgAlt"><span class="hs-identifier hs-type">InStgAlt</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#OutStgAlt"><span class="hs-identifier hs-type">OutStgAlt</span></a></span><span>
</span><span id="line-352"></span><span id="stgCseAlt"><span class="annot"><span class="annottext">stgCseAlt :: CseEnv -&gt; AltType -&gt; Id -&gt; GenStgAlt 'Vanilla -&gt; GenStgAlt 'Vanilla
</span><a href="GHC.Stg.CSE.html#stgCseAlt"><span class="hs-identifier hs-var hs-var">stgCseAlt</span></a></span></span><span> </span><span id="local-6989586621681170421"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170421"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681170420"><span class="annot"><span class="annottext">AltType
</span><a href="#local-6989586621681170420"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681170419"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170419"><span class="hs-identifier hs-var">case_bndr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-type">DataAlt</span></a></span><span> </span><span id="local-6989586621681170417"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170417"><span class="hs-identifier hs-var">dataCon</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170416"><span class="annot"><span class="annottext">[BinderP 'Vanilla]
</span><a href="#local-6989586621681170416"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170415"><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170415"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681170414"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170414"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170413"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681170413"><span class="hs-identifier hs-var">args'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; [Id] -&gt; (CseEnv, [Id])
</span><a href="GHC.Stg.CSE.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170421"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[BinderP 'Vanilla]
</span><a href="#local-6989586621681170416"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-354"></span><span>          </span><span id="local-6989586621681170412"><span class="annot"><span class="annottext">env2 :: CseEnv
</span><a href="#local-6989586621681170412"><span class="hs-identifier hs-var hs-var">env2</span></a></span></span><span>
</span><span id="line-355"></span><span>            </span><span class="hs-comment">-- To avoid dealing with unboxed sums StgCse runs after unarise and</span><span>
</span><span id="line-356"></span><span>            </span><span class="hs-comment">-- should maintain invariants listed in Note [Post-unarisation</span><span>
</span><span id="line-357"></span><span>            </span><span class="hs-comment">-- invariants]. One of the invariants is that some binders are not</span><span>
</span><span id="line-358"></span><span>            </span><span class="hs-comment">-- used (unboxed tuple case binders) which is what we check with</span><span>
</span><span id="line-359"></span><span>            </span><span class="hs-comment">-- `stgCaseBndrInScope` here. If the case binder is not in scope we</span><span>
</span><span id="line-360"></span><span>            </span><span class="hs-comment">-- don't add it to the CSE env. See also #15300.</span><span>
</span><span id="line-361"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">AltType -&gt; Bool -&gt; Bool
</span><a href="GHC.Stg.Syntax.html#stgCaseBndrInScope"><span class="hs-identifier hs-var">stgCaseBndrInScope</span></a></span><span> </span><span class="annot"><span class="annottext">AltType
</span><a href="#local-6989586621681170420"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- CSE runs after unarise</span><span>
</span><span id="line-362"></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; DataCon -&gt; [StgArg] -&gt; CseEnv -&gt; CseEnv
</span><a href="GHC.Stg.CSE.html#addDataCon"><span class="hs-identifier hs-var">addDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170419"><span class="hs-identifier hs-var">case_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170417"><span class="hs-identifier hs-var">dataCon</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; StgArg
</span><a href="GHC.Stg.Syntax.html#StgVarArg"><span class="hs-identifier hs-var">StgVarArg</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681170413"><span class="hs-identifier hs-var">args'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170414"><span class="hs-identifier hs-var">env1</span></a></span><span>
</span><span id="line-363"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-364"></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170414"><span class="hs-identifier hs-var">env1</span></a></span><span>
</span><span id="line-365"></span><span>            </span><span class="hs-comment">-- see note [Case 2: CSEing case binders]</span><span>
</span><span id="line-366"></span><span>          </span><span id="local-6989586621681170410"><span class="annot"><span class="annottext">rhs' :: GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170410"><span class="hs-identifier hs-var hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; GenStgExpr 'Vanilla -&gt; GenStgExpr 'Vanilla
</span><a href="GHC.Stg.CSE.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170412"><span class="hs-identifier hs-var">env2</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170415"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-367"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataCon -&gt; AltCon
</span><a href="GHC.Core.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170417"><span class="hs-identifier hs-var">dataCon</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681170413"><span class="hs-identifier hs-var">args'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170410"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-368"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCseAlt"><span class="hs-identifier hs-var">stgCseAlt</span></a></span><span> </span><span id="local-6989586621681170409"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170409"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="annot"><span class="annottext">AltType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681170408"><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681170408"><span class="hs-identifier hs-var">altCon</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170407"><span class="annot"><span class="annottext">[BinderP 'Vanilla]
</span><a href="#local-6989586621681170407"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170406"><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170406"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-369"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681170405"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170405"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170404"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681170404"><span class="hs-identifier hs-var">args'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; [Id] -&gt; (CseEnv, [Id])
</span><a href="GHC.Stg.CSE.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170409"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[BinderP 'Vanilla]
</span><a href="#local-6989586621681170407"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-370"></span><span>          </span><span id="local-6989586621681170403"><span class="annot"><span class="annottext">rhs' :: GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170403"><span class="hs-identifier hs-var hs-var">rhs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; GenStgExpr 'Vanilla -&gt; GenStgExpr 'Vanilla
</span><a href="GHC.Stg.CSE.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170405"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170406"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-371"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AltCon
</span><a href="#local-6989586621681170408"><span class="hs-identifier hs-var">altCon</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681170404"><span class="hs-identifier hs-var">args'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170403"><span class="hs-identifier hs-var">rhs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span>
</span><span id="line-373"></span><span class="hs-comment">-- Bindings</span><span>
</span><span id="line-374"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCseBind"><span class="hs-identifier hs-type">stgCseBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#InStgBinding"><span class="hs-identifier hs-type">InStgBinding</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#OutStgBinding"><span class="hs-identifier hs-type">OutStgBinding</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span id="stgCseBind"><span class="annot"><span class="annottext">stgCseBind :: CseEnv
-&gt; GenStgBinding 'Vanilla
-&gt; (Maybe (GenStgBinding 'Vanilla), CseEnv)
</span><a href="GHC.Stg.CSE.html#stgCseBind"><span class="hs-identifier hs-var hs-var">stgCseBind</span></a></span></span><span> </span><span id="local-6989586621681170400"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170400"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgNonRec"><span class="hs-identifier hs-type">StgNonRec</span></a></span><span> </span><span id="local-6989586621681170399"><span class="annot"><span class="annottext">BinderP 'Vanilla
</span><a href="#local-6989586621681170399"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621681170398"><span class="annot"><span class="annottext">GenStgRhs 'Vanilla
</span><a href="#local-6989586621681170398"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-376"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681170397"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170397"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170396"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170396"><span class="hs-identifier hs-var">b'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; Id -&gt; (CseEnv, Id)
</span><a href="GHC.Stg.CSE.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170400"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">BinderP 'Vanilla
</span><a href="#local-6989586621681170399"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-377"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CseEnv
-&gt; Id
-&gt; GenStgRhs 'Vanilla
-&gt; (Maybe (Id, GenStgRhs 'Vanilla), CseEnv)
</span><a href="GHC.Stg.CSE.html#stgCseRhs"><span class="hs-identifier hs-var">stgCseRhs</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170397"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170396"><span class="hs-identifier hs-var">b'</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgRhs 'Vanilla
</span><a href="#local-6989586621681170398"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-378"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Id, GenStgRhs 'Vanilla)
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span>      </span><span id="local-6989586621681170394"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170394"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span>                </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170394"><span class="hs-identifier hs-var">env2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-379"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681170393"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170393"><span class="hs-identifier hs-var">b2</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681170392"><span class="annot"><span class="annottext">GenStgRhs 'Vanilla
</span><a href="#local-6989586621681170392"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170391"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170391"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (pass :: StgPass).
BinderP pass -&gt; GenStgRhs pass -&gt; GenStgBinding pass
</span><a href="GHC.Stg.Syntax.html#StgNonRec"><span class="hs-identifier hs-var">StgNonRec</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170393"><span class="hs-identifier hs-var">b2</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgRhs 'Vanilla
</span><a href="#local-6989586621681170392"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170391"><span class="hs-identifier hs-var">env2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCseBind"><span class="hs-identifier hs-var">stgCseBind</span></a></span><span> </span><span id="local-6989586621681170390"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170390"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgRec"><span class="hs-identifier hs-type">StgRec</span></a></span><span> </span><span id="local-6989586621681170389"><span class="annot"><span class="annottext">[(BinderP 'Vanilla, GenStgRhs 'Vanilla)]
</span><a href="#local-6989586621681170389"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-381"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681170388"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170388"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170387"><span class="annot"><span class="annottext">[(Id, GenStgRhs 'Vanilla)]
</span><a href="#local-6989586621681170387"><span class="hs-identifier hs-var">pairs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. CseEnv -&gt; [(Id, a)] -&gt; (CseEnv, [(Id, a)])
</span><a href="GHC.Stg.CSE.html#substPairs"><span class="hs-identifier hs-var">substPairs</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170390"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[(BinderP 'Vanilla, GenStgRhs 'Vanilla)]
</span><a href="#local-6989586621681170389"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-382"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CseEnv
-&gt; [(Id, GenStgRhs 'Vanilla)]
-&gt; ([(Id, GenStgRhs 'Vanilla)], CseEnv)
</span><a href="GHC.Stg.CSE.html#stgCsePairs"><span class="hs-identifier hs-var">stgCsePairs</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170388"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, GenStgRhs 'Vanilla)]
</span><a href="#local-6989586621681170387"><span class="hs-identifier hs-var">pairs1</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-383"></span><span>        </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>     </span><span id="local-6989586621681170385"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170385"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170385"><span class="hs-identifier hs-var">env2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-384"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621681170384"><span class="annot"><span class="annottext">[(Id, GenStgRhs 'Vanilla)]
</span><a href="#local-6989586621681170384"><span class="hs-identifier hs-var">pairs2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170383"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170383"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (pass :: StgPass).
[(BinderP pass, GenStgRhs pass)] -&gt; GenStgBinding pass
</span><a href="GHC.Stg.Syntax.html#StgRec"><span class="hs-identifier hs-var">StgRec</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, GenStgRhs 'Vanilla)]
</span><a href="#local-6989586621681170384"><span class="hs-identifier hs-var">pairs2</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170383"><span class="hs-identifier hs-var">env2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-385"></span><span>
</span><span id="line-386"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCsePairs"><span class="hs-identifier hs-type">stgCsePairs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#InStgRhs"><span class="hs-identifier hs-type">InStgRhs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#OutStgRhs"><span class="hs-identifier hs-type">OutStgRhs</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-387"></span><span id="stgCsePairs"><span class="annot"><span class="annottext">stgCsePairs :: CseEnv
-&gt; [(Id, GenStgRhs 'Vanilla)]
-&gt; ([(Id, GenStgRhs 'Vanilla)], CseEnv)
</span><a href="GHC.Stg.CSE.html#stgCsePairs"><span class="hs-identifier hs-var hs-var">stgCsePairs</span></a></span></span><span> </span><span id="local-6989586621681170382"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170382"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170382"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCsePairs"><span class="hs-identifier hs-var">stgCsePairs</span></a></span><span> </span><span id="local-6989586621681170381"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170381"><span class="hs-identifier hs-var">env0</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621681170380"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170380"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681170379"><span class="annot"><span class="annottext">GenStgRhs 'Vanilla
</span><a href="#local-6989586621681170379"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681170378"><span class="annot"><span class="annottext">[(Id, GenStgRhs 'Vanilla)]
</span><a href="#local-6989586621681170378"><span class="hs-identifier hs-var">pairs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-389"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681170377"><span class="annot"><span class="annottext">Maybe (Id, GenStgRhs 'Vanilla)
</span><a href="#local-6989586621681170377"><span class="hs-identifier hs-var">pairMB</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170376"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170376"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv
-&gt; Id
-&gt; GenStgRhs 'Vanilla
-&gt; (Maybe (Id, GenStgRhs 'Vanilla), CseEnv)
</span><a href="GHC.Stg.CSE.html#stgCseRhs"><span class="hs-identifier hs-var">stgCseRhs</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170381"><span class="hs-identifier hs-var">env0</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170380"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgRhs 'Vanilla
</span><a href="#local-6989586621681170379"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-390"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621681170375"><span class="annot"><span class="annottext">[(Id, GenStgRhs 'Vanilla)]
</span><a href="#local-6989586621681170375"><span class="hs-identifier hs-var">pairs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170374"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170374"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv
-&gt; [(Id, GenStgRhs 'Vanilla)]
-&gt; ([(Id, GenStgRhs 'Vanilla)], CseEnv)
</span><a href="GHC.Stg.CSE.html#stgCsePairs"><span class="hs-identifier hs-var">stgCsePairs</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170376"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, GenStgRhs 'Vanilla)]
</span><a href="#local-6989586621681170378"><span class="hs-identifier hs-var">pairs</span></a></span><span>
</span><span id="line-391"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Id, GenStgRhs 'Vanilla)
</span><a href="#local-6989586621681170377"><span class="hs-identifier hs-var">pairMB</span></a></span><span> </span><span class="annot"><span class="annottext">forall {a}. Maybe a -&gt; [a] -&gt; [a]
</span><a href="#local-6989586621681170373"><span class="hs-operator hs-var">`mbCons`</span></a></span><span> </span><span class="annot"><span class="annottext">[(Id, GenStgRhs 'Vanilla)]
</span><a href="#local-6989586621681170375"><span class="hs-identifier hs-var">pairs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170374"><span class="hs-identifier hs-var">env2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-392"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-393"></span><span>    </span><span id="local-6989586621681170373"><span class="annot"><span class="annottext">mbCons :: Maybe a -&gt; [a] -&gt; [a]
</span><a href="#local-6989586621681170373"><span class="hs-identifier hs-var hs-var">mbCons</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../../base-4.16.4.0/src/Data-Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#id"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span class="hs-comment">-- The RHS of a binding.</span><span>
</span><span id="line-396"></span><span class="hs-comment">-- If it is a constructor application, either short-cut it or extend the environment</span><span>
</span><span id="line-397"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCseRhs"><span class="hs-identifier hs-type">stgCseRhs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#InStgRhs"><span class="hs-identifier hs-type">InStgRhs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#OutStgRhs"><span class="hs-identifier hs-type">OutStgRhs</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Stg.CSE.html#CseEnv"><span class="hs-identifier hs-type">CseEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-398"></span><span id="stgCseRhs"><span class="annot"><span class="annottext">stgCseRhs :: CseEnv
-&gt; Id
-&gt; GenStgRhs 'Vanilla
-&gt; (Maybe (Id, GenStgRhs 'Vanilla), CseEnv)
</span><a href="GHC.Stg.CSE.html#stgCseRhs"><span class="hs-identifier hs-var hs-var">stgCseRhs</span></a></span></span><span> </span><span id="local-6989586621681170370"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170370"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681170369"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170369"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgRhsCon"><span class="hs-identifier hs-type">StgRhsCon</span></a></span><span> </span><span id="local-6989586621681170368"><span class="annot"><span class="annottext">CostCentreStack
</span><a href="#local-6989586621681170368"><span class="hs-identifier hs-var">ccs</span></a></span></span><span> </span><span id="local-6989586621681170367"><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170367"><span class="hs-identifier hs-var">dataCon</span></a></span></span><span> </span><span id="local-6989586621681170366"><span class="annot"><span class="annottext">ConstructorNumber
</span><a href="#local-6989586621681170366"><span class="hs-identifier hs-var">mu</span></a></span></span><span> </span><span id="local-6989586621681170365"><span class="annot"><span class="annottext">[StgTickish]
</span><a href="#local-6989586621681170365"><span class="hs-identifier hs-var">ticks</span></a></span></span><span> </span><span id="local-6989586621681170364"><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170364"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-399"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681170363"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170363"><span class="hs-identifier hs-var">other_bndr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DataCon -&gt; [StgArg] -&gt; CseEnv -&gt; Maybe Id
</span><a href="GHC.Stg.CSE.html#envLookup"><span class="hs-identifier hs-var">envLookup</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170367"><span class="hs-identifier hs-var">dataCon</span></a></span><span> </span><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170362"><span class="hs-identifier hs-var">args'</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170370"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-400"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OccInfo -&gt; Bool
</span><a href="GHC.Types.Basic.html#isWeakLoopBreaker"><span class="hs-identifier hs-var">isWeakLoopBreaker</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; OccInfo
</span><a href="GHC.Types.Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170369"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [Care with loop breakers]</span><span>
</span><span id="line-401"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681170359"><span class="annot"><span class="annottext">env' :: CseEnv
</span><a href="#local-6989586621681170359"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id -&gt; CseEnv -&gt; CseEnv
</span><a href="GHC.Stg.CSE.html#addSubst"><span class="hs-identifier hs-var">addSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170369"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170363"><span class="hs-identifier hs-var">other_bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170370"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-402"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170359"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-403"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-404"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681170358"><span class="annot"><span class="annottext">env' :: CseEnv
</span><a href="#local-6989586621681170358"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id -&gt; DataCon -&gt; [StgArg] -&gt; CseEnv -&gt; CseEnv
</span><a href="GHC.Stg.CSE.html#addDataCon"><span class="hs-identifier hs-var">addDataCon</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170369"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170367"><span class="hs-identifier hs-var">dataCon</span></a></span><span> </span><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170362"><span class="hs-identifier hs-var">args'</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170370"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-405"></span><span>            </span><span class="hs-comment">-- see note [Case 1: CSEing allocated closures]</span><span>
</span><span id="line-406"></span><span>          </span><span id="local-6989586621681170357"><span class="annot"><span class="annottext">pair :: (Id, GenStgRhs 'Vanilla)
</span><a href="#local-6989586621681170357"><span class="hs-identifier hs-var hs-var">pair</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170369"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall (pass :: StgPass).
CostCentreStack
-&gt; DataCon
-&gt; ConstructorNumber
-&gt; [StgTickish]
-&gt; [StgArg]
-&gt; GenStgRhs pass
</span><a href="GHC.Stg.Syntax.html#StgRhsCon"><span class="hs-identifier hs-var">StgRhsCon</span></a></span><span> </span><span class="annot"><span class="annottext">CostCentreStack
</span><a href="#local-6989586621681170368"><span class="hs-identifier hs-var">ccs</span></a></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><a href="#local-6989586621681170367"><span class="hs-identifier hs-var">dataCon</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorNumber
</span><a href="#local-6989586621681170366"><span class="hs-identifier hs-var">mu</span></a></span><span> </span><span class="annot"><span class="annottext">[StgTickish]
</span><a href="#local-6989586621681170365"><span class="hs-identifier hs-var">ticks</span></a></span><span> </span><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170362"><span class="hs-identifier hs-var">args'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Id, GenStgRhs 'Vanilla)
</span><a href="#local-6989586621681170357"><span class="hs-identifier hs-var">pair</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170358"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681170362"><span class="annot"><span class="annottext">args' :: [StgArg]
</span><a href="#local-6989586621681170362"><span class="hs-identifier hs-var hs-var">args'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; [StgArg] -&gt; [StgArg]
</span><a href="GHC.Stg.CSE.html#substArgs"><span class="hs-identifier hs-var">substArgs</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170370"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[StgArg]
</span><a href="#local-6989586621681170364"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-409"></span><span>
</span><span id="line-410"></span><span class="annot"><a href="GHC.Stg.CSE.html#stgCseRhs"><span class="hs-identifier hs-var">stgCseRhs</span></a></span><span> </span><span id="local-6989586621681170356"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170356"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621681170355"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170355"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgRhsClosure"><span class="hs-identifier hs-type">StgRhsClosure</span></a></span><span> </span><span id="local-6989586621681170354"><span class="annot"><span class="annottext">XRhsClosure 'Vanilla
</span><a href="#local-6989586621681170354"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span id="local-6989586621681170353"><span class="annot"><span class="annottext">CostCentreStack
</span><a href="#local-6989586621681170353"><span class="hs-identifier hs-var">ccs</span></a></span></span><span> </span><span id="local-6989586621681170352"><span class="annot"><span class="annottext">UpdateFlag
</span><a href="#local-6989586621681170352"><span class="hs-identifier hs-var">upd</span></a></span></span><span> </span><span id="local-6989586621681170351"><span class="annot"><span class="annottext">[BinderP 'Vanilla]
</span><a href="#local-6989586621681170351"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621681170350"><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170350"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-411"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681170349"><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170349"><span class="hs-identifier hs-var">env1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681170348"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681170348"><span class="hs-identifier hs-var">args'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; [Id] -&gt; (CseEnv, [Id])
</span><a href="GHC.Stg.CSE.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170356"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">[BinderP 'Vanilla]
</span><a href="#local-6989586621681170351"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-412"></span><span>          </span><span id="local-6989586621681170347"><span class="annot"><span class="annottext">env2 :: CseEnv
</span><a href="#local-6989586621681170347"><span class="hs-identifier hs-var hs-var">env2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; CseEnv
</span><a href="GHC.Stg.CSE.html#forgetCse"><span class="hs-identifier hs-var">forgetCse</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170349"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="hs-comment">-- See note [Free variables of an StgClosure]</span><span>
</span><span id="line-413"></span><span>          </span><span id="local-6989586621681170346"><span class="annot"><span class="annottext">body' :: GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170346"><span class="hs-identifier hs-var hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CseEnv -&gt; GenStgExpr 'Vanilla -&gt; GenStgExpr 'Vanilla
</span><a href="GHC.Stg.CSE.html#stgCseExpr"><span class="hs-identifier hs-var">stgCseExpr</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170347"><span class="hs-identifier hs-var">env2</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170350"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-414"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CseEnv -&gt; Id -&gt; Id
</span><a href="GHC.Stg.CSE.html#substVar"><span class="hs-identifier hs-var">substVar</span></a></span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170356"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170355"><span class="hs-identifier hs-var">bndr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall (pass :: StgPass).
XRhsClosure pass
-&gt; CostCentreStack
-&gt; UpdateFlag
-&gt; [BinderP pass]
-&gt; GenStgExpr pass
-&gt; GenStgRhs pass
</span><a href="GHC.Stg.Syntax.html#StgRhsClosure"><span class="hs-identifier hs-var">StgRhsClosure</span></a></span><span> </span><span class="annot"><span class="annottext">XRhsClosure 'Vanilla
</span><a href="#local-6989586621681170354"><span class="hs-identifier hs-var">ext</span></a></span><span> </span><span class="annot"><span class="annottext">CostCentreStack
</span><a href="#local-6989586621681170353"><span class="hs-identifier hs-var">ccs</span></a></span><span> </span><span class="annot"><span class="annottext">UpdateFlag
</span><a href="#local-6989586621681170352"><span class="hs-identifier hs-var">upd</span></a></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621681170348"><span class="hs-identifier hs-var">args'</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170346"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CseEnv
</span><a href="#local-6989586621681170356"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span>
</span><span id="line-417"></span><span class="annot"><a href="GHC.Stg.CSE.html#mkStgCase"><span class="hs-identifier hs-type">mkStgCase</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#StgExpr"><span class="hs-identifier hs-type">StgExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#AltType"><span class="hs-identifier hs-type">AltType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Stg.Syntax.html#StgAlt"><span class="hs-identifier hs-type">StgAlt</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#StgExpr"><span class="hs-identifier hs-type">StgExpr</span></a></span><span>
</span><span id="line-418"></span><span id="mkStgCase"><span class="annot"><span class="annottext">mkStgCase :: GenStgExpr 'Vanilla
-&gt; Id -&gt; AltType -&gt; [GenStgAlt 'Vanilla] -&gt; GenStgExpr 'Vanilla
</span><a href="GHC.Stg.CSE.html#mkStgCase"><span class="hs-identifier hs-var hs-var">mkStgCase</span></a></span></span><span> </span><span id="local-6989586621681170343"><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170343"><span class="hs-identifier hs-var">scrut</span></a></span></span><span> </span><span id="local-6989586621681170342"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170342"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621681170341"><span class="annot"><span class="annottext">AltType
</span><a href="#local-6989586621681170341"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span id="local-6989586621681170340"><span class="annot"><span class="annottext">[GenStgAlt 'Vanilla]
</span><a href="#local-6989586621681170340"><span class="hs-identifier hs-var">alts</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../base-4.16.4.0/src/Data-Foldable.html#all"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="annot"><span class="annottext">(AltCon, [Id], GenStgExpr 'Vanilla) -&gt; Bool
</span><a href="#local-6989586621681170338"><span class="hs-identifier hs-var">isBndr</span></a></span><span> </span><span class="annot"><span class="annottext">[GenStgAlt 'Vanilla]
</span><a href="#local-6989586621681170340"><span class="hs-identifier hs-var">alts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170343"><span class="hs-identifier hs-var">scrut</span></a></span><span>
</span><span id="line-419"></span><span>                             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.4.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (pass :: StgPass).
GenStgExpr pass
-&gt; BinderP pass -&gt; AltType -&gt; [GenStgAlt pass] -&gt; GenStgExpr pass
</span><a href="GHC.Stg.Syntax.html#StgCase"><span class="hs-identifier hs-var">StgCase</span></a></span><span> </span><span class="annot"><span class="annottext">GenStgExpr 'Vanilla
</span><a href="#local-6989586621681170343"><span class="hs-identifier hs-var">scrut</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170342"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">AltType
</span><a href="#local-6989586621681170341"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">[GenStgAlt 'Vanilla]
</span><a href="#local-6989586621681170340"><span class="hs-identifier hs-var">alts</span></a></span><span>
</span><span id="line-420"></span><span>
</span><span id="line-421"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-422"></span><span>    </span><span class="hs-comment">-- see Note [All alternatives are the binder]</span><span>
</span><span id="line-423"></span><span>    </span><span id="local-6989586621681170338"><span class="annot"><span class="annottext">isBndr :: (AltCon, [Id], GenStgExpr 'Vanilla) -&gt; Bool
</span><a href="#local-6989586621681170338"><span class="hs-identifier hs-var hs-var">isBndr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AltCon
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Id]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Stg.Syntax.html#StgApp"><span class="hs-identifier hs-type">StgApp</span></a></span><span> </span><span id="local-6989586621681170337"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170337"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170337"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621681170342"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-424"></span><span>    </span><span class="annot"><a href="#local-6989586621681170338"><span class="hs-identifier hs-var">isBndr</span></a></span><span> </span><span class="annot"><span class="annottext">(AltCon, [Id], GenStgExpr 'Vanilla)
</span><span class="hs-identifier">_</span></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-425"></span><span>
</span><span id="line-426"></span><span>
</span><span id="line-427"></span><span class="hs-comment">{- Note [Care with loop breakers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When doing CSE on a letrec we must be careful about loop
breakers.  Consider
  rec { y = K z
      ; z = K z }
Now if, somehow (and wrongly)), y and z are both marked as
loop-breakers, we do *not* want to drop the (z = K z) binding
in favour of a substitution (z :-&gt; y).

I think this bug will only show up if the loop-breaker-ness is done
wrongly (itself a bug), but it still seems better to do the right
thing regardless.
-}</span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span class="hs-comment">-- Utilities</span><span>
</span><span id="line-443"></span><span>
</span><span id="line-444"></span><span class="hs-comment">-- | This function short-cuts let-bindings that are now obsolete</span><span>
</span><span id="line-445"></span><span id="local-6989586621681170747"><span id="local-6989586621681170748"><span class="annot"><a href="GHC.Stg.CSE.html#mkStgLet"><span class="hs-identifier hs-type">mkStgLet</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621681170748"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681170747"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681170747"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681170748"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681170747"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681170747"><span class="hs-identifier hs-type">b</span></a></span></span></span><span>
</span><span id="line-446"></span><span id="mkStgLet"><span class="annot"><span class="annottext">mkStgLet :: forall a b. (a -&gt; b -&gt; b) -&gt; Maybe a -&gt; b -&gt; b
</span><a href="GHC.Stg.CSE.html#mkStgLet"><span class="hs-identifier hs-var hs-var">mkStgLet</span></a></span></span><span> </span><span class="annot"><span class="annottext">a -&gt; b -&gt; b
</span><span class="hs-identifier">_</span></span><span>      </span><span class="annot"><span class="annottext">Maybe a
</span><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>      </span><span id="local-6989586621681170336"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681170336"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681170336"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-447"></span><span class="annot"><a href="GHC.Stg.CSE.html#mkStgLet"><span class="hs-identifier hs-var">mkStgLet</span></a></span><span> </span><span id="local-6989586621681170335"><span class="annot"><span class="annottext">a -&gt; b -&gt; b
</span><a href="#local-6989586621681170335"><span class="hs-identifier hs-var">stgLet</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.4.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681170334"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681170334"><span class="hs-identifier hs-var">binds</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681170333"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681170333"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; b -&gt; b
</span><a href="#local-6989586621681170335"><span class="hs-identifier hs-var">stgLet</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681170334"><span class="hs-identifier hs-var">binds</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621681170333"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-448"></span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span class="hs-comment">{-
Note [All alternatives are the binder]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

When all alternatives simply refer to the case binder, then we do not have
to bother with the case expression at all (#13588). CoreSTG does this as well,
but sometimes, types get into the way:

    newtype T = MkT Int
    f :: (Int, Int) -&gt; (T, Int)
    f (x, y) = (MkT x, y)

Core cannot just turn this into

    f p = p

as this would not be well-typed. But to STG, where MkT is no longer in the way,
we can.

Note [Trivial case scrutinee]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We want to be able to handle nested reconstruction of constructors as in

    nested :: Either Int (Either Int a) -&gt; Either Bool (Either Bool a)
    nested (Right (Right v)) = Right (Right v)
    nested _ = Left True

So if we come across

    case x of r1
      Right a -&gt; case a of r2
              Right b -&gt; let v = Right b
                         in Right v

we first replace v with r2. Next we want to replace Right r2 with r1. But the
ce_conAppMap contains Right a!

Therefore, we add r1 &#8614; x to ce_bndrMap when analysing the outer case, and use
this substitution before looking Right r2 up in ce_conAppMap, and everything
works out.

Note [Free variables of an StgClosure]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
StgClosures (function and thunks) have an explicit list of free variables:

foo [x] =
    let not_a_free_var = Left [x]
    let a_free_var = Right [x]
    let closure = \[x a_free_var] -&gt; \[y] -&gt; bar y (Left [x]) a_free_var
    in closure

If we were to CSE `Left [x]` in the body of `closure` with `not_a_free_var`,
then the list of free variables would be wrong, so for now, we do not CSE
across such a closure, simply because I (Joachim) was not sure about possible
knock-on effects. If deemed safe and worth the slight code complication of
re-calculating this list during or after this pass, this can surely be done.
-}</span><span>
</span><span id="line-507"></span></pre></body></html>