<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- editorconfig-checker-disable-file</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes       #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE BangPatterns              #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE ConstraintKinds           #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE DataKinds                 #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances         #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses     #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE PolyKinds                 #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE StandaloneKindSignatures  #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications          #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies              #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators             #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances      #-}</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-pragma">{-# LANGUAGE StrictData                #-}</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">PlutusCore.Builtin.Meaning</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusPrelude.html"><span class="hs-identifier">PlutusPrelude</span></a></span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Elaborate.html"><span class="hs-identifier">PlutusCore.Builtin.Elaborate</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.HasConstant.html"><span class="hs-identifier">PlutusCore.Builtin.HasConstant</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownKind.html"><span class="hs-identifier">PlutusCore.Builtin.KnownKind</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownType.html"><span class="hs-identifier">PlutusCore.Builtin.KnownType</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownTypeAst.html"><span class="hs-identifier">PlutusCore.Builtin.KnownTypeAst</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Runtime.html"><span class="hs-identifier">PlutusCore.Builtin.Runtime</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html"><span class="hs-identifier">PlutusCore.Builtin.TypeScheme</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Core.html"><span class="hs-identifier">PlutusCore.Core</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExBudget.html"><span class="hs-identifier">PlutusCore.Evaluation.Machine.ExBudget</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExMemory.html"><span class="hs-identifier">PlutusCore.Evaluation.Machine.ExMemory</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Name.html"><span class="hs-identifier">PlutusCore.Name</span></a></span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/deepseq-1.4.6.1/src"><span class="hs-identifier">Control.DeepSeq</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/array-0.5.4.0/src"><span class="hs-identifier">Data.Array</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">Data.Kind</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">GHC</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">Data.Proxy</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../some/html/src"><span class="hs-identifier">Data.Some.GADT</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">GHC.Exts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier">inline</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier">lazy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier">oneShot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier">GHC.TypeLits</span></a></span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="hs-comment">-- | Turn a list of Haskell types @args@ into a functional type ending in @res@.</span><span>
</span><span id="line-43"></span><span class="hs-comment">--</span><span>
</span><span id="line-44"></span><span class="hs-comment">-- &gt;&gt;&gt; :set -XDataKinds</span><span>
</span><span id="line-45"></span><span class="hs-comment">-- &gt;&gt;&gt; :kind! FoldArgs [(), Bool] Integer</span><span>
</span><span id="line-46"></span><span class="hs-comment">-- FoldArgs [(), Bool] Integer :: *</span><span>
</span><span id="line-47"></span><span class="hs-comment">-- = () -&gt; Bool -&gt; Integer</span><span>
</span><span id="line-48"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="FoldArgs"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#FoldArgs"><span class="hs-identifier hs-var">FoldArgs</span></a></span></span><span> </span><span id="local-6989586621680865536"><span class="annot"><a href="#local-6989586621680865536"><span class="hs-identifier hs-type">args</span></a></span></span><span> </span><span id="local-6989586621680865535"><span class="annot"><a href="#local-6989586621680865535"><span class="hs-identifier hs-type">res</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-49"></span><span>    </span><span id="FoldArgs"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#FoldArgs"><span class="hs-identifier hs-var">FoldArgs</span></a></span></span><span> </span><span id="local-6989586621680865534"><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span>           </span><span class="annot"><a href="#local-6989586621680865534"><span class="hs-identifier hs-type">res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621680865534"><span class="hs-identifier hs-type">res</span></a></span><span>
</span><span id="line-50"></span><span>    </span><span id="FoldArgs"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#FoldArgs"><span class="hs-identifier hs-var">FoldArgs</span></a></span></span><span> </span><span id="local-6989586621680865531"><span id="local-6989586621680865532"><span id="local-6989586621680865533"><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680865533"><span class="hs-identifier hs-type">arg</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><span class="annot"><a href="#local-6989586621680865532"><span class="hs-identifier hs-type">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680865531"><span class="hs-identifier hs-type">res</span></a></span></span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621680865533"><span class="hs-identifier hs-type">arg</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#FoldArgs"><span class="hs-identifier hs-type">FoldArgs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865532"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865531"><span class="hs-identifier hs-type">res</span></a></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-comment">-- | The meaning of a built-in function consists of its type represented as a 'TypeScheme',</span><span>
</span><span id="line-53"></span><span class="hs-comment">-- its Haskell denotation and a costing function.</span><span>
</span><span id="line-54"></span><span class="hs-comment">--</span><span>
</span><span id="line-55"></span><span class="hs-comment">-- The 'TypeScheme' of a built-in function is used for example for</span><span>
</span><span id="line-56"></span><span class="hs-comment">--</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- 1. computing the PLC type of the function to be used during type checking</span><span>
</span><span id="line-58"></span><span class="hs-comment">-- 2. getting arity information</span><span>
</span><span id="line-59"></span><span class="hs-comment">-- 3. generating arbitrary values to apply the function to in tests</span><span>
</span><span id="line-60"></span><span class="hs-comment">--</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- The denotation is lazy, so that we don't need to worry about a builtin being bottom</span><span>
</span><span id="line-62"></span><span class="hs-comment">-- (happens in tests). The production path is not affected by that, since only runtime denotations</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- are used for evaluation.</span><span>
</span><span id="line-64"></span><span class="hs-keyword">data</span><span> </span><span id="BuiltinMeaning"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#BuiltinMeaning"><span class="hs-identifier hs-var">BuiltinMeaning</span></a></span></span><span> </span><span id="local-6989586621680865564"><span class="annot"><a href="#local-6989586621680865564"><span class="hs-identifier hs-type">val</span></a></span></span><span> </span><span id="local-6989586621680865561"><span class="annot"><a href="#local-6989586621680865561"><span class="hs-identifier hs-type">cost</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680865530"><span class="annot"><a href="#local-6989586621680865530"><span class="hs-identifier hs-type">args</span></a></span></span><span> </span><span id="local-6989586621680865529"><span class="annot"><a href="#local-6989586621680865529"><span class="hs-identifier hs-type">res</span></a></span></span><span class="hs-operator">.</span><span> </span><span id="BuiltinMeaning"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#BuiltinMeaning"><span class="hs-identifier hs-var">BuiltinMeaning</span></a></span></span><span>
</span><span id="line-66"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#TypeScheme"><span class="hs-identifier hs-type">TypeScheme</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865564"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865530"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865529"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>        </span><span class="hs-glyph">~</span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#FoldArgs"><span class="hs-identifier hs-type">FoldArgs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865530"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865529"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680865561"><span class="hs-identifier hs-type">cost</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Runtime.html#BuiltinRuntime"><span class="hs-identifier hs-type">BuiltinRuntime</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865564"><span class="hs-identifier hs-type">val</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span class="hs-comment">-- | Constraints available when defining a built-in function.</span><span>
</span><span id="line-71"></span><span class="hs-keyword">type</span><span> </span><span id="HasMeaningIn"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#HasMeaningIn"><span class="hs-identifier hs-var">HasMeaningIn</span></a></span></span><span> </span><span id="local-6989586621680865527"><span class="annot"><a href="#local-6989586621680865527"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621680865526"><span class="annot"><a href="#local-6989586621680865526"><span class="hs-identifier hs-type">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Typeable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865526"><span class="hs-identifier hs-type">val</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExMemory.html#ExMemoryUsage"><span class="hs-identifier hs-type">ExMemoryUsage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865526"><span class="hs-identifier hs-type">val</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.HasConstant.html#HasConstantIn"><span class="hs-identifier hs-type">HasConstantIn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865527"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865526"><span class="hs-identifier hs-type">val</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span class="hs-comment">-- | A type class for \&quot;each function from a set of built-in functions has a 'BuiltinMeaning'\&quot;.</span><span>
</span><span id="line-74"></span><span class="hs-keyword">class</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Typeable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865717"><span class="hs-identifier hs-type">uni</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Typeable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865716"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Bounded</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865716"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Enum</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865716"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Ix</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865716"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../data-default-class/html/src"><span class="hs-identifier hs-type">Default</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#BuiltinVersion"><span class="hs-identifier hs-type">BuiltinVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865716"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-75"></span><span>            </span><span id="ToBuiltinMeaning"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ToBuiltinMeaning"><span class="hs-identifier hs-var">ToBuiltinMeaning</span></a></span></span><span> </span><span id="local-6989586621680865717"><span class="annot"><a href="#local-6989586621680865717"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621680865716"><span class="annot"><a href="#local-6989586621680865716"><span class="hs-identifier hs-type">fun</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-comment">-- | The @cost@ part of 'BuiltinMeaning'.</span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-keyword">type</span><span> </span><span id="CostingPart"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#CostingPart"><span class="hs-identifier hs-var">CostingPart</span></a></span></span><span> </span><span id="local-6989586621680865717"><span class="annot"><a href="#local-6989586621680865717"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621680865716"><span class="annot"><a href="#local-6989586621680865716"><span class="hs-identifier hs-type">fun</span></a></span></span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-comment">-- | See Note [Versioned builtins]</span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-keyword">data</span><span> </span><span id="BuiltinVersion"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#BuiltinVersion"><span class="hs-identifier hs-var">BuiltinVersion</span></a></span></span><span> </span><span id="local-6989586621680865716"><span class="annot"><a href="#local-6989586621680865716"><span class="hs-identifier hs-type">fun</span></a></span></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-comment">-- | Get the 'BuiltinMeaning' of a built-in function.</span><span>
</span><span id="line-83"></span><span>    </span><span id="toBuiltinMeaning"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#toBuiltinMeaning"><span class="hs-identifier hs-type">toBuiltinMeaning</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span id="local-6989586621680865694"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#HasMeaningIn"><span class="hs-identifier hs-type">HasMeaningIn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865717"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865694"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#BuiltinVersion"><span class="hs-identifier hs-type">BuiltinVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865716"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680865716"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#BuiltinMeaning"><span class="hs-identifier hs-type">BuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865694"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#CostingPart"><span class="hs-identifier hs-type">CostingPart</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865717"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865716"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="hs-comment">-- | Get the type of a built-in function.</span><span>
</span><span id="line-86"></span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#typeOfBuiltinFunction"><span class="hs-identifier hs-type">typeOfBuiltinFunction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680865712"><span class="annot"><a href="#local-6989586621680865712"><span class="hs-identifier hs-type">uni</span></a></span></span><span> </span><span id="local-6989586621680865711"><span class="annot"><a href="#local-6989586621680865711"><span class="hs-identifier hs-type">fun</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ToBuiltinMeaning"><span class="hs-identifier hs-type">ToBuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865712"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865711"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#BuiltinVersion"><span class="hs-identifier hs-type">BuiltinVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865711"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680865711"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Core.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865712"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span id="typeOfBuiltinFunction"><span class="annot"><span class="annottext">typeOfBuiltinFunction :: forall (uni :: * -&gt; *) fun.
ToBuiltinMeaning uni fun =&gt;
BuiltinVersion fun -&gt; fun -&gt; Type TyName uni ()
</span><a href="PlutusCore.Builtin.Meaning.html#typeOfBuiltinFunction"><span class="hs-identifier hs-var hs-var">typeOfBuiltinFunction</span></a></span></span><span> </span><span id="local-6989586621680865496"><span class="annot"><span class="annottext">BuiltinVersion fun
</span><a href="#local-6989586621680865496"><span class="hs-identifier hs-var">ver</span></a></span></span><span> </span><span id="local-6989586621680865495"><span class="annot"><span class="annottext">fun
</span><a href="#local-6989586621680865495"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall (uni :: * -&gt; *) fun val.
(ToBuiltinMeaning uni fun, HasMeaningIn uni val) =&gt;
BuiltinVersion fun
-&gt; fun -&gt; BuiltinMeaning val (CostingPart uni fun)
</span><a href="PlutusCore.Builtin.Meaning.html#toBuiltinMeaning"><span class="hs-identifier hs-var">toBuiltinMeaning</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Core.Type.html#Term"><span class="hs-identifier hs-type">Term</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865712"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865711"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BuiltinVersion fun
</span><a href="#local-6989586621680865496"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">fun
</span><a href="#local-6989586621680865495"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-88"></span><span>    </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#BuiltinMeaning"><span class="hs-identifier hs-type">BuiltinMeaning</span></a></span><span> </span><span id="local-6989586621680865494"><span class="annot"><span class="annottext">TypeScheme (Term TyName Name uni fun ()) args res
</span><a href="#local-6989586621680865494"><span class="hs-identifier hs-var">sch</span></a></span></span><span> </span><span class="annot"><span class="annottext">FoldArgs args res
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">CostingPart uni fun -&gt; BuiltinRuntime (Term TyName Name uni fun ())
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall val (args :: [*]) res.
TypeScheme val args res -&gt; Type TyName (UniOf val) ()
</span><a href="PlutusCore.Builtin.TypeScheme.html#typeSchemeToType"><span class="hs-identifier hs-var">typeSchemeToType</span></a></span><span> </span><span class="annot"><span class="annottext">TypeScheme (Term TyName Name uni fun ()) args res
</span><a href="#local-6989586621680865494"><span class="hs-identifier hs-var">sch</span></a></span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="hs-comment">{- Note [Versioned builtins]
The purpose of the &quot;versioned builtins&quot; feature is to provide multiple, different denotations (implementations)
for the same builtin(s).
An example use of this feature is for &quot;fixing&quot; the behaviour of `ConsByteString` builtin to throw an error instead
of overflowing its first argument.

One denotation from each builtin is grouped into a 'BuiltinVersion'. Each Plutus Language version is linked
to a specific 'BuiltinVersion' (done by plutus-ledger-api); e.g. plutus-v1 and plutus-v2 are linked to 'DefaultFunV1',
whereas plutus-v3 changes the set of denotations to 'DefaultFunV2' (thus fixing 'ConsByteString').

Each 'BuiltinVersion' (grouping) can change the denotation of one or more builtins --- or none, but what's the point in that.

This 'BuiltinVersion' is modelled as a datatype *associated* to the `fun`. This associated datatype is required to
provide an instance of 'Default' for quality-of-life purpose; the `def`ault builtin version is expected to point to the builtin-version
that the plutus-tx/plutus-ir compiler is currently targetting.

Note that, (old) denotations of a 'BuiltinVersion' cannot be removed or deprecated, once published to the chain.

The way that this feature is implemented buys us more than we currently need:
- allows also a versioned change to a builtin's *type signature*, i.e. type of arguments/result as well as number of arguments.
- allows also a versioned change to a builtin's cost model parameters

Besides having no need for this currently, it complicates the codebase since the typechecker
now pointlessly wants to know the builtin-version before typechecking. To alleviate this,
we use the 'Default.def' builtin version during typechecking / lifting. @effectfully:
the solution to the problem would be to establish what kind of backwards compatibility we're willing to maintain and
pull all of that into a separate data type and make it a part of BuiltinMeaning.
-}</span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span class="hs-comment">{- Note [Automatic derivation of type schemes]
We use two type classes for automatic derivation of type/runtime schemes and runtime denotations:
'KnownPolytype' and 'KnownMonotype'.
The terminology is due to https://en.wikipedia.org/wiki/Hindley%E2%80%93Milner_type_system#The_Hindley%E2%80%93Milner_type_system

Check out the source of &quot;PlutusCore.Builtin.Runtime&quot; for an explanation of what a runtime
denotation is.

'KnownPolytype' and 'KnownMonotype' are responsible for deriving polymorphic and monomorphic types,
respectively.

'KnownPolytype' turns every bound variable into a 'TypeSchemeAll'/'BuiltinExpectForce'. We extract
variables from the type of the Haskell denotation using the 'ToBinds' associated type
family. Variables are collected in the order that they appear in (i.e. just like in Haskell). For
example, processing a type like

      :: ( a ~ Opaque val (TyVarRep ('TyNameRep &quot;a&quot; 0))
         , b ~ Opaque val (TyVarRep ('TyNameRep &quot;b&quot; 1))
         )
      =&gt; b -&gt; a -&gt; b

with 'ToBinds' results in the following list of bindings:

    '[ 'Some ('TyNameRep &quot;b&quot; 1), 'Some ('TyNameRep &quot;a&quot; 0) ]

'KnownMonotype' turns every argument that the Haskell denotation of a builtin receives into a
'TypeSchemeArrow'/'BuiltinExpectArgument'. We extract the arguments from the type of the Haskell
denotation using the 'GetArgs' type family.

Higher-kinded type variables are fully supported.

At this point in the pipeline the type of the denotation of a builtin is assumed to be fully
elaborated (i.e. monomorphic).
-}</span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span class="hs-comment">-- | Chop a function type to get a list of its argument types.</span><span>
</span><span id="line-155"></span><span class="hs-keyword">type</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#GetArgs"><span class="hs-identifier hs-type">GetArgs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">GHC.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">GHC.Type</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-156"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="GetArgs"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#GetArgs"><span class="hs-identifier hs-var">GetArgs</span></a></span></span><span> </span><span id="local-6989586621680865492"><span class="annot"><a href="#local-6989586621680865492"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-157"></span><span>    </span><span id="GetArgs"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#GetArgs"><span class="hs-identifier hs-var">GetArgs</span></a></span></span><span> </span><span id="local-6989586621680865490"><span id="local-6989586621680865491"><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680865491"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680865490"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621680865491"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#GetArgs"><span class="hs-identifier hs-type">GetArgs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865490"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-158"></span><span>    </span><span id="GetArgs"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#GetArgs"><span class="hs-identifier hs-var">GetArgs</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span class="hs-comment">{- Note [Merging the denotation and the costing function]
The runtime denotation of a builtin computes both the builtin application and its cost
(see the docs of 'BuiltinRuntime' for details). Doing both at the same time has a number of benefits
(see Note [runCostingFun* API]), however in the user-facing API we want to separate the concepts
of the denotation and the costing function. This is because:

1. the two are fundamentally distinct and we have loads of documentation for each of them
   separately, so conflating them in the actual API would be unnecessary coupling
2. right now it's clear which bits of the definition of a builtin constitute evaluation and which
   ones constitute costing as the two are different arguments to 'makeBuiltinMeaning'. If evaluation
   and costing were intertwined, it would be much harder to review the definition of a builtin
3. ... and it would also be more boilerplate and less clear type signatures

Hence we want 'makeBuiltinMeaning' to take evaluation and costing bits separately and intertwine
them behind the scenes. Which is straightforward: we only need to pass the two together in the
methods of the 'KnownMonotype' and 'KnownPolytype' classes and zip them argument by argument
into a single 'BuiltinRuntime'.
-}</span><span>
</span><span id="line-178"></span><span>
</span><span id="line-179"></span><span class="hs-comment">-- | A class that allows us to derive a monotype for a builtin.</span><span>
</span><span id="line-180"></span><span class="hs-comment">-- We could've computed the runtime denotation from the</span><span>
</span><span id="line-181"></span><span class="hs-comment">-- 'TypeScheme' and the denotation of the builtin, but not statically (due to unfolding not working</span><span>
</span><span id="line-182"></span><span class="hs-comment">-- for recursive functions and 'TypeScheme' being recursive, i.e. requiring the conversion function</span><span>
</span><span id="line-183"></span><span class="hs-comment">-- to be recursive), and so it would cause us to retain a lot of evaluation-irrelevant stuff in the</span><span>
</span><span id="line-184"></span><span class="hs-comment">-- constructors of 'BuiltinRuntime', which has to make evaluation slower (we didn't check) and</span><span>
</span><span id="line-185"></span><span class="hs-comment">-- certainly makes the generated Core much harder to read. Technically speaking, we could get</span><span>
</span><span id="line-186"></span><span class="hs-comment">-- a 'RuntimeScheme' from the 'TypeScheme' and the denotation statically if we changed the</span><span>
</span><span id="line-187"></span><span class="hs-comment">-- definition of 'TypeScheme' and made it a singleton, but then the conversion function would have</span><span>
</span><span id="line-188"></span><span class="hs-comment">-- to become a class anyway and we'd just replicate what we have here, except in a much more</span><span>
</span><span id="line-189"></span><span class="hs-comment">-- complicated way.</span><span>
</span><span id="line-190"></span><span class="hs-keyword">class</span><span> </span><span id="KnownMonotype"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#KnownMonotype"><span class="hs-identifier hs-var">KnownMonotype</span></a></span></span><span> </span><span id="local-6989586621680865682"><span class="annot"><a href="#local-6989586621680865682"><span class="hs-identifier hs-type">val</span></a></span></span><span> </span><span id="local-6989586621680865681"><span class="annot"><a href="#local-6989586621680865681"><span class="hs-identifier hs-type">args</span></a></span></span><span> </span><span id="local-6989586621680865680"><span class="annot"><a href="#local-6989586621680865680"><span class="hs-identifier hs-type">res</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-191"></span><span>    </span><span id="knownMonotype"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#knownMonotype"><span class="hs-identifier hs-type">knownMonotype</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#TypeScheme"><span class="hs-identifier hs-type">TypeScheme</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865682"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865681"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865680"><span class="hs-identifier hs-type">res</span></a></span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span>    </span><span class="hs-comment">-- | Convert the denotation of a builtin to its runtime counterpart .</span><span>
</span><span id="line-194"></span><span>    </span><span class="hs-comment">-- The argument is in 'ReadKnownM', because that's what deferred unlifting amounts to:</span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-comment">-- passing the action returning the builtin application around until full saturation, which is</span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-comment">-- when the action actually gets run.</span><span>
</span><span id="line-197"></span><span>    </span><span id="toMonoF"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#toMonoF"><span class="hs-identifier hs-type">toMonoF</span></a></span></span><span>
</span><span id="line-198"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownType.html#ReadKnownM"><span class="hs-identifier hs-type">ReadKnownM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#FoldArgs"><span class="hs-identifier hs-type">FoldArgs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865681"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865680"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#FoldArgs"><span class="hs-identifier hs-type">FoldArgs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865681"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExBudget.html#ExBudget"><span class="hs-identifier hs-type">ExBudget</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Runtime.html#BuiltinRuntime"><span class="hs-identifier hs-type">BuiltinRuntime</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865682"><span class="hs-identifier hs-type">val</span></a></span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span class="hs-comment">-- | Once we've run out of term-level arguments, we return a</span><span>
</span><span id="line-202"></span><span class="hs-comment">-- 'TypeSchemeResult'/'RuntimeSchemeResult'.</span><span>
</span><span id="line-203"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680865671"><span id="local-6989586621680865672"><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Typeable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865672"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownTypeAst.html#KnownTypeAst"><span class="hs-identifier hs-type">KnownTypeAst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Core.Type.html#UniOf"><span class="hs-identifier hs-type">UniOf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865671"><span class="hs-identifier hs-type">val</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680865672"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownType.html#MakeKnown"><span class="hs-identifier hs-type">MakeKnown</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865671"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865672"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-204"></span><span>            </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#KnownMonotype"><span class="hs-identifier hs-type">KnownMonotype</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865671"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><a href="#local-6989586621680865672"><span class="hs-identifier hs-type">res</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-205"></span><span>    </span><span id="local-6989586621680865477"><span class="annot"><span class="annottext">knownMonotype :: TypeScheme val '[] res
</span><a href="#local-6989586621680865477"><span class="hs-identifier hs-var hs-var hs-var hs-var">knownMonotype</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall res val.
(Typeable res, KnownTypeAst (UniOf val) res, MakeKnown val res) =&gt;
TypeScheme val '[] res
</span><a href="PlutusCore.Builtin.TypeScheme.html#TypeSchemeResult"><span class="hs-identifier hs-var">TypeSchemeResult</span></a></span><span>
</span><span id="line-206"></span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-comment">-- We need to lift the 'ReadKnownM' action into 'MakeKnownM',</span><span>
</span><span id="line-208"></span><span>    </span><span class="hs-comment">-- hence 'liftReadKnownM'.</span><span>
</span><span id="line-209"></span><span>    </span><span id="local-6989586621680865470"><span class="annot"><span class="annottext">toMonoF :: ReadKnownM (FoldArgs '[] res, FoldArgs '[] ExBudget)
-&gt; BuiltinRuntime val
</span><a href="#local-6989586621680865470"><span class="hs-identifier hs-var hs-var hs-var hs-var">toMonoF</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-210"></span><span>        </span><span class="annot"><span class="annottext">forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">either</span></a></span><span>
</span><span id="line-211"></span><span>            </span><span class="hs-comment">-- Unlifting has failed and we don't care about costing at this point, since we're about</span><span>
</span><span id="line-212"></span><span>            </span><span class="hs-comment">-- to terminate evaluation anyway, hence we put 'mempty' as the cost of the operation.</span><span>
</span><span id="line-213"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-214"></span><span>            </span><span class="hs-comment">-- Note that putting the cost inside of 'MakeKnownM' is not an option, since forcing</span><span>
</span><span id="line-215"></span><span>            </span><span class="hs-comment">-- the 'MakeKnownM' computation is exactly forcing the builtin application, which we</span><span>
</span><span id="line-216"></span><span>            </span><span class="hs-comment">-- can't do before accounting for the cost of the application, i.e. the cost must be</span><span>
</span><span id="line-217"></span><span>            </span><span class="hs-comment">-- outside of 'MakeKnownM'.</span><span>
</span><span id="line-218"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-219"></span><span>            </span><span class="hs-comment">-- We could introduce a level of indirection and say that a 'BuiltinResult' is either</span><span>
</span><span id="line-220"></span><span>            </span><span class="hs-comment">-- a budgeting failure or a budgeting success with a cost and a 'MakeKnownM' computation</span><span>
</span><span id="line-221"></span><span>            </span><span class="hs-comment">-- inside, but that would slow things down a bit and the current strategy is</span><span>
</span><span id="line-222"></span><span>            </span><span class="hs-comment">-- reasonable enough.</span><span>
</span><span id="line-223"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall val. ExBudget -&gt; MakeKnownM val -&gt; BuiltinRuntime val
</span><a href="PlutusCore.Builtin.Runtime.html#BuiltinResult"><span class="hs-identifier hs-var">BuiltinResult</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. DList Text -&gt; KnownTypeError -&gt; MakeKnownM a
</span><a href="PlutusCore.Builtin.KnownType.html#MakeKnownFailure"><span class="hs-identifier hs-var">MakeKnownFailure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Monoid a =&gt; a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680865465"><span class="annot"><span class="annottext">res
</span><a href="#local-6989586621680865465"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680865464"><span class="annot"><span class="annottext">ExBudget
</span><a href="#local-6989586621680865464"><span class="hs-identifier hs-var">cost</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall val. ExBudget -&gt; MakeKnownM val -&gt; BuiltinRuntime val
</span><a href="PlutusCore.Builtin.Runtime.html#BuiltinResult"><span class="hs-identifier hs-var">BuiltinResult</span></a></span><span> </span><span class="annot"><span class="annottext">ExBudget
</span><a href="#local-6989586621680865464"><span class="hs-identifier hs-var">cost</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (uni :: * -&gt; *) val a.
MakeKnownIn uni val a =&gt;
a -&gt; MakeKnownM val
</span><a href="PlutusCore.Builtin.KnownType.html#makeKnown"><span class="hs-identifier hs-var">makeKnown</span></a></span><span> </span><span class="annot"><span class="annottext">res
</span><a href="#local-6989586621680865465"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#toMonoF"><span class="hs-pragma hs-type">toMonoF</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span class="hs-comment">{- Note [One-shotting runtime denotations]
In @KnownMonotype val (arg ': args) res@ we 'oneShot' the runtime denotations. Otherwise GHC creates
let-bindings and lifts them out of some of the lambdas in the runtime denotation, which would speed
up partial applications if they were getting reused, but at some point it was verified that we
didn't have any reusage of partial applications: https://github.com/input-output-hk/plutus/pull/4629

One-shotting the runtime denotations alone made certain game contracts slower by ~9%. A lot of time
was spent on the investigation, but we still don't know why that was happening. Plus, basically any
other change to the builtins machinery would cause the same kind of slowdown, so we just admitted
defeat and decided it wasn't worth investigating the issue further.
Relevant thread: https://github.com/input-output-hk/plutus/pull/4620

The speedup that adding a call to 'oneShot' gives us, if any, is smaller than our noise threshold,
however it also makes those confusing allocations disappear from the generated Core, which is enough
of a reason to add the call.
-}</span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span class="hs-comment">{- Note [Strict application in runtime denotations]
Runtime denotations contain strict let-bindings. Those are important: without them GHC thinks that
the argument may not be needed in the end and so creates a thunk for it, which is not only
unnecessary allocation, but also prevents things from being unboxed. The argument may indeed not be
needed in the end, but in that case we've got an evaluation failure and we're about to terminate
evaluation anyway, hence we care much more about optimizing the happy path.
-}</span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span class="hs-comment">-- | Every term-level argument becomes a 'TypeSchemeArrow'/'RuntimeSchemeArrow'.</span><span>
</span><span id="line-253"></span><span class="hs-keyword">instance</span><span>
</span><span id="line-254"></span><span>        </span><span id="local-6989586621680865641"><span id="local-6989586621680865642"><span id="local-6989586621680865643"><span id="local-6989586621680865644"><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Typeable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865644"><span class="hs-identifier hs-type">arg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownTypeAst.html#KnownTypeAst"><span class="hs-identifier hs-type">KnownTypeAst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Core.Type.html#UniOf"><span class="hs-identifier hs-type">UniOf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865643"><span class="hs-identifier hs-type">val</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680865644"><span class="hs-identifier hs-type">arg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownType.html#MakeKnown"><span class="hs-identifier hs-type">MakeKnown</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865643"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865644"><span class="hs-identifier hs-type">arg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownType.html#ReadKnown"><span class="hs-identifier hs-type">ReadKnown</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865643"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865644"><span class="hs-identifier hs-type">arg</span></a></span><span>
</span><span id="line-255"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#KnownMonotype"><span class="hs-identifier hs-type">KnownMonotype</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865643"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865642"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865641"><span class="hs-identifier hs-type">res</span></a></span><span>
</span><span id="line-256"></span><span>        </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#KnownMonotype"><span class="hs-identifier hs-type">KnownMonotype</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865643"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680865644"><span class="hs-identifier hs-type">arg</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><span class="annot"><a href="#local-6989586621680865642"><span class="hs-identifier hs-type">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680865641"><span class="hs-identifier hs-type">res</span></a></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-257"></span><span>    </span><span id="local-6989586621680865449"><span class="annot"><span class="annottext">knownMonotype :: TypeScheme val (arg : args) res
</span><a href="#local-6989586621680865449"><span class="hs-identifier hs-var hs-var hs-var hs-var">knownMonotype</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall arg val (args1 :: [*]) res.
(Typeable arg, KnownTypeAst (UniOf val) arg, MakeKnown val arg,
 ReadKnown val arg) =&gt;
TypeScheme val args1 res -&gt; TypeScheme val (arg : args1) res
</span><a href="PlutusCore.Builtin.TypeScheme.html#TypeSchemeArrow"><span class="hs-identifier hs-var">TypeSchemeArrow</span></a></span><span> </span><span class="annot"><span class="annottext">forall val (args :: [*]) res.
KnownMonotype val args res =&gt;
TypeScheme val args res
</span><a href="PlutusCore.Builtin.Meaning.html#knownMonotype"><span class="hs-identifier hs-var">knownMonotype</span></a></span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span>    </span><span class="hs-comment">-- See Note [One-shotting runtime denotations].</span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-comment">-- Grow the builtin application within the received action and recurse on the result.</span><span>
</span><span id="line-261"></span><span>    </span><span id="local-6989586621680865440"><span class="annot"><span class="annottext">toMonoF :: ReadKnownM
  (FoldArgs (arg : args) res, FoldArgs (arg : args) ExBudget)
-&gt; BuiltinRuntime val
</span><a href="#local-6989586621680865440"><span class="hs-identifier hs-var hs-var hs-var hs-var">toMonoF</span></a></span></span><span> </span><span id="local-6989586621680865439"><span class="annot"><span class="annottext">ReadKnownM
  (FoldArgs (arg : args) res, FoldArgs (arg : args) ExBudget)
</span><a href="#local-6989586621680865439"><span class="hs-identifier hs-var">getBoth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall val. (val -&gt; BuiltinRuntime val) -&gt; BuiltinRuntime val
</span><a href="PlutusCore.Builtin.Runtime.html#BuiltinExpectArgument"><span class="hs-identifier hs-var">BuiltinExpectArgument</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">oneShot :: forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">oneShot</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680865437"><span class="annot"><span class="annottext">val
</span><a href="#local-6989586621680865437"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-262"></span><span>        </span><span class="hs-comment">-- Ironically computing the unlifted value strictly is the best way of doing deferred</span><span>
</span><span id="line-263"></span><span>        </span><span class="hs-comment">-- unlifting. This means that while the resulting 'ReadKnownM' is only handled upon full</span><span>
</span><span id="line-264"></span><span>        </span><span class="hs-comment">-- saturation and any evaluation failure is only registered when the whole builtin</span><span>
</span><span id="line-265"></span><span>        </span><span class="hs-comment">-- application is evaluated, a Haskell exception will occur immediately.</span><span>
</span><span id="line-266"></span><span>        </span><span class="hs-comment">-- It shouldn't matter though, because a builtin is not supposed to throw an</span><span>
</span><span id="line-267"></span><span>        </span><span class="hs-comment">-- exception at any stage, that would be a bug regardless.</span><span>
</span><span id="line-268"></span><span>        </span><span class="annot"><span class="annottext">forall val (args :: [*]) res.
KnownMonotype val args res =&gt;
ReadKnownM (FoldArgs args res, FoldArgs args ExBudget)
-&gt; BuiltinRuntime val
</span><a href="PlutusCore.Builtin.Meaning.html#toMonoF"><span class="hs-identifier hs-var">toMonoF</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865643"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865642"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865641"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-269"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621680865435"><span class="annot"><span class="annottext">arg -&gt; FoldArgs args res
</span><a href="#local-6989586621680865435"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680865434"><span class="annot"><span class="annottext">arg -&gt; FoldArgs args ExBudget
</span><a href="#local-6989586621680865434"><span class="hs-identifier hs-var">exF</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReadKnownM
  (FoldArgs (arg : args) res, FoldArgs (arg : args) ExBudget)
</span><a href="#local-6989586621680865439"><span class="hs-identifier hs-var">getBoth</span></a></span><span>
</span><span id="line-270"></span><span>            </span><span id="local-6989586621680865433"><span class="annot"><span class="annottext">arg
</span><a href="#local-6989586621680865433"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (uni :: * -&gt; *) val a.
ReadKnownIn uni val a =&gt;
val -&gt; ReadKnownM a
</span><a href="PlutusCore.Builtin.KnownType.html#readKnown"><span class="hs-identifier hs-var">readKnown</span></a></span><span> </span><span class="annot"><span class="annottext">val
</span><a href="#local-6989586621680865437"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-271"></span><span>            </span><span class="hs-comment">-- See Note [Strict application in runtime denotations].</span><span>
</span><span id="line-272"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621680865431"><span class="annot"><span class="annottext">exY :: FoldArgs args ExBudget
</span><a href="#local-6989586621680865431"><span class="hs-identifier hs-var hs-var">exY</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">arg -&gt; FoldArgs args ExBudget
</span><a href="#local-6989586621680865434"><span class="hs-identifier hs-var">exF</span></a></span><span> </span><span class="annot"><span class="annottext">arg
</span><a href="#local-6989586621680865433"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-273"></span><span>            </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">arg -&gt; FoldArgs args res
</span><a href="#local-6989586621680865435"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">arg
</span><a href="#local-6989586621680865433"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FoldArgs args ExBudget
</span><a href="#local-6989586621680865431"><span class="hs-identifier hs-var">exY</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#toMonoF"><span class="hs-pragma hs-type">toMonoF</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span class="hs-comment">-- | A class that allows us to derive a polytype for a builtin.</span><span>
</span><span id="line-277"></span><span class="hs-keyword">class</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#KnownMonotype"><span class="hs-identifier hs-type">KnownMonotype</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865621"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865620"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865619"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span id="KnownPolytype"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#KnownPolytype"><span class="hs-identifier hs-var">KnownPolytype</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680865622"><span class="annot"><a href="#local-6989586621680865622"><span class="hs-identifier hs-type">binds</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../some/html/src"><span class="hs-identifier hs-type">Some</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Polymorphism.html#TyNameRep"><span class="hs-identifier hs-type">TyNameRep</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span id="local-6989586621680865621"><span class="annot"><a href="#local-6989586621680865621"><span class="hs-identifier hs-type">val</span></a></span></span><span> </span><span id="local-6989586621680865620"><span class="annot"><a href="#local-6989586621680865620"><span class="hs-identifier hs-type">args</span></a></span></span><span> </span><span id="local-6989586621680865619"><span class="annot"><a href="#local-6989586621680865619"><span class="hs-identifier hs-type">res</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-278"></span><span>    </span><span id="knownPolytype"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#knownPolytype"><span class="hs-identifier hs-type">knownPolytype</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#TypeScheme"><span class="hs-identifier hs-type">TypeScheme</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865621"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865620"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865619"><span class="hs-identifier hs-type">res</span></a></span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span>    </span><span class="hs-comment">-- | Convert the denotation of a builtin to its runtime counterpart.</span><span>
</span><span id="line-281"></span><span>    </span><span class="hs-comment">-- The argument is in 'ReadKnownM', because that's what we need to do:</span><span>
</span><span id="line-282"></span><span>    </span><span class="hs-comment">-- passing the action returning the builtin application around until full saturation, which is</span><span>
</span><span id="line-283"></span><span>    </span><span class="hs-comment">-- when the action actually gets run.</span><span>
</span><span id="line-284"></span><span>    </span><span id="toPolyF"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#toPolyF"><span class="hs-identifier hs-type">toPolyF</span></a></span></span><span>
</span><span id="line-285"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownType.html#ReadKnownM"><span class="hs-identifier hs-type">ReadKnownM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#FoldArgs"><span class="hs-identifier hs-type">FoldArgs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865620"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865619"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#FoldArgs"><span class="hs-identifier hs-type">FoldArgs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865620"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExBudget.html#ExBudget"><span class="hs-identifier hs-type">ExBudget</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Runtime.html#BuiltinRuntime"><span class="hs-identifier hs-type">BuiltinRuntime</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865621"><span class="hs-identifier hs-type">val</span></a></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span class="hs-comment">-- | Once we've run out of type-level arguments, we start handling term-level ones.</span><span>
</span><span id="line-289"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680865612"><span id="local-6989586621680865613"><span id="local-6989586621680865614"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#KnownMonotype"><span class="hs-identifier hs-type">KnownMonotype</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865614"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865613"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865612"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#KnownPolytype"><span class="hs-identifier hs-type">KnownPolytype</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><a href="#local-6989586621680865614"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865613"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865612"><span class="hs-identifier hs-type">res</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-290"></span><span>    </span><span id="local-6989586621680865419"><span class="annot"><span class="annottext">knownPolytype :: TypeScheme val args res
</span><a href="#local-6989586621680865419"><span class="hs-identifier hs-var hs-var hs-var hs-var">knownPolytype</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall val (args :: [*]) res.
KnownMonotype val args res =&gt;
TypeScheme val args res
</span><a href="PlutusCore.Builtin.Meaning.html#knownMonotype"><span class="hs-identifier hs-var">knownMonotype</span></a></span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span>    </span><span id="local-6989586621680865417"><span class="annot"><span class="annottext">toPolyF :: ReadKnownM (FoldArgs args res, FoldArgs args ExBudget)
-&gt; BuiltinRuntime val
</span><a href="#local-6989586621680865417"><span class="hs-identifier hs-var hs-var hs-var hs-var">toPolyF</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall val (args :: [*]) res.
KnownMonotype val args res =&gt;
ReadKnownM (FoldArgs args res, FoldArgs args ExBudget)
-&gt; BuiltinRuntime val
</span><a href="PlutusCore.Builtin.Meaning.html#toMonoF"><span class="hs-identifier hs-var">toMonoF</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865614"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865613"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865612"><span class="hs-identifier hs-type">res</span></a></span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#toPolyF"><span class="hs-pragma hs-type">toPolyF</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-294"></span><span>
</span><span id="line-295"></span><span class="hs-comment">-- Here we unpack an existentially packed @kind@ and constrain it afterwards!</span><span>
</span><span id="line-296"></span><span class="hs-comment">-- So promoted existentials are true sigmas! If we were at the term level, we'd have to pack</span><span>
</span><span id="line-297"></span><span class="hs-comment">-- @kind@ along with the @KnownKind kind@ constraint, otherwise when we unpack the existential,</span><span>
</span><span id="line-298"></span><span class="hs-comment">-- all information is lost and we can't do anything with @kind@.</span><span>
</span><span id="line-299"></span><span class="hs-comment">-- | Every type-level argument becomes a 'TypeSchemeAll'.</span><span>
</span><span id="line-300"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680865596"><span id="local-6989586621680865597"><span id="local-6989586621680865598"><span id="local-6989586621680865599"><span id="local-6989586621680865600"><span id="local-6989586621680865601"><span id="local-6989586621680865602"><span class="hs-special">(</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">KnownSymbol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865602"><span class="hs-identifier hs-type">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">KnownNat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865601"><span class="hs-identifier hs-type">uniq</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownKind.html#KnownKind"><span class="hs-identifier hs-type">KnownKind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865600"><span class="hs-identifier hs-type">kind</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#KnownPolytype"><span class="hs-identifier hs-type">KnownPolytype</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865599"><span class="hs-identifier hs-type">binds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865598"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865597"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865596"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-301"></span><span>            </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#KnownPolytype"><span class="hs-identifier hs-type">KnownPolytype</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="../../../../some/html/src"><span class="hs-identifier hs-type">Some</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="PlutusCore.Builtin.Polymorphism.html#TyNameRep"><span class="hs-identifier hs-type">TyNameRep</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865600"><span class="hs-identifier hs-type">kind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865602"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865601"><span class="hs-identifier hs-type">uniq</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><span class="annot"><a href="#local-6989586621680865599"><span class="hs-identifier hs-type">binds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680865598"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865597"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865596"><span class="hs-identifier hs-type">res</span></a></span></span></span></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-302"></span><span>    </span><span id="local-6989586621680865402"><span class="annot"><span class="annottext">knownPolytype :: TypeScheme val args res
</span><a href="#local-6989586621680865402"><span class="hs-identifier hs-var hs-var hs-var hs-var">knownPolytype</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (text :: Symbol) (uniq :: Nat) kind val (args :: [*]) res.
(KnownSymbol text, KnownNat uniq, KnownKind kind) =&gt;
Proxy '(text, uniq, kind)
-&gt; TypeScheme val args res -&gt; TypeScheme val args res
</span><a href="PlutusCore.Builtin.TypeScheme.html#TypeSchemeAll"><span class="hs-identifier hs-var">TypeSchemeAll</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865602"><span class="hs-identifier hs-type">name</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865601"><span class="hs-identifier hs-type">uniq</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865600"><span class="hs-identifier hs-type">kind</span></a></span><span> </span><span class="annot"><span class="annottext">forall {k} (t :: k). Proxy t
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (binds :: [Some TyNameRep]) val (args :: [*]) res.
KnownPolytype binds val args res =&gt;
TypeScheme val args res
</span><a href="PlutusCore.Builtin.Meaning.html#knownPolytype"><span class="hs-identifier hs-var">knownPolytype</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865599"><span class="hs-identifier hs-type">binds</span></a></span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span>    </span><span id="local-6989586621680865398"><span class="annot"><span class="annottext">toPolyF :: ReadKnownM (FoldArgs args res, FoldArgs args ExBudget)
-&gt; BuiltinRuntime val
</span><a href="#local-6989586621680865398"><span class="hs-identifier hs-var hs-var hs-var hs-var">toPolyF</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall val. BuiltinRuntime val -&gt; BuiltinRuntime val
</span><a href="PlutusCore.Builtin.Runtime.html#BuiltinExpectForce"><span class="hs-identifier hs-var">BuiltinExpectForce</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall (binds :: [Some TyNameRep]) val (args :: [*]) res.
KnownPolytype binds val args res =&gt;
ReadKnownM (FoldArgs args res, FoldArgs args ExBudget)
-&gt; BuiltinRuntime val
</span><a href="PlutusCore.Builtin.Meaning.html#toPolyF"><span class="hs-identifier hs-var">toPolyF</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865599"><span class="hs-identifier hs-type">binds</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865598"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865597"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865596"><span class="hs-identifier hs-type">res</span></a></span><span>
</span><span id="line-305"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#toPolyF"><span class="hs-pragma hs-type">toPolyF</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span class="hs-comment">-- | Ensure a built-in function is not nullary and throw a nice error otherwise.</span><span>
</span><span id="line-308"></span><span class="hs-keyword">type</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ThrowOnBothEmpty"><span class="hs-identifier hs-type">ThrowOnBothEmpty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../some/html/src"><span class="hs-identifier hs-type">Some</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Polymorphism.html#TyNameRep"><span class="hs-identifier hs-type">TyNameRep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">GHC.Type</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">GHC.Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">GHC.Constraint</span></a></span><span>
</span><span id="line-309"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="ThrowOnBothEmpty"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ThrowOnBothEmpty"><span class="hs-identifier hs-var">ThrowOnBothEmpty</span></a></span></span><span> </span><span id="local-6989586621680865396"><span class="annot"><a href="#local-6989586621680865396"><span class="hs-identifier hs-type">binds</span></a></span></span><span> </span><span id="local-6989586621680865395"><span class="annot"><a href="#local-6989586621680865395"><span class="hs-identifier hs-type">args</span></a></span></span><span> </span><span id="local-6989586621680865394"><span class="annot"><a href="#local-6989586621680865394"><span class="hs-identifier hs-type">isBuiltin</span></a></span></span><span> </span><span id="local-6989586621680865393"><span class="annot"><a href="#local-6989586621680865393"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-310"></span><span>    </span><span id="ThrowOnBothEmpty"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ThrowOnBothEmpty"><span class="hs-identifier hs-var">ThrowOnBothEmpty</span></a></span></span><span> </span><span id="local-6989586621680865392"><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">True</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865392"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-311"></span><span>        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">TypeError</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-312"></span><span>            </span><span class="hs-special">'</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;A built-in function must take at least one type or term argument&quot;</span></span><span> </span><span class="hs-special">'</span><span class="hs-operator">:$$:</span><span>
</span><span id="line-313"></span><span>            </span><span class="hs-special">'</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;&#8216;&quot;</span></span><span> </span><span class="hs-special">'</span><span class="hs-operator">:&lt;&gt;:</span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">ShowType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865392"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-operator">:&lt;&gt;:</span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;&#8217; is a built-in type&quot;</span></span><span> </span><span class="hs-special">'</span><span class="hs-operator">:&lt;&gt;:</span><span>
</span><span id="line-314"></span><span>            </span><span class="hs-special">'</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot; so you can embed any of its values as a constant&quot;</span></span><span> </span><span class="hs-special">'</span><span class="hs-operator">:$$:</span><span>
</span><span id="line-315"></span><span>            </span><span class="hs-special">'</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;If you still want a built-in function, add a dummy &#8216;()&#8217; argument&quot;</span></span><span>
</span><span id="line-316"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>    </span><span id="ThrowOnBothEmpty"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ThrowOnBothEmpty"><span class="hs-identifier hs-var">ThrowOnBothEmpty</span></a></span></span><span> </span><span id="local-6989586621680865391"><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-type">False</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865391"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-318"></span><span>        </span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">TypeError</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-319"></span><span>            </span><span class="hs-special">'</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;A built-in function must take at least one type or term argument&quot;</span></span><span> </span><span class="hs-special">'</span><span class="hs-operator">:$$:</span><span>
</span><span id="line-320"></span><span>            </span><span class="hs-special">'</span><span class="annot"><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;To fix this error add a dummy &#8216;()&#8217; argument&quot;</span></span><span>
</span><span id="line-321"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-322"></span><span>    </span><span id="ThrowOnBothEmpty"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ThrowOnBothEmpty"><span class="hs-identifier hs-var">ThrowOnBothEmpty</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span class="hs-comment">-- | A function turned into a type class with exactly one fully general instance.</span><span>
</span><span id="line-325"></span><span class="hs-comment">-- We can't package up the constraints of 'makeBuiltinMeaning' (see the instance) into a type or</span><span>
</span><span id="line-326"></span><span class="hs-comment">-- class synonym, because they contain a bunch of variables defined by @~@ or determined via</span><span>
</span><span id="line-327"></span><span class="hs-comment">-- functional dependencies and neither class nor type definitions can handle that</span><span>
</span><span id="line-328"></span><span class="hs-comment">-- (see https://gitlab.haskell.org/ghc/ghc/-/issues/7100). Inlining three lines of constraints</span><span>
</span><span id="line-329"></span><span class="hs-comment">-- whenever we need to call 'makeBuiltinMeaning' over a non-concrete type is a bad option and this</span><span>
</span><span id="line-330"></span><span class="hs-comment">-- abstraction is free anyway, hence its existence.</span><span>
</span><span id="line-331"></span><span class="hs-comment">--</span><span>
</span><span id="line-332"></span><span class="hs-comment">-- The @a@ type variable goes first, because @makeBuiltinMeaning \@A@ is a common pattern.</span><span>
</span><span id="line-333"></span><span class="hs-keyword">class</span><span> </span><span id="MakeBuiltinMeaning"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#MakeBuiltinMeaning"><span class="hs-identifier hs-var">MakeBuiltinMeaning</span></a></span></span><span> </span><span id="local-6989586621680865574"><span class="annot"><a href="#local-6989586621680865574"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621680865573"><span class="annot"><a href="#local-6989586621680865573"><span class="hs-identifier hs-type">val</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-334"></span><span>    </span><span class="hs-comment">-- See Note [Automatic derivation of type schemes]</span><span>
</span><span id="line-335"></span><span>    </span><span class="hs-comment">-- | Construct the meaning for a built-in function by automatically deriving its</span><span>
</span><span id="line-336"></span><span>    </span><span class="hs-comment">-- 'TypeScheme', given</span><span>
</span><span id="line-337"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-338"></span><span>    </span><span class="hs-comment">-- 1. the denotation of the builtin</span><span>
</span><span id="line-339"></span><span>    </span><span class="hs-comment">-- 2. an uninstantiated costing function</span><span>
</span><span id="line-340"></span><span>    </span><span id="makeBuiltinMeaning"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#makeBuiltinMeaning"><span class="hs-identifier hs-type">makeBuiltinMeaning</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span id="local-6989586621680865575"><span class="annot"><a href="#local-6989586621680865574"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680865575"><span class="hs-identifier hs-type">cost</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#FoldArgs"><span class="hs-identifier hs-type">FoldArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#GetArgs"><span class="hs-identifier hs-type">GetArgs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865574"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Machine.ExBudget.html#ExBudget"><span class="hs-identifier hs-type">ExBudget</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#BuiltinMeaning"><span class="hs-identifier hs-type">BuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865573"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865575"><span class="hs-identifier hs-type">cost</span></a></span></span><span>
</span><span id="line-341"></span><span class="hs-keyword">instance</span><span>
</span><span id="line-342"></span><span>        </span><span id="local-6989586621680865566"><span id="local-6989586621680865567"><span id="local-6989586621680865568"><span id="local-6989586621680865569"><span id="local-6989586621680865570"><span id="local-6989586621680865571"><span class="hs-special">(</span><span> </span><span class="annot"><a href="#local-6989586621680865571"><span class="hs-identifier hs-type">binds</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownTypeAst.html#ToBinds"><span class="hs-identifier hs-type">ToBinds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865570"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680865569"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#GetArgs"><span class="hs-identifier hs-type">GetArgs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865570"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680865570"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#FoldArgs"><span class="hs-identifier hs-type">FoldArgs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865569"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865568"><span class="hs-identifier hs-type">res</span></a></span><span>
</span><span id="line-343"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ThrowOnBothEmpty"><span class="hs-identifier hs-type">ThrowOnBothEmpty</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865571"><span class="hs-identifier hs-type">binds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865569"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.KnownTypeAst.html#IsBuiltin"><span class="hs-identifier hs-type">IsBuiltin</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865570"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680865570"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-344"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Elaborate.html#ElaborateFromTo"><span class="hs-identifier hs-type">ElaborateFromTo</span></a></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span> </span><span class="annot"><a href="#local-6989586621680865567"><span class="hs-identifier hs-type">j</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865566"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865570"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#KnownPolytype"><span class="hs-identifier hs-type">KnownPolytype</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865571"><span class="hs-identifier hs-type">binds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865566"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865569"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865568"><span class="hs-identifier hs-type">res</span></a></span><span>
</span><span id="line-345"></span><span>        </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#MakeBuiltinMeaning"><span class="hs-identifier hs-type">MakeBuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865570"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865566"><span class="hs-identifier hs-type">val</span></a></span></span></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-346"></span><span>    </span><span id="local-6989586621680865373"><span class="annot"><span class="annottext">makeBuiltinMeaning :: forall cost.
a
-&gt; (cost -&gt; FoldArgs (GetArgs a) ExBudget)
-&gt; BuiltinMeaning val cost
</span><a href="#local-6989586621680865373"><span class="hs-identifier hs-var hs-var hs-var hs-var">makeBuiltinMeaning</span></a></span></span><span> </span><span id="local-6989586621680865372"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680865372"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621680865371"><span class="annot"><span class="annottext">cost -&gt; FoldArgs (GetArgs a) ExBudget
</span><a href="#local-6989586621680865371"><span class="hs-identifier hs-var">toExF</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-347"></span><span>        </span><span class="annot"><span class="annottext">forall val cost (args :: [*]) res.
TypeScheme val args res
-&gt; FoldArgs args res
-&gt; (cost -&gt; BuiltinRuntime val)
-&gt; BuiltinMeaning val cost
</span><a href="PlutusCore.Builtin.Meaning.html#BuiltinMeaning"><span class="hs-identifier hs-var">BuiltinMeaning</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (binds :: [Some TyNameRep]) val (args :: [*]) res.
KnownPolytype binds val args res =&gt;
TypeScheme val args res
</span><a href="PlutusCore.Builtin.Meaning.html#knownPolytype"><span class="hs-identifier hs-var">knownPolytype</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865571"><span class="hs-identifier hs-type">binds</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865566"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865569"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865568"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680865372"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680865370"><span class="annot"><span class="annottext">cost
</span><a href="#local-6989586621680865370"><span class="hs-identifier hs-var">cost</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-348"></span><span>            </span><span class="hs-comment">-- In order to make the 'BuiltinRuntime' of a builtin cacheable we need to tell GHC to</span><span>
</span><span id="line-349"></span><span>            </span><span class="hs-comment">-- create a thunk for it, which we achieve by applying 'lazy' to the 'BuiltinRuntime'</span><span>
</span><span id="line-350"></span><span>            </span><span class="hs-comment">-- here.</span><span>
</span><span id="line-351"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-352"></span><span>            </span><span class="hs-comment">-- Those thunks however require a lot of care to be properly shared rather than</span><span>
</span><span id="line-353"></span><span>            </span><span class="hs-comment">-- recreated every time a builtin application is evaluated, see 'toBuiltinsRuntime' for</span><span>
</span><span id="line-354"></span><span>            </span><span class="hs-comment">-- how we sort it out.</span><span>
</span><span id="line-355"></span><span>            </span><span class="annot"><span class="annottext">forall a. a -&gt; a
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">lazy</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">cost -&gt; FoldArgs (GetArgs a) ExBudget
</span><a href="#local-6989586621680865371"><span class="hs-identifier hs-var">toExF</span></a></span><span> </span><span class="annot"><span class="annottext">cost
</span><a href="#local-6989586621680865370"><span class="hs-identifier hs-var">cost</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-356"></span><span>                </span><span class="hs-comment">-- See Note [Optimizations of runCostingFun*] for why we use strict @case@.</span><span>
</span><span id="line-357"></span><span>                </span><span class="hs-glyph">!</span><span id="local-6989586621680865369"><span class="annot"><span class="annottext">FoldArgs (GetArgs a) ExBudget
</span><a href="#local-6989586621680865369"><span class="hs-identifier hs-var">exF</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (binds :: [Some TyNameRep]) val (args :: [*]) res.
KnownPolytype binds val args res =&gt;
ReadKnownM (FoldArgs args res, FoldArgs args ExBudget)
-&gt; BuiltinRuntime val
</span><a href="PlutusCore.Builtin.Meaning.html#toPolyF"><span class="hs-identifier hs-var">toPolyF</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865571"><span class="hs-identifier hs-type">binds</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865566"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865569"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680865568"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680865372"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FoldArgs (GetArgs a) ExBudget
</span><a href="#local-6989586621680865369"><span class="hs-identifier hs-var">exF</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#makeBuiltinMeaning"><span class="hs-pragma hs-type">makeBuiltinMeaning</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span class="hs-comment">-- | Convert a 'BuiltinMeaning' to a 'BuiltinRuntime' given a cost model.</span><span>
</span><span id="line-361"></span><span id="local-6989586621680865559"><span id="local-6989586621680865560"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#toBuiltinRuntime"><span class="hs-identifier hs-type">toBuiltinRuntime</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680865560"><span class="hs-identifier hs-type">cost</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#BuiltinMeaning"><span class="hs-identifier hs-type">BuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865559"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865560"><span class="hs-identifier hs-type">cost</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Runtime.html#BuiltinRuntime"><span class="hs-identifier hs-type">BuiltinRuntime</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865559"><span class="hs-identifier hs-type">val</span></a></span></span></span><span>
</span><span id="line-362"></span><span id="toBuiltinRuntime"><span class="annot"><span class="annottext">toBuiltinRuntime :: forall cost val.
cost -&gt; BuiltinMeaning val cost -&gt; BuiltinRuntime val
</span><a href="PlutusCore.Builtin.Meaning.html#toBuiltinRuntime"><span class="hs-identifier hs-var hs-var">toBuiltinRuntime</span></a></span></span><span> </span><span id="local-6989586621680865367"><span class="annot"><span class="annottext">cost
</span><a href="#local-6989586621680865367"><span class="hs-identifier hs-var">cost</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#BuiltinMeaning"><span class="hs-identifier hs-type">BuiltinMeaning</span></a></span><span> </span><span class="annot"><span class="annottext">TypeScheme val args res
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">FoldArgs args res
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680865366"><span class="annot"><span class="annottext">cost -&gt; BuiltinRuntime val
</span><a href="#local-6989586621680865366"><span class="hs-identifier hs-var">denot</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">cost -&gt; BuiltinRuntime val
</span><a href="#local-6989586621680865366"><span class="hs-identifier hs-var">denot</span></a></span><span> </span><span class="annot"><span class="annottext">cost
</span><a href="#local-6989586621680865367"><span class="hs-identifier hs-var">cost</span></a></span><span>
</span><span id="line-363"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#toBuiltinRuntime"><span class="hs-pragma hs-type">toBuiltinRuntime</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-364"></span><span>
</span><span id="line-365"></span><span class="hs-comment">-- See Note [Inlining meanings of builtins].</span><span>
</span><span id="line-366"></span><span class="hs-comment">-- | Calculate runtime info for all built-in functions given denotations of builtins,</span><span>
</span><span id="line-367"></span><span class="hs-comment">-- and a cost model.</span><span>
</span><span id="line-368"></span><span id="local-6989586621680865551"><span id="local-6989586621680865552"><span id="local-6989586621680865553"><span id="local-6989586621680865554"><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#toBuiltinsRuntime"><span class="hs-identifier hs-type">toBuiltinsRuntime</span></a></span><span>
</span><span id="line-369"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680865554"><span class="hs-identifier hs-type">cost</span></a></span><span> </span><span class="annot"><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#CostingPart"><span class="hs-identifier hs-type">CostingPart</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865553"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865552"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#ToBuiltinMeaning"><span class="hs-identifier hs-type">ToBuiltinMeaning</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865553"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865552"><span class="hs-identifier hs-type">fun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#HasMeaningIn"><span class="hs-identifier hs-type">HasMeaningIn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865553"><span class="hs-identifier hs-type">uni</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865551"><span class="hs-identifier hs-type">val</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-370"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#BuiltinVersion"><span class="hs-identifier hs-type">BuiltinVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865552"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680865554"><span class="hs-identifier hs-type">cost</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Runtime.html#BuiltinsRuntime"><span class="hs-identifier hs-type">BuiltinsRuntime</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865552"><span class="hs-identifier hs-type">fun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680865551"><span class="hs-identifier hs-type">val</span></a></span></span></span></span></span><span>
</span><span id="line-371"></span><span id="toBuiltinsRuntime"><span class="annot"><span class="annottext">toBuiltinsRuntime :: forall cost (uni :: * -&gt; *) fun val.
(cost ~ CostingPart uni fun, ToBuiltinMeaning uni fun,
 HasMeaningIn uni val) =&gt;
BuiltinVersion fun -&gt; cost -&gt; BuiltinsRuntime fun val
</span><a href="PlutusCore.Builtin.Meaning.html#toBuiltinsRuntime"><span class="hs-identifier hs-var hs-var">toBuiltinsRuntime</span></a></span></span><span> </span><span id="local-6989586621680865342"><span class="annot"><span class="annottext">BuiltinVersion fun
</span><a href="#local-6989586621680865342"><span class="hs-identifier hs-var">ver</span></a></span></span><span> </span><span id="local-6989586621680865341"><span class="annot"><span class="annottext">cost
</span><a href="#local-6989586621680865341"><span class="hs-identifier hs-var">cost</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-372"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680865340"><span class="annot"><span class="annottext">runtime :: BuiltinsRuntime fun val
</span><a href="#local-6989586621680865340"><span class="hs-identifier hs-var hs-var">runtime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall fun val.
(fun -&gt; BuiltinRuntime val) -&gt; BuiltinsRuntime fun val
</span><a href="PlutusCore.Builtin.Runtime.html#BuiltinsRuntime"><span class="hs-identifier hs-var">BuiltinsRuntime</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall cost val.
cost -&gt; BuiltinMeaning val cost -&gt; BuiltinRuntime val
</span><a href="PlutusCore.Builtin.Meaning.html#toBuiltinRuntime"><span class="hs-identifier hs-var">toBuiltinRuntime</span></a></span><span> </span><span class="annot"><span class="annottext">cost
</span><a href="#local-6989586621680865341"><span class="hs-identifier hs-var">cost</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../ghc/html/libraries/base-4.16.4.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
</span><a href="../../../../ghc/html/libraries/ghc-prim-0.8.0/src"><span class="hs-identifier hs-var">inline</span></a></span><span> </span><span class="annot"><span class="annottext">forall (uni :: * -&gt; *) fun val.
(ToBuiltinMeaning uni fun, HasMeaningIn uni val) =&gt;
BuiltinVersion fun
-&gt; fun -&gt; BuiltinMeaning val (CostingPart uni fun)
</span><a href="PlutusCore.Builtin.Meaning.html#toBuiltinMeaning"><span class="hs-identifier hs-var">toBuiltinMeaning</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinVersion fun
</span><a href="#local-6989586621680865342"><span class="hs-identifier hs-var">ver</span></a></span><span>
</span><span id="line-373"></span><span>        </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621680865340"><span class="hs-pragma hs-type">runtime</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-374"></span><span>       </span><span class="hs-comment">-- Force each 'BuiltinRuntime' to WHNF. Inlining 'force' manually, since it doesn't have an</span><span>
</span><span id="line-375"></span><span>       </span><span class="hs-comment">-- @INLINE@ pragma. This allows GHC to get to the 'NFData' instance for 'BuiltinsRuntime',</span><span>
</span><span id="line-376"></span><span>       </span><span class="hs-comment">-- which forces all the freshly created 'BuiltinRuntime' thunks. Which is important, because</span><span>
</span><span id="line-377"></span><span>       </span><span class="hs-comment">-- the thunks are behind a lambda binding the @cost@ variable and GHC would supply the @cost@</span><span>
</span><span id="line-378"></span><span>       </span><span class="hs-comment">-- value (the one that is in the current scope) at runtime, if we didn't tell it that the</span><span>
</span><span id="line-379"></span><span>       </span><span class="hs-comment">-- thunks need to be forced early. Which would be detrimental to performance, since it would</span><span>
</span><span id="line-380"></span><span>       </span><span class="hs-comment">-- mean that the thunks would be created at runtime over and over again, each time we go</span><span>
</span><span id="line-381"></span><span>       </span><span class="hs-comment">-- under the lambda binding the @cost@ variable, i.e. each time the 'BuiltinRuntime' is</span><span>
</span><span id="line-382"></span><span>       </span><span class="hs-comment">-- retrieved from the environment. The 'deepseq' nagging causes GHC to supply the @cost@</span><span>
</span><span id="line-383"></span><span>       </span><span class="hs-comment">-- value at compile time, thus allocating the thunks within this entire function allowing</span><span>
</span><span id="line-384"></span><span>       </span><span class="hs-comment">-- them to be reused each time the 'BuiltinRuntime' is looked up (after the initial phase</span><span>
</span><span id="line-385"></span><span>       </span><span class="hs-comment">-- forcing all of them at once).</span><span>
</span><span id="line-386"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-387"></span><span>       </span><span class="hs-comment">-- Note that despite @runtime@ being used twice, we don't get all the multiple thousands of</span><span>
</span><span id="line-388"></span><span>       </span><span class="hs-comment">-- Core duplicated, because the 'BuiltinRuntime' thunks are shared in the two @runtime@s.</span><span>
</span><span id="line-389"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">BuiltinsRuntime fun val
</span><a href="#local-6989586621680865340"><span class="hs-identifier hs-var">runtime</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. NFData a =&gt; a -&gt; b -&gt; b
</span><a href="../../../../ghc/html/libraries/deepseq-1.4.6.1/src"><span class="hs-operator hs-var">`deepseq`</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinsRuntime fun val
</span><a href="#local-6989586621680865340"><span class="hs-identifier hs-var">runtime</span></a></span><span>
</span><span id="line-390"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Meaning.html#toBuiltinsRuntime"><span class="hs-pragma hs-type">toBuiltinsRuntime</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-391"></span></pre></body></html>